<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <p>#Atomic Store</p> 
  <h2><a id="user-content-meta" class="anchor" href="https://github.com/artsy/atomic-store#meta" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Meta</h2> 
  <ul> 
   <li><strong>State:</strong> production</li> 
   <li><strong>Point People:</strong> <a href="https://github.com/acjay" target="_blank">@acjay</a></li> 
   <li><strong>Point People:</strong> <a href="https://github.com/bhoggard" target="_blank">@bhoggard</a></li> 
  </ul> 
  <p><a href="https://circleci.com/gh/artsy/atomic-store" target="_blank"><img src="https://camo.githubusercontent.com/bb045f37f86820203917b8507d5c5d31e0b45f3b/68747470733a2f2f636972636c6563692e636f6d2f67682f61727473792f61746f6d69632d73746f72652e7376673f7374796c653d737667" alt="CircleCI" data-canonical-src="https://circleci.com/gh/artsy/atomic-store.svg?style=svg" style="max-width:100%;"></a></p> 
  <p>Atomic Store is a system for managing persistent streams of atomic events, with strict consistency. It is intended for systems in which only one event can be admitted to a canonical event log at a time, contingent upon past events. It exists to maintain the atomicity of handling of incoming events, but outsources the actual validation logic back to the event originator. In a sense, the idea here is to do as little as possible to meet this goal, but in a way that is as practical as possible.</p> 
  <h2><a id="user-content-philosophy" class="anchor" href="https://github.com/artsy/atomic-store#philosophy" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Philosophy</h2> 
  <p>Atomic Store is built on top of <a href="http://doc.akka.io/docs/akka/snapshot/scala/persistence.html" target="_blank">Akka Persistence</a>, which is designed to natively support highly scalable distributed systems with relaxed consistency. A distributed system can <a href="https://www.lightbend.com/blog/microservices-101-exploiting-realitys-constraints-with-technology" target="_blank">maximize its scalability</a> by reducing coupling between its components, and synchronization of state changes is one such coupling. The general approach to relaxed consistency is to take compensatory actions to rectify inconsistencies between distributed components, in retrospect. But this is complex, and not desirable in all situations. Atomic Store is designed for situations where strict consistency is more desirable or appropriate than extreme scalability.</p> 
  <p>In the actor framework, individual actors are single-threaded and cannot be preempted mid-process. Consequently, consistency is guaranteed in the course of processing a message. This would be perfect for atomic validation+persistence, except for the fact that it's desirable to have validation potentially be asynchronous. Akka, out of the box, does not provide an answer for this. It's pretty easy to achieve this behavior with an actor stashes incoming messages while it is awaiting validation of the current one, and that's exactly what this project accomplishes.</p> 
  <h2><a id="user-content-running" class="anchor" href="https://github.com/artsy/atomic-store#running" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Running</h2> 
  <p>At the moment, the only thing you can do is execute the tests, by running <code>test</code> from the SBT prompt.</p> 
  <h2><a id="user-content-integrating-into-a-project" class="anchor" href="https://github.com/artsy/atomic-store#integrating-into-a-project" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Integrating into a project</h2> 
  <p>Include the following line in your <code>build.sbt</code>:</p> 
  <div class="highlight highlight-source-scala">
   <pre>libraryDependencies <span class="pl-k">++</span><span class="pl-k">=</span> <span class="pl-en">Seq</span>(
  <span class="pl-s"><span class="pl-pds">"</span>net.artsy<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>atomic-store<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>0.0.6<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>Then, in your project, you will want to instantiate an atomic store matching your event types:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">object</span> <span class="pl-en">MyEventStore</span> <span class="pl-k">extends</span> <span class="pl-e">AtomicEventStore</span>[<span class="pl-en">MyEventType</span>, <span class="pl-en">MyRejectionReasonType</span>](myTimeoutReason)   </pre>
  </div> 
  <p>In your start up code, you'll start the Receptionist actor, which serves as the store's entry point:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">case</span> <span class="pl-k">class</span> <span class="pl-en">MyEventStore</span>(
  <span class="pl-v">storeTimeout</span>:     <span class="pl-en">FiniteDuration</span>,
  <span class="pl-v">journalPluginId</span>:  <span class="pl-k">String</span>,
  <span class="pl-v">snapshotPluginId</span>: <span class="pl-k">String</span>
)(
  <span class="pl-k">implicit</span>
  <span class="pl-v">system</span>:  <span class="pl-en">ActorSystem</span>,
  <span class="pl-v">ec</span>:      <span class="pl-en">ExecutionContextExecutor</span>
) {
  <span class="pl-k">import</span> <span class="pl-v">MyEventStore.</span><span class="pl-v">_</span>
  
  <span class="pl-k">val</span> <span class="pl-en">receptionist</span> <span class="pl-k">=</span> system.actorOf(receptionistProps(storeTimeout, journalPluginId, snapshotPluginId))
}</pre>
  </div> 
  <p>At this point, you'll be able to persist events and check the store by sending messages to the receptionist.</p> 
  <p>To work within a cluster, it's important that only one instance of each event log be alive within the cluster. This can be accomplished by instantiating the receptionist as a cluster singleton. This might look like:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">case</span> <span class="pl-k">class</span> <span class="pl-en">MyEventStore</span>(
  <span class="pl-v">storeTimeout</span>:     <span class="pl-en">FiniteDuration</span>,
  <span class="pl-v">journalPluginId</span>:  <span class="pl-k">String</span>,
  <span class="pl-v">snapshotPluginId</span>: <span class="pl-k">String</span>
)(
  <span class="pl-k">implicit</span>
  <span class="pl-v">system</span>:  <span class="pl-en">ActorSystem</span>,
  <span class="pl-v">ec</span>:      <span class="pl-en">ExecutionContextExecutor</span>,
  <span class="pl-v">timeout</span>: <span class="pl-en">Timeout</span>
) {
  <span class="pl-k">import</span> <span class="pl-v">MyEventStore.</span><span class="pl-v">_</span>

  <span class="pl-k">val</span> <span class="pl-en">singletonProps</span> <span class="pl-k">=</span> <span class="pl-en">ClusterSingletonManager</span>.props(
    singletonProps     <span class="pl-k">=</span> receptionistProps(storeTimeout, journalPluginId, snapshotPluginId),
    terminationMessage <span class="pl-k">=</span> <span class="pl-en">PoisonPill</span>,
    settings           <span class="pl-k">=</span> <span class="pl-en">ClusterSingletonManagerSettings</span>(system)
  )
  <span class="pl-k">val</span> <span class="pl-en">manager</span> <span class="pl-k">=</span> system.actorOf(singletonProps, <span class="pl-s"><span class="pl-pds">"</span>receptionist<span class="pl-pds">"</span></span>)
  
  <span class="pl-k">val</span> <span class="pl-en">path</span> <span class="pl-k">=</span> manager.path.toStringWithoutAddress
  <span class="pl-k">val</span> <span class="pl-en">proxyProps</span> <span class="pl-k">=</span> <span class="pl-en">ClusterSingletonProxy</span>.props(
    singletonManagerPath <span class="pl-k">=</span> path,
    settings             <span class="pl-k">=</span> <span class="pl-en">ClusterSingletonProxySettings</span>(system)
  )
  <span class="pl-k">val</span> <span class="pl-en">receptionist</span> <span class="pl-k">=</span> system.actorOf(proxyProps)
}</pre>
  </div> 
  <p>In a project, it's likely you will want some sort of server-push mechanism to notify clients of new events. Rather than containing this logic. This code can likely be located within the handler of the result.</p> 
  <p>You will likely also want to use Protobuf and a custom serializer for high-performance serialization of messages to and from Atomic Store. A sample <code>.proto</code> file:</p> 
  <div class="highlight highlight-source-scala">
   <pre>syntax <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>proto2<span class="pl-pds">"</span></span>;

<span class="pl-k">package</span> <span class="pl-en">net.artsy.auction.protobuf</span>;

<span class="pl-c"><span class="pl-c">//</span> Lot Event Store messages</span>

message <span class="pl-en">AtomicStoreMessageProto</span> {
    oneof type {
        <span class="pl-en">QueryEventsProto</span> query_event <span class="pl-k">=</span> <span class="pl-c1">1</span>;
        <span class="pl-en">StoreIfValidProto</span> store_if_valid <span class="pl-k">=</span> <span class="pl-c1">2</span>;
        <span class="pl-en">ValidationRequestProto</span> validation_request <span class="pl-k">=</span> <span class="pl-c1">3</span>;
        <span class="pl-en">ValidationResponseProto</span> validation_response <span class="pl-k">=</span> <span class="pl-c1">4</span>;
        <span class="pl-en">ResultProto</span> result <span class="pl-k">=</span> <span class="pl-c1">5</span>;
    }
}

message <span class="pl-en">QueryEventsProto</span> {
    optional string scope_id <span class="pl-k">=</span> <span class="pl-c1">6</span>;
}

message <span class="pl-en">StoreIfValidProto</span> {
    optional bytes event <span class="pl-k">=</span> <span class="pl-c1">7</span>;
}

message <span class="pl-en">ValidationRequestProto</span> {
    optional bytes prospective_event <span class="pl-k">=</span> <span class="pl-c1">8</span>;
    repeated bytes past_events <span class="pl-k">=</span> <span class="pl-c1">9</span>;
}

message <span class="pl-en">ValidationResponseProto</span> {
    optional bool validation_did_pass <span class="pl-k">=</span> <span class="pl-c1">10</span>;
    optional bytes event <span class="pl-k">=</span> <span class="pl-c1">11</span>;
    optional string reason <span class="pl-k">=</span> <span class="pl-c1">12</span>;
    optional <span class="pl-en">MetaProto</span> meta <span class="pl-k">=</span> <span class="pl-c1">13</span>;
}

message <span class="pl-en">ResultProto</span> {
    optional bool was_accepted <span class="pl-k">=</span> <span class="pl-c1">14</span>;
    optional bytes prospective_event <span class="pl-k">=</span> <span class="pl-c1">15</span>;
    repeated bytes stored_event_list <span class="pl-k">=</span> <span class="pl-c1">16</span>;
    optional string reason <span class="pl-k">=</span> <span class="pl-c1">17</span>;
    optional <span class="pl-en">MetaProto</span> meta <span class="pl-k">=</span> <span class="pl-c1">18</span>;
}

message <span class="pl-en">MetaProto</span> {
    <span class="pl-c"><span class="pl-c">//</span> Domain-specific fields</span>
}</pre>
  </div> 
  <p>In your <a href="http://doc.akka.io/docs/akka/current/scala/serialization.html" target="_blank">Akka Serializer</a> implementation, you'll then want to serialize your events themselves to a byte array, perhaps deferring to a separate serializer.</p> 
  <h2><a id="user-content-technology" class="anchor" href="https://github.com/artsy/atomic-store#technology" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Technology</h2> 
  <p>Atomic Store is built using Scala, the Akka framework, and associated libraries. Specifically, here are the core technologies being used, with links to documentation:</p> 
  <ul> 
   <li>Scala (see <a href="http://docs.scala-lang.org/tutorials/" target="_blank">tutorials</a>)</li> 
   <li><a href="http://doc.akka.io/docs/akka/current/scala.html" target="_blank">Akka</a> 
    <ul> 
     <li><a href="http://doc.akka.io/docs/akka/current/scala/actors.html" target="_blank">Actor basics</a></li> 
     <li><a href="http://doc.akka.io/docs/akka/current/scala/persistence.html" target="_blank">Persistence</a></li> 
    </ul> </li> 
  </ul> 
  <h2><a id="user-content-releasing-new-versions" class="anchor" href="https://github.com/artsy/atomic-store#releasing-new-versions" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Releasing new versions</h2> 
  <p>For testing changes:</p> 
  <ol> 
   <li>Bump the version in <code>build.sbt</code> as appropriate, and add <code>-SNAPSHOT</code> to the end of the version number.</li> 
   <li>Update the <code>libraryDependencies</code> line above in anticipation of the next version.</li> 
   <li>Use the <code>sbt publish-signed</code> task to push snapshots to Maven Central.</li> 
   <li>Update the <em>Changelog</em> as noteworthy changes are made.</li> 
   <li>During the testing period, merge new changes into the <code>development</code> branch, so that the <code>master</code> branch on Github always reflects the latest version on Maven Central.</li> 
  </ol> 
  <p>For releasing new versions:</p> 
  <ol> 
   <li>Remove the <code>-SNAPSHOT</code> suffix in <code>build.sbt</code>.</li> 
   <li>Publish to Maven Central staging using <code>sbt publish-signed</code>.</li> 
   <li>Follow <a href="http://central.sonatype.org/pages/releasing-the-deployment.html" target="_blank">the Maven Central workflow</a> for releasing the next version, logging in to Maven Central Nexus with an account set up with the privilege to publish to <a href="https://issues.sonatype.org/browse/OSSRH-20964" target="_blank">the Open Source Project Repository Atomic Store entry</a>.</li> 
   <li>Merge <code>development</code> into <code>master</code> to update the canonical version on Github.</li> 
  </ol> 
  <p>For reference on this process, you may want to see the following links:</p> 
  <ul> 
   <li><a href="http://www.scala-sbt.org/0.13/docs/Using-Sonatype.html" target="_blank">SBT: Deploying to Sonatype</a></li> 
   <li><a href="http://www.scala-sbt.org/sbt-pgp/usage.html" target="_blank">SBT-PGP Usage docs</a></li> 
   <li><a href="http://central.sonatype.org/pages/releasing-the-deployment.html" target="_blank">The Central Repository: Releasing The Deployment</a></li> 
   <li><a href="http://www.debonair.io/post/maven-cd/" target="_blank">Complete guide to continuous deployment to maven central from Travis CI</a></li> 
  </ul> 
  <h2><a id="user-content-todos" class="anchor" href="https://github.com/artsy/atomic-store#todos" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Todos</h2> 
  <ul> 
   <li>Testing of complicated random flows of events, validations, and timeouts.</li> 
  </ul> 
  <h2><a id="user-content-changelog" class="anchor" href="https://github.com/artsy/atomic-store#changelog" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Changelog</h2> 
  <p><em>0.0.7</em></p> 
  <ul> 
   <li>Bump Akka version to 2.5.4.</li> 
   <li>Cross publish for Scala 2.11 and 2.12.</li> 
   <li>Clean up build file.</li> 
  </ul> 
  <p><em>0.0.6</em></p> 
  <ul> 
   <li>Bump Akka version to 2.5.1</li> 
   <li>Add <a href="https://circleci.com/gh/artsy/atomic-store" target="_blank">CircleCI</a> with automated push to Sonatype/Maven Central</li> 
  </ul> 
  <p><em>0.0.5</em></p> 
  <ul> 
   <li>Add <code>meta</code> field to validation process to allow validation code to pass back arbitrary additional information.</li> 
   <li>Bump Akka version to 2.4.8</li> 
  </ul> 
  <p><em>0.0.4</em></p> 
  <ul> 
   <li>Remove clustering code (client code may manage Receptionist as a Cluster Singleton if needed)</li> 
   <li>Convert nested singleton messages to case classes, for proper deserialization.</li> 
  </ul> 
  <p><em>0.0.3</em></p> 
  <ul> 
   <li>Factor out transient state data from what is persisted. It is unlikely to be of any use upon recovery, anyway. <em>Important:</em> this <em>will</em> break compatibility with any existing data that's stored.</li> 
   <li>Set up Akka Cluster Singleton for EventLog actors</li> 
  </ul> 
  <p><em>0.0.2</em></p> 
  <ul> 
   <li>Remove <code>Timestamped</code>. It's not crucial to the logic of this library, so let the client own all of the metadata it wants to associate with its events.</li> 
   <li>Allow Akka Persistence plugin to be selected at run-time.</li> 
   <li>Upgrade to Scala compiler 2.11.8.</li> 
  </ul> 
  <p><em>0.0.1</em></p> 
  <ul> 
   <li>Initial release.</li> 
  </ul> 
 </article>
</div>