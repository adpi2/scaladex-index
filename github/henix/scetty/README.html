<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-scetty-scala-async-http-client-based-on-jetty-client" class="anchor" href="https://github.com/henix/scetty#scetty-scala-async-http-client-based-on-jetty-client" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Scetty: Scala async http client based on jetty-client</h1> 
  <h2><a id="user-content-install" class="anchor" href="https://github.com/henix/scetty#install" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Install</h2> 
  <pre><code>"info.henix" % "scetty" % "0.2.5"
</code></pre> 
  <p>DO NOT USE: v0.2.2</p> 
  <h2><a id="user-content-examples" class="anchor" href="https://github.com/henix/scetty#examples" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Examples</h2> 
  <h3><a id="user-content-imports" class="anchor" href="https://github.com/henix/scetty#imports" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>imports</h3> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">henix.scetty.Scetty.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">henix.scetty.</span>{<span class="pl-v">FormBody</span>, <span class="pl-v">Url</span>}</pre>
  </div> 
  <h3><a id="user-content-create-a-scettyclient" class="anchor" href="https://github.com/henix/scetty#create-a-scettyclient" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Create a ScettyClient</h3> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">scala.concurrent.duration.</span><span class="pl-v">_</span>

<span class="pl-k">val</span> <span class="pl-en">jettyClient</span> <span class="pl-k">=</span> ... <span class="pl-c">// Create your jetty client object here.</span>

<span class="pl-k">val</span> <span class="pl-en">scettyClient</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">ScettyClient</span>(jettyClient, <span class="pl-c1">15.</span>seconds) <span class="pl-c">// This object can be safely shared between multiple threads.</span>

<span class="pl-c">// Don't forget to call jettyClient.stop() when your app exits.</span></pre>
  </div> 
  <h3><a id="user-content-simple-get" class="anchor" href="https://github.com/henix/scetty#simple-get" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Simple GET</h3> 
  <div class="highlight highlight-source-scala">
   <pre>scettyClient.send(<span class="pl-en">Get</span>(<span class="pl-s"><span class="pl-pds">"</span>http://www.example.com/<span class="pl-pds">"</span></span>))</pre>
  </div> 
  <h3><a id="user-content-get-with-url-parameters" class="anchor" href="https://github.com/henix/scetty#get-with-url-parameters" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>GET with URL parameters</h3> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">url</span> <span class="pl-k">=</span> <span class="pl-en">Url</span>(<span class="pl-s"><span class="pl-pds">"</span>http://www.example.com/<span class="pl-pds">"</span></span>, <span class="pl-en">List</span>(<span class="pl-s"><span class="pl-pds">"</span>q<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>)) <span class="pl-c">// http://www.example.com/?q=1</span>

scettyClient.send(<span class="pl-en">Get</span>(url))</pre>
  </div> 
  <p><code>Url</code> will encode url query parameters <a href="http://blog.lunatech.com/2009/02/03/what-every-web-developer-must-know-about-url-encoding" target="_blank">in the right way</a>.</p> 
  <h3><a id="user-content-get-with-headers" class="anchor" href="https://github.com/henix/scetty#get-with-headers" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>GET with headers</h3> 
  <div class="highlight highlight-source-scala">
   <pre>scettyClient.send(<span class="pl-en">Get</span>(
  <span class="pl-s"><span class="pl-pds">"</span>http://www.example.com/<span class="pl-pds">"</span></span>,
  headers <span class="pl-k">=</span> <span class="pl-en">List</span>(<span class="pl-s"><span class="pl-pds">"</span>X-Requested-With<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>XMLHttpRequest<span class="pl-pds">"</span></span>)
))</pre>
  </div> 
  <h3><a id="user-content-post-with-form" class="anchor" href="https://github.com/henix/scetty#post-with-form" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>POST with form</h3> 
  <p>And encoded in charset other than UTF-8</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">req</span> <span class="pl-k">=</span> <span class="pl-en">Post</span>(
  <span class="pl-s"><span class="pl-pds">"</span>http://www.example.com/<span class="pl-pds">"</span></span>,
  headers <span class="pl-k">=</span> <span class="pl-en">List</span>(<span class="pl-s"><span class="pl-pds">"</span>Referer<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>https://github.com/<span class="pl-pds">"</span></span>),
  body <span class="pl-k">=</span> <span class="pl-en">FormBody</span>(
    params <span class="pl-k">=</span> <span class="pl-en">List</span>(
      <span class="pl-s"><span class="pl-pds">"</span>q<span class="pl-pds">"</span></span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-s"><span class="pl-pds">"</span>1<span class="pl-pds">"</span></span>
    ),
    charset <span class="pl-k">=</span> <span class="pl-en">Charset</span>.forName(<span class="pl-s"><span class="pl-pds">"</span>GBK<span class="pl-pds">"</span></span>)
  )
)

scettyclient.send(req)</pre>
  </div> 
  <h3><a id="user-content-read-response-as-a-string" class="anchor" href="https://github.com/henix/scetty#read-response-as-a-string" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Read response as a String</h3> 
  <p><code>send</code> will return a <code>Future[ContentResponse]</code>. See jetty-client's document for what can you do with <a href="http://download.eclipse.org/jetty/stable-9/apidocs/org/eclipse/jetty/client/api/ContentResponse.html" target="_blank">ContentResponse</a>.</p> 
  <p>If you want to get a <code>Future[String]</code>:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">def</span> <span class="pl-en">mustOk</span>(<span class="pl-v">resp</span>: <span class="pl-en">ContentResponse</span>)<span class="pl-k">:</span> <span class="pl-en">ContentResponse</span> <span class="pl-k">=</span> {
  <span class="pl-k">val</span> <span class="pl-en">status</span> <span class="pl-k">=</span> resp.getStatus
  <span class="pl-k">if</span> (status <span class="pl-k">==</span> <span class="pl-c1">200</span>)
    resp
  <span class="pl-k">else</span>
    <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">UpstreamHttpException</span>(resp.getRequest.getURI.toString, status, resp.getHeaders.iterator().asScala.map(f <span class="pl-k">=&gt;</span> f.getName <span class="pl-k">-</span><span class="pl-k">&gt;</span> f.getValue).toList)
}

<span class="pl-k">def</span> <span class="pl-en">sendAsString</span>(<span class="pl-v">req</span>: <span class="pl-en">HttpReq</span>, <span class="pl-v">followRedirects</span>: <span class="pl-en">Option</span>[<span class="pl-k">Boolean</span>] <span class="pl-k">=</span> <span class="pl-c1">None</span>)<span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-k">String</span>] <span class="pl-k">=</span> send(req, followRedirects).map(mustOk).map(_.getContentAsString)</pre>
  </div> 
  <h3><a id="user-content-cache-all-get-requests" class="anchor" href="https://github.com/henix/scetty#cache-all-get-requests" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Cache all GET requests</h3> 
  <p>Scetty doesn't have caching functionality because I think it's better to keep it focus on only one task.</p> 
  <p>You can write a simple wrapper if you want to cache. An example using Guava's <code>CacheBuilder</code>:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">com.google.common.cache.</span><span class="pl-v">CacheBuilder</span>
<span class="pl-k">import</span> <span class="pl-v">henix.scetty.</span><span class="pl-v">HttpReq</span>

<span class="pl-k">val</span> <span class="pl-en">cache</span> <span class="pl-k">=</span> <span class="pl-en">CacheBuilder</span>.newBuilder().expireAfterWrite(<span class="pl-c1">10</span>, <span class="pl-en">TimeUnit</span>.<span class="pl-en">MINUTES</span>).build[<span class="pl-en">HttpReq</span>, <span class="pl-en">ContentResponse</span>]()

<span class="pl-k">def</span> <span class="pl-en">send</span>(<span class="pl-v">req</span>: <span class="pl-en">HttpReq</span>, <span class="pl-v">followRedirects</span>: <span class="pl-en">Option</span>[<span class="pl-k">Boolean</span>] <span class="pl-k">=</span> <span class="pl-c1">None</span>)<span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-en">ContentResponse</span>] <span class="pl-k">=</span> {
  <span class="pl-k">val</span> <span class="pl-en">cached</span> <span class="pl-k">=</span> cache.getIfPresent(req)
  <span class="pl-k">if</span> (cached ne <span class="pl-c1">null</span>) {
    logger.info(<span class="pl-s"><span class="pl-pds">"</span>cache.hit: {}<span class="pl-pds">"</span></span>, req.url)
    <span class="pl-en">Future</span>.successful(cached)
  } <span class="pl-k">else</span> {
    <span class="pl-k">val</span> <span class="pl-en">f</span> <span class="pl-k">=</span> scettyClient.send(req, followRedirects)
    <span class="pl-k">if</span> (req.method <span class="pl-k">==</span> <span class="pl-en">HttpMethod</span>.<span class="pl-en">GET</span>) {
      f.onSuccess { <span class="pl-k">case</span> r <span class="pl-k">=&gt;</span> cache.put(req, r) }
    }
    f
  }
}</pre>
  </div> 
  <p><code>HttpReq</code> is a case class, it can be used as a Map's key.</p> 
  <h2><a id="user-content-features" class="anchor" href="https://github.com/henix/scetty#features" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Features</h2> 
  <ul> 
   <li>Allow charset other than UTF-8 to be used in url / post form</li> 
   <li>Async support with <code>scala.concurrent.Future</code></li> 
   <li>Represent HTTP request as a case class <code>HttpReq</code></li> 
  </ul> 
  <h2><a id="user-content-links" class="anchor" href="https://github.com/henix/scetty#links" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Links</h2> 
  <ul> 
   <li><a href="http://www.douban.com/note/446442212/" target="_blank">Java / Scala http client 库的选择</a></li> 
  </ul> 
 </article>
</div>