<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-scala-async----" class="anchor" href="https://github.com/scala/async#scala-async----" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>scala-async <a href="https://travis-ci.org/scala/async" target="_blank"><img src="https://camo.githubusercontent.com/cab57fcf6e9ea3628c65c80a9282d842311303b9/68747470733a2f2f696d672e736869656c64732e696f2f7472617669732f7363616c612f6173796e632e737667" data-canonical-src="https://img.shields.io/travis/scala/async.svg" style="max-width:100%;"></a> <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3Aorg.scala-lang.modules%20a%3Ascala-async_2.10" target="_blank"><img src="https://camo.githubusercontent.com/17f4d4464e57f2944aa28503c6fa6e5cacd73b09/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f6f72672e7363616c612d6c616e672e6d6f64756c65732f7363616c612d6173796e635f322e31302e7376673f6c6162656c3d6c617465737425323072656c65617365253230666f72253230322e3130" data-canonical-src="https://img.shields.io/maven-central/v/org.scala-lang.modules/scala-async_2.10.svg?label=latest%20release%20for%202.10" style="max-width:100%;"></a> <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3Aorg.scala-lang.modules%20a%3Ascala-async_2.11" target="_blank"><img src="https://camo.githubusercontent.com/17b178b30c1dd32b6a75466b09ab7447bfac7a9d/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f6f72672e7363616c612d6c616e672e6d6f64756c65732f7363616c612d6173796e635f322e31312e7376673f6c6162656c3d6c617465737425323072656c65617365253230666f72253230322e3131" data-canonical-src="https://img.shields.io/maven-central/v/org.scala-lang.modules/scala-async_2.11.svg?label=latest%20release%20for%202.11" style="max-width:100%;"></a> <a href="http://search.maven.org/#search%7Cga%7C1%7Cg%3Aorg.scala-lang.modules%20a%3Ascala-async_2.12" target="_blank"><img src="https://camo.githubusercontent.com/e555076b12d3301247c92793ef4621729547a93d/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f6f72672e7363616c612d6c616e672e6d6f64756c65732f7363616c612d6173796e635f322e31322e7376673f6c6162656c3d6c617465737425323072656c65617365253230666f72253230322e3132" data-canonical-src="https://img.shields.io/maven-central/v/org.scala-lang.modules/scala-async_2.12.svg?label=latest%20release%20for%202.12" style="max-width:100%;"></a></h1> 
  <p>Note: this branch targets Scala 2.11.x, support for Scala 2.10.x has been moved to <a href="https://github.com/scala/async/tree/2.10.x" target="_blank">this branch</a>.</p> 
  <h2><a id="user-content-quick-start" class="anchor" href="https://github.com/scala/async#quick-start" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Quick start</h2> 
  <p>To include scala-async in an existing project use the library published on Maven Central. For sbt projects add the following to your build definition - build.sbt or project/Build.scala:</p> 
  <div class="highlight highlight-source-scala">
   <pre>libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>org.scala-lang.modules<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>scala-async<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>0.9.6<span class="pl-pds">"</span></span></pre>
  </div> 
  <p>For Maven projects add the following to your (make sure to use the correct Scala version prefix, _2.10 or _2.11, to match your projectâ€™s Scala version):</p> 
  <div class="highlight highlight-source-scala">
   <pre>&lt;<span class="pl-ent">dependency</span>&gt;
	&lt;<span class="pl-ent">groupId</span>&gt;org.scala<span class="pl-k">-</span>lang.modules&lt;/<span class="pl-ent">groupId</span>&gt;
	&lt;<span class="pl-ent">artifactId</span>&gt;scala<span class="pl-k">-</span>async_2<span class="pl-c1">.11</span>&lt;/<span class="pl-ent">artifactId</span>&gt;
	&lt;<span class="pl-ent">version</span>&gt;<span class="pl-c1">0.9.6</span>&lt;/<span class="pl-ent">version</span>&gt;
&lt;/<span class="pl-ent">dependency</span>&gt;</pre>
  </div> 
  <p>Scala 2.12 support is introduced in 0.9.6-RC5.</p> 
  <p>After adding a scala-async to your classpath, write your first <code>async</code> block:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">ExecutionContext.Implicits.</span><span class="pl-v">global</span>
<span class="pl-k">import</span> <span class="pl-v">scala.async.Async.</span>{<span class="pl-v">async</span>, <span class="pl-v">await</span>}

<span class="pl-k">val</span> <span class="pl-en">future</span> <span class="pl-k">=</span> async {
  <span class="pl-k">val</span> <span class="pl-en">f1</span> <span class="pl-k">=</span> async { ...; <span class="pl-c1">true</span> }
  <span class="pl-k">val</span> <span class="pl-en">f2</span> <span class="pl-k">=</span> async { ...; <span class="pl-c1">42</span> }
  <span class="pl-k">if</span> (await(f1)) await(f2) <span class="pl-k">else</span> <span class="pl-c1">0</span>
}</pre>
  </div> 
  <h2><a id="user-content-what-is-async" class="anchor" href="https://github.com/scala/async#what-is-async" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>What is <code>async</code>?</h2> 
  <p><code>async</code> marks a block of asynchronous code. Such a block usually contains one or more <code>await</code> calls, which marks a point at which the computation will be suspended until the awaited <code>Future</code> is complete.</p> 
  <p>By default, <code>async</code> blocks operate on <code>scala.concurrent.{Future, Promise}</code>. The system can be adapted to alternative implementations of the <code>Future</code> pattern.</p> 
  <p>Consider the following example:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">def</span> <span class="pl-en">slowCalcFuture</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> ...             <span class="pl-c"><span class="pl-c">//</span> 01</span>
<span class="pl-k">def</span> <span class="pl-en">combined</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> async {               <span class="pl-c"><span class="pl-c">//</span> 02</span>
  await(slowCalcFuture) <span class="pl-k">+</span> await(slowCalcFuture)   <span class="pl-c"><span class="pl-c">//</span> 03</span>
}
<span class="pl-k">val</span> <span class="pl-en">x</span><span class="pl-k">:</span> <span class="pl-k">Int</span> <span class="pl-k">=</span> <span class="pl-en">Await</span>.result(combined, <span class="pl-c1">10.</span>seconds)   <span class="pl-c"><span class="pl-c">//</span> 05</span></pre>
  </div> 
  <p>Lines 1 defines an asynchronous method: it returns a <code>Future</code>.</p> 
  <p>Line 2 begins an <code>async</code> block. During compilation, the contents of this block will be analyzed to identify the <code>await</code> calls, and transformed into non-blocking code.</p> 
  <p>Control flow will immediately pass to line 5, as the computation in the <code>async</code> block is not executed on the caller's thread.</p> 
  <p>Line 3 begins by triggering <code>slowCalcFuture</code>, and then suspending until it has been calculating. Only after it has finished, we trigger it again, and suspend again. Finally, we add the results and complete <code>combined</code>, which in turn will release line 5 (unless it had already timed out).</p> 
  <p>It is important to note that while line 1-4 is non-blocking, it is not parallel. If we wanted to parallelize the two computations, we could rearrange the code as follows.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">def</span> <span class="pl-en">combined</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> async {
  <span class="pl-k">val</span> <span class="pl-en">future1</span> <span class="pl-k">=</span> slowCalcFuture
  <span class="pl-k">val</span> <span class="pl-en">future2</span> <span class="pl-k">=</span> slowCalcFuture
  await(future1) <span class="pl-k">+</span> await(future2)
}</pre>
  </div> 
  <h2><a id="user-content-comparison-with-direct-use-of-future-api" class="anchor" href="https://github.com/scala/async#comparison-with-direct-use-of-future-api" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Comparison with direct use of <code>Future</code> API</h2> 
  <p>This computation could also be expressed by directly using the higher-order functions of Futures:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">def</span> <span class="pl-en">slowCalcFuture</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> ...
<span class="pl-k">val</span> <span class="pl-en">future1</span> <span class="pl-k">=</span> slowCalcFuture
<span class="pl-k">val</span> <span class="pl-en">future2</span> <span class="pl-k">=</span> slowCalcFuture
<span class="pl-k">def</span> <span class="pl-en">combined</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> <span class="pl-k">for</span> {
  r1 <span class="pl-k">&lt;</span><span class="pl-k">-</span> future1
  r2 <span class="pl-k">&lt;</span><span class="pl-k">-</span> future2
} <span class="pl-k">yield</span> r1 <span class="pl-k">+</span> r2</pre>
  </div> 
  <p>The <code>async</code> approach has two advantages over the use of <code>map</code> and <code>flatMap</code>.</p> 
  <ol> 
   <li>The code more directly reflects the programmers intent, and does not require us to name the results <code>r1</code> and <code>r2</code>. This advantage is even more pronounced when we mix control structures in <code>async</code> blocks.</li> 
   <li><code>async</code> blocks are compiled to a single anonymous class, as opposed to a separate anonymous class for each closure required at each generator (<code>&lt;-</code>) in the for-comprehension. This reduces the size of generated code, and can avoid boxing of intermediate results.</li> 
  </ol> 
  <h2><a id="user-content-comparison-with-cps-plugin" class="anchor" href="https://github.com/scala/async#comparison-with-cps-plugin" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Comparison with CPS plugin</h2> 
  <p>The existing continuations (CPS) plugin for Scala can also be used to provide a syntactic layer like <code>async</code>. This approach has been used in Akka's <a href="http://doc.akka.io/docs/akka/2.3-M1/scala/dataflow.html" target="_blank">Dataflow Concurrency</a> (now deprecated in favour of this library).</p> 
  <p>CPS-based rewriting of asynchronous code also produces a closure for each suspension. It can also lead to type errors that are difficult to understand.</p> 
  <h2><a id="user-content-how-it-works" class="anchor" href="https://github.com/scala/async#how-it-works" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>How it works</h2> 
  <ul> 
   <li>The async macro analyses the block of code, looking for control structures and locations of await calls. It then breaks the code into 'chunks'. Each chunk contains a linear sequence of statements that concludes with a branching decision, or with the registration of a subsequent state handler as the continuation.</li> 
   <li>Before this analysis and transformation, the program is normalized into a form amenable to this manipulation. This is called the "A Normal Form" (ANF), and roughly means that: 
    <ul> 
     <li><code>if</code> and <code>match</code> constructs are only used as statements; they cannot be used as an expression.</li> 
     <li>calls to await are not allowed in compound expressions.</li> 
    </ul> </li> 
   <li>Identify vals, vars and defs that are accessed from multiple states. These will be lifted out to fields in the state machine object.</li> 
   <li>Synthesize a class that holds: 
    <ul> 
     <li>an integer representing the current state ID</li> 
     <li>the lifted definitions</li> 
     <li>an <code>apply(value: Try[Any]): Unit</code> method that will be called on completion of each future. The behavior of this method is determined by the current state. It records the downcast result of the future in a field, and calls the <code>resume()</code> method.</li> 
     <li>the <code>resume(): Unit</code> method that switches on the current state and runs the users code for one 'chunk', and either: a) registers the state machine as the handler for the next future b) completes the result Promise of the async block, if at the terminal state.</li> 
     <li>an <code>apply(): Unit</code> method that starts the computation.</li> 
    </ul> </li> 
  </ul> 
  <h2><a id="user-content-limitations" class="anchor" href="https://github.com/scala/async#limitations" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Limitations</h2> 
  <ul> 
   <li>See the <a href="https://github.com/scala/async/tree/master/src/test/scala/scala/async/neg" target="_blank">neg</a> test cases for constructs that are not allowed in a async block</li> 
   <li>See the <a href="https://github.com/scala/async/issues?state=open" target="_blank">issue list</a> for which of these restrictions are planned to be dropped in the future.</li> 
   <li>See <a href="https://github.com/scala/async/issues/13" target="_blank">#13</a> for why <code>await</code> is not possible in closures, and for suggestions on ways to structure the code to work around this limitation.</li> 
  </ul> 
 </article>
</div>