<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-cornucopia" class="anchor" href="https://github.com/adenda/cornucopia#cornucopia" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Cornucopia</h1> 
  <p>A microservice and library for auto-sharding Redis Cluster. Implemented on Akka Streams, with Salad wrapping the Java 8 Lettuce API for Redis.</p> 
  <p>This project is originally a fork from <a href="https://github.com/kliewkliew/cornucopia" target="_blank"><code>kliewkliew/cornucopia</code></a>.</p> 
  <h2><a id="user-content-operations" class="anchor" href="https://github.com/adenda/cornucopia#operations" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Operations</h2> 
  <p>The following keys for Kafka messages correspond to operations to be performed in Cornucopia.</p> 
  <h3><a id="user-content-add-or-remove-a-node" class="anchor" href="https://github.com/adenda/cornucopia#add-or-remove-a-node" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Add or Remove a Node</h3> 
  <ul> 
   <li><code>+master</code></li> 
   <li><code>+slave</code></li> 
   <li><code>-slave</code></li> 
  </ul> 
  <p>The value contained in the message is the URI (must be resolvable at the microservice) of the node to operate on. See <a href="https://github.com/mp911de/lettuce/wiki/Redis-URI-and-connection-details" target="_blank">Redis URI and connection details</a>.</p> 
  <h4><a id="user-content-using-cornucopia-as-a-microservice" class="anchor" href="https://github.com/adenda/cornucopia#using-cornucopia-as-a-microservice" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using Cornucopia as a microservice</h4> 
  <p>Cornucopia can be run as a stand-alone microservice. The interface to this microservice is a HTTP Rest interface.</p> 
  <p>For example, assuming that the micro service is running on http port 9001 on localhost (which is the default). To add a new master node to the cluster on localhost:7006, run the following command:</p> 
  <pre><code>curl -X POST \
  http://localhost:9001/task \
  -H 'content-type: application/json' \
  -d '{
	"operation": "+master",
	"redisNodeIp": "redis://localhost:7006"
}'
</code></pre> 
  <h4><a id="user-content-using-cornucopia-as-a-library-in-your-appliation" class="anchor" href="https://github.com/adenda/cornucopia#using-cornucopia-as-a-library-in-your-appliation" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using Cornucopia as a library in your appliation</h4> 
  <p>Include Cornucopia in your <code>build.sbt</code> file: <code>"com.adendamedia" %% "cornucopia" % "0.5.0"</code>. Control messages are sent to Cornucopia using an ActorRef that must be imported.</p> 
  <pre><code>import com.adendamedia.cornucopia.Library
import com.adendamedia.cornucopia.actors.CornucopiaSource.Task
</code></pre> 
  <p>Then, for example, from within your own AKKA actor you can send a message to Cornucopia:</p> 
  <pre><code>val cornucopiaRef = Library.ref    
cornucopiaRef ! Task("+master", "redis://localhost:7006")
</code></pre> 
  <p>Adding a master node will automatically trigger a <code>*reshard</code> event. Currently, removing a master node is not supported, but should be supported in the next release.</p> 
  <p>New slave nodes will initially be assigned to the master with the least slaves. Beyond that, Redis Cluster itself has the ability to migrate slaves to other masters based on the cluster configuration.</p> 
  <p>Note that Redis cluster will automatically assign or reassign nodes between master or slave roles, or migrate slaves between masters or do failover. You may see errors due to Redis doing reassignment when the cluster is small. For example, when testing with only two nodes, after adding the second node as a master, the first node can become a slave. If you then try to remove the second node, there will be no masters left. The behaviour is more predictable as more nodes are added to the cluster.</p> 
  <p>There may be multiple node ids (dead nodes that were not previously removed) assigned to one URI and Redis only returns one at a time so you may have remove the same URI multiple times to remove the correct node id.</p> 
  <h2><a id="user-content-application-configuration" class="anchor" href="https://github.com/adenda/cornucopia#application-configuration" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Application configuration</h2> 
  <h3><a id="user-content-cornucopia-configuration-settings" class="anchor" href="https://github.com/adenda/cornucopia#cornucopia-configuration-settings" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Cornucopia configuration settings</h3> 
  <table> 
   <thead> 
    <tr> 
     <th align="left">Setting</th> 
     <th align="left">Description</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td align="left"><code>cornucopia.refresh.timeout</code></td> 
     <td align="left">Time (seconds) to wait for cluster topology changes to propagate (default: 5 seconds).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>cornucopia.batch.period</code></td> 
     <td align="left">Time (seconds) to wait for batches to accumulate before executing a job (default: 5 seconds).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>cornucopia.http.host</code></td> 
     <td align="left">The hostname where the Cornucopia microservice is run (default: localhost).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>cornucopia.http.port</code></td> 
     <td align="left">The port on which the Cornucopia microservice is run (default: 9001).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>cornucopia.reshard.interval</code></td> 
     <td align="left">Mininum time (seconds) to wait between reshard events (default: 60 seconds).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>cornucopia.reshard.timeout</code></td> 
     <td align="left">The maximum upper time limit (seconds) that the cluster must be resharded within without the resharding failing (default: 300 seconds).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>cornucopia.migrate.slot.timeout</code></td> 
     <td align="left">The maximum upper time limit (seconds) that a slot must be migrated from one node to another during resharding without slot migration failing. (default: 60 seconds)</td> 
    </tr>
   </tbody>
  </table> 
  <h3><a id="user-content-redis-configuration-settings" class="anchor" href="https://github.com/adenda/cornucopia#redis-configuration-settings" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Redis configuration settings</h3> 
  <table> 
   <thead> 
    <tr> 
     <th align="left">Setting</th> 
     <th align="left">Description</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td align="left"><code>redis.cluster.seed.server.host</code></td> 
     <td align="left">Initial node-hostname from which the full cluster topology will be derived (default: localhost).</td> 
    </tr> 
    <tr> 
     <td align="left"><code>redis.cluster.seed.server.port</code></td> 
     <td align="left">Initial node-port from which the full cluster topology will be derived (default: 6379).</td> 
    </tr>
   </tbody>
  </table> 
  <h2><a id="user-content-auto-scaling" class="anchor" href="https://github.com/adenda/cornucopia#auto-scaling" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Auto-Scaling</h2> 
  <p>High memory utilization will require more master nodes. High master CPU utilization (writes) will require more master nodes. High slave CPU utilization (reads) will require more slave nodes.</p> 
  <p>Determination of scaling requirements is outside the scope of this project. A Kubernetes project will be available to instantiate and request initialization for node types based on cluster utilization.</p> 
 </article>
</div>