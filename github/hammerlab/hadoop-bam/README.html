<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-hadoop-bam" class="anchor" href="https://github.com/hammerlab/hadoop-bam#hadoop-bam" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>hadoop-bam</h1> 
  <p><a href="https://travis-ci.org/hammerlab/hadoop-bam" target="_blank"><img src="https://camo.githubusercontent.com/988fd2eaee61161fbf41e9f5751fd9ca0cdd479e/68747470733a2f2f7472617669732d63692e6f72672f68616d6d65726c61622f6861646f6f702d62616d2e7376673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/hammerlab/hadoop-bam.svg?branch=master" style="max-width:100%;"></a> <a href="https://coveralls.io/github/hammerlab/hadoop-bam?branch=master" target="_blank"><img src="https://camo.githubusercontent.com/aab7f6666eea67e92e595ade4a0182bfe6e1795d/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f68616d6d65726c61622f6861646f6f702d62616d2f62616467652e7376673f6272616e63683d6d6173746572" alt="Coverage Status" data-canonical-src="https://coveralls.io/repos/github/hammerlab/hadoop-bam/badge.svg?branch=master" style="max-width:100%;"></a> <a href="http://search.maven.org/#search%7Cga%7C1%7Chadoop-bam" target="_blank"><img src="https://camo.githubusercontent.com/3246c78f6915fdc1b6bdd9d9c68aa466184d2414/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f6f72672e68616d6d65726c61622f6861646f6f702d62616d5f322e31312e7376673f6d61784167653d363030" alt="Maven Central" data-canonical-src="https://img.shields.io/maven-central/v/org.hammerlab/hadoop-bam_2.11.svg?maxAge=600" style="max-width:100%;"></a></p> 
  <p>Extension of <a href="https://github.com/HadoopGenomics/Hadoop-BAM" target="_blank">HadoopGenomics/Hadoop-bam</a></p> 
  <p>Implements <a href="https://github.com/hammerlab/hadoop-bam/blob/master/src/main/scala/org/hammerlab/hadoop_bam/BAMInputFormat.scala" target="_blank">a <code>BAMInputFormat</code></a> that fetches BAM-ranges in parallel using a configurable number of worker-threads:</p> 
  <p><a href="https://docs.google.com/a/hammerlab.org/spreadsheets/d/11c6T-HxR7bMdPOeS6l3n4klBuC9PhgrR5JcSg2qa_H4/edit?usp=sharing" target="_blank"><img src="https://camo.githubusercontent.com/be6e960aa6d36e77638352d86db38571467bc3fe/68747470733a2f2f636c2e6c792f3343306b32593230335530692f696d616765253230283232292e706e67" alt="Scaling log-log plot" data-canonical-src="https://cl.ly/3C0k2Y203U0i/image%20(22).png" style="max-width:100%;"></a></p> 
  <p><em>Timings from <code>time spark-submit $JAR -n &lt;NUM&gt; &lt;BAM&gt;</code> for various numbers of threads (<code>NUM</code>), against a 178GB <code>BAM</code>; <a href="https://docs.google.com/spreadsheets/d/11c6T-HxR7bMdPOeS6l3n4klBuC9PhgrR5JcSg2qa_H4/edit#gid=1917204057" target="_blank">raw data here</a>.</em></p> 
  <h2><a id="user-content-impetus" class="anchor" href="https://github.com/hammerlab/hadoop-bam#impetus" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Impetus</h2> 
  <p>With <a href="https://github.com/HadoopGenomics/Hadoop-BAM/blob/7.8.0/src/main/java/org/seqdoop/hadoop_bam/BAMInputFormat.java" target="_blank">the upstream BAMInputFormat</a>, computing splits on a Google Cloud Storage (GCS)-resident BAM typically took O(minutes), e.g. 2mins for a 20GB BAM and 15mins on a 178GB BAM in recent benchmarks.</p> 
  <p>During this time, the driver node fetches data from each split-offset returned by <code>FileInputFormat</code>, typically â‰ˆ4 64KB BGZF blocks (or 256KB) every 32MB, 64MB, or 128MB according to the HDFS-block-size being used (or simulated in the case of a <a href="https://github.com/GoogleCloudPlatform/bigdata-interop/blob/v1.6.1/gcs/src/main/java/com/google/cloud/hadoop/fs/gcs/GoogleHadoopFS.java" target="_blank"><code>GoogleHadoopFS</code></a>).</p> 
  <p>Each network request and resulting split-computation happens in serial, and the network requests exhibit a high, fixed latency-cost.</p> 
  <p>By having N threads parallelize the work of [fetching the start of each <code>FileInputFormat</code>-split], near-perfect linear scaling has been observed, up to 64 threads bringing split-computation from 15mins to 20s on a 178GB BAM and from 2mins to 4s on a 22GB BAM; both were benchmarked on a 4-core GCE <code>n1-standard-4</code> VM.</p> 
  <h2><a id="user-content-using" class="anchor" href="https://github.com/hammerlab/hadoop-bam#using" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using</h2> 
  <h3><a id="user-content-via-mavensbt" class="anchor" href="https://github.com/hammerlab/hadoop-bam#via-mavensbt" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Via Maven/SBT</h3> 
  <p>You should be able to depend on the most recent release, <a href="https://oss.sonatype.org/content/repositories/releases/org/hammerlab/hadoop-bam_2.11/1.0.0/" target="_blank"><code>org.hammerlab:hadoop_bam:1.0.0</code></a>, and use <code>org.hammerlab.hadoop_bam.BAMInputFormat</code> where you'd otherwise have used <code>org.seqdoop.hadoop_bam.BAMInputFormat</code>.</p> 
  <p>In particular, using <code>org.seqdoop.hadoop_bam.BAMInputFormat</code> from Java code should work fine, as it is a vanilla Java class, but this has not been tested.</p> 
  <h3><a id="user-content-running-locally" class="anchor" href="https://github.com/hammerlab/hadoop-bam#running-locally" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Running Locally</h3> 
  <p>To build/run locally, try <a href="https://github.com/hammerlab/hadoop-bam/blob/master/src/main/scala/org/hammerlab/hadoop_bam/Main.scala" target="_blank">the sample <code>Main</code> contained in this library</a>:</p> 
  <div class="highlight highlight-source-shell">
   <pre>sbt assembly
JAR=target/scala-2.11/hadoop-bam-assembly-1.0.0-SNAPSHOT.jar
<span class="pl-k">time</span> spark-submit <span class="pl-s"><span class="pl-pds">"</span><span class="pl-smi">$JAR</span><span class="pl-pds">"</span></span> -n 32 <span class="pl-k">&lt;</span>BAM<span class="pl-k">&gt;</span></pre>
  </div> 
  <p>This print all computed splits as well as a timing stat for just the split-computation (whereas the stats output by <code>time</code> will include various app initialization-overhead time as well).</p> 
 </article>
</div>