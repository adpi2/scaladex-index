<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-akka-amqp-proxies" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#akka-amqp-proxies" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Akka AMQP Proxies</h1> 
  <h2><a id="user-content-overview" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#overview" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Overview</h2> 
  <p>“AMQP proxies” is a simple way of integrating AMQP with Akka to distribute jobs across a network of computing nodes. You still write “local” code, have very little to configure, and end up with a distributed, elastic, fault-tolerant grid where computing nodes can be written in nearly every programming language.</p> 
  <p>This project started as a demo for <a href="http://letitcrash.com/post/29988753572/akka-amqp-proxies" target="_blank">http://letitcrash.com/post/29988753572/akka-amqp-proxies</a> and is now used in a few "real" projects.</p> 
  <p>The original code has been improved, with the addition of:</p> 
  <ul> 
   <li>on-the-fly compression with snappy</li> 
   <li>a protobuf serializer (thanks to PM47!)</li> 
   <li>a thrift serializer</li> 
  </ul> 
  <p><a href="https://travis-ci.org/sstone/akka-amqp-proxies" target="_blank"><img src="https://camo.githubusercontent.com/5b9ce240d79180099fb01659d1db8a5aba3e5262/68747470733a2f2f7472617669732d63692e6f72672f7373746f6e652f616b6b612d616d71702d70726f786965732e706e67" alt="Build Status" data-canonical-src="https://travis-ci.org/sstone/akka-amqp-proxies.png" style="max-width:100%;"></a></p> 
  <h2><a id="user-content-configuring-mavensbt" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#configuring-mavensbt" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Configuring maven/sbt</h2> 
  <div class="highlight highlight-text-xml">
   <pre> &lt;<span class="pl-ent">repositories</span>&gt;
    &lt;<span class="pl-ent">repository</span>&gt;
        &lt;<span class="pl-ent">id</span>&gt;sonatype snapshots&lt;/<span class="pl-ent">id</span>&gt;
        &lt;<span class="pl-ent">url</span>&gt;https://oss.sonatype.org/content/repositories/snapshots/&lt;/<span class="pl-ent">url</span>&gt;
    &lt;/<span class="pl-ent">repository</span>&gt;
&lt;/<span class="pl-ent">repositories</span>&gt;

&lt;<span class="pl-ent">dependencies</span>&gt;
  &lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;com.github.sstone&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;akka-amqp-proxies_SCALA-VERSION&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;1.3&lt;/<span class="pl-ent">version</span>&gt;
  &lt;/<span class="pl-ent">dependency</span>&gt;
  &lt;<span class="pl-ent">dependency</span>&gt;
    &lt;<span class="pl-ent">groupId</span>&gt;com.typesafe.akka&lt;/<span class="pl-ent">groupId</span>&gt;
    &lt;<span class="pl-ent">artifactId</span>&gt;akka-actor_SCALA-VERSION&lt;/<span class="pl-ent">artifactId</span>&gt;
    &lt;<span class="pl-ent">version</span>&gt;AKKA-VERSION&lt;/<span class="pl-ent">version</span>&gt;
  &lt;/<span class="pl-ent">dependency</span>&gt;
&lt;/<span class="pl-ent">dependencies</span>&gt;</pre>
  </div> 
  <p>From version 1.1X on, snapshots are published to <a href="https://oss.sonatype.org/content/repositories/snapshots/" target="_blank">https://oss.sonatype.org/content/repositories/snapshots/</a> and releases are synced to Maven Central</p> 
  <ul> 
   <li>version 1.1 (master branch) is compatible with Scala 2.9.2 and Akka 2.0.5</li> 
   <li>version 1.1 (scala2.10 branch) is compatible with Scala 2.10 and Akka 2.1.0</li> 
   <li>version 1.3 (scala2.10 branch) is compatible with Scala 2.10.X and Akka 2.1.X</li> 
   <li>version 1.4 (scala2.10 branch) targets Scala 2.10.X and Akka 2.2.X</li> 
  </ul> 
  <h2><a id="user-content-calculator-demo" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#calculator-demo" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Calculator demo</h2> 
  <p>The demo is simple:</p> 
  <ul> 
   <li>start with write a basic local calculator actor that can add numbers</li> 
   <li>"proxify" it over AMQP, using JSON serialization</li> 
   <li>you can now start as many calculator servers as you want, and you get an elastic, fault-tolerant, load-balanced calculator grid</li> 
  </ul> 
  <p>To start the demo with local actors:</p> 
  <ul> 
   <li>mvn exec:java -Dexec.mainClass=com.github.sstone.amqp.proxy.Local</li> 
  </ul> 
  <p>To start the demo with a client proxy and remote server actors:</p> 
  <ul> 
   <li>mvn exec:java -Dexec.classpathScope=compile -Dexec.mainClass=com.github.sstone.amqp.proxy.Server (as many times as you want)</li> 
   <li>mvn exec:java -Dexec.classpathScope=compile -Dexec.mainClass=com.github.sstone.amqp.proxy.Client</li> 
  </ul> 
  <h2><a id="user-content-using-protobufthrift-serialization" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#using-protobufthrift-serialization" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using Protobuf/Thrift serialization</h2> 
  <p>Please check [<a href="https://github.com/sstone/akka-amqp-proxies/blob/scala2.10/src/test/scala/com/github.sstone/amqp/proxy/RemoteGpbCallTest.scala" target="_blank">https://github.com/sstone/akka-amqp-proxies/blob/scala2.10/src/test/scala/com/github.sstone/amqp/proxy/RemoteGpbCallTest.scala</a>] for an example of how to use Protobuf: I've defined a simple protobuf command language, generated java sources and added them to the project:</p> 
  <div class="highlight highlight-source-protobuf">
   <pre><span class="pl-k">package</span> <span class="pl-en">com.github.sstone.amqp.proxy.calculator</span>;

<span class="pl-c">// simple calculator API</span>

<span class="pl-c">// add request</span>
<span class="pl-c">//</span>
<span class="pl-k">message</span> <span class="pl-en">AddRequest</span> {
  <span class="pl-k">required</span> <span class="pl-k">int32</span> <span class="pl-smi">x</span> = <span class="pl-c1">1</span>;
  <span class="pl-k">required</span> <span class="pl-k">int32</span> <span class="pl-smi">y</span> = <span class="pl-c1">2</span>;
}

<span class="pl-c">// Add response</span>
<span class="pl-c">//</span>
<span class="pl-k">message</span> <span class="pl-en">AddResponse</span> {
  <span class="pl-k">required</span> <span class="pl-k">int32</span> <span class="pl-smi">x</span> = <span class="pl-c1">1</span>;
  <span class="pl-k">required</span> <span class="pl-k">int32</span> <span class="pl-smi">y</span> = <span class="pl-c1">2</span>;
  <span class="pl-k">required</span> <span class="pl-k">int32</span> <span class="pl-smi">sum</span> = <span class="pl-c1">3</span>;
}</pre>
  </div> 
  <p>Now I can exchange AddRequest and AddResponse messages transparently:</p> 
  <div class="highlight highlight-source-scala">
   <pre>proxy <span class="pl-k">?</span> <span class="pl-en">AddRequest</span>.newBuilder.setX(x).setY(y).build()).mapTo[<span class="pl-en">AddResponse</span>]</pre>
  </div> 
  <p>You would follow the same steps to use Thrift instead of Protobuf. Of course, in a real project, you would generate java sources at compilation time (using either one the of protobuf maven plugins or just the ant plugin). It should be fairly simple to write compatible sample clients and servers with Python or Ruby to demonstrate interroperrability</p> 
  <h2><a id="user-content-calling-actors-from-other-languages-python-ruby-" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#calling-actors-from-other-languages-python-ruby-" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Calling actors from other languages (python, ruby, ...)</h2> 
  <p>AMQP defines a binary protocol, and there are many AMQP clients available (PHP, python, ruby, java, scala, C#, haskell, ....) If you choose a standard message format, you can easily call Akka actors though AMQP proxies. So, let's see how we would call our "calculator" actor from other languages. The pattern is very simple and based on "standard" AMQP RPC:</p> 
  <ul> 
   <li>create an exclusive, auto-delete reply queue (usually with a random broker-generated name)</li> 
   <li>publish serialized AddRequest messages with the following properties 
    <ul> 
     <li>reply-to = name of the reply queue</li> 
     <li>content-type = message type (the name of the class of the message we're sending, com.github.sstone.amqp.proxy.Demo$AddRequest in our case)</li> 
     <li>content-encoding = message format (json in our case)</li> 
    </ul> </li> 
   <li>wait for a response, which should be an AddResponse(x, y, sum) message in JSON format</li> 
  </ul> 
  <p>To run the client samples, don't forget to start the server with mvn exec:java -Dexec.classpathScope=compile -Dexec.mainClass=com.github.sstone.amqp.proxy.Server</p> 
  <h3><a id="user-content-from-python-using-pika" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#from-python-using-pika" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>From python (using <a href="https://github.com/pika/pika" target="_blank">pika</a>)</h3> 
  <div class="highlight highlight-source-python">
   <pre><span class="pl-k">import</span> pika
<span class="pl-k">import</span> uuid
<span class="pl-k">import</span> json

<span class="pl-k">class</span> <span class="pl-en">CalculatorRpcClient</span>(<span class="pl-c1">object</span>):
    <span class="pl-k">def</span> <span class="pl-c1">__init__</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>):
        <span class="pl-c1">self</span>.connection <span class="pl-k">=</span> pika.BlockingConnection(pika.ConnectionParameters(<span class="pl-v">host</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>localhost<span class="pl-pds">'</span></span>))

        <span class="pl-c1">self</span>.channel <span class="pl-k">=</span> <span class="pl-c1">self</span>.connection.channel()

        result <span class="pl-k">=</span> <span class="pl-c1">self</span>.channel.queue_declare(<span class="pl-v">exclusive</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
        <span class="pl-c1">self</span>.callback_queue <span class="pl-k">=</span> result.method.queue

        <span class="pl-c1">self</span>.channel.basic_consume(<span class="pl-c1">self</span>.on_response, <span class="pl-v">no_ack</span><span class="pl-k">=</span><span class="pl-c1">True</span>, <span class="pl-v">queue</span><span class="pl-k">=</span><span class="pl-c1">self</span>.callback_queue)

    <span class="pl-k">def</span> <span class="pl-en">on_response</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">ch</span>, <span class="pl-smi">method</span>, <span class="pl-smi">props</span>, <span class="pl-smi">body</span>):
        <span class="pl-k">if</span> <span class="pl-c1">self</span>.corr_id <span class="pl-k">==</span> props.correlation_id:
            <span class="pl-c1">self</span>.response <span class="pl-k">=</span> body

    <span class="pl-k">def</span> <span class="pl-en">add</span>(<span class="pl-smi"><span class="pl-smi">self</span></span>, <span class="pl-smi">x</span>, <span class="pl-smi">y</span>):
        <span class="pl-c1">self</span>.response <span class="pl-k">=</span> <span class="pl-c1">None</span>
        <span class="pl-c1">self</span>.corr_id <span class="pl-k">=</span> <span class="pl-c1">str</span>(uuid.uuid4())
        msg <span class="pl-k">=</span> json.dumps({ <span class="pl-s"><span class="pl-pds">"</span>x<span class="pl-pds">"</span></span>:x, <span class="pl-s"><span class="pl-pds">"</span>y<span class="pl-pds">"</span></span>:y })
        <span class="pl-c1">self</span>.channel.basic_publish(<span class="pl-v">exchange</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>,
                                   <span class="pl-v">routing_key</span><span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>calculator<span class="pl-pds">'</span></span>,
                                   <span class="pl-v">properties</span><span class="pl-k">=</span>pika.BasicProperties(
                                         <span class="pl-v">reply_to</span> <span class="pl-k">=</span> <span class="pl-c1">self</span>.callback_queue,
                                         <span class="pl-v">correlation_id</span> <span class="pl-k">=</span> <span class="pl-c1">self</span>.corr_id,
										 <span class="pl-v">content_type</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>com.github.sstone.amqp.proxy.Demo$AddRequest<span class="pl-pds">'</span></span>,
										 <span class="pl-v">content_encoding</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>json<span class="pl-pds">'</span></span>
                                         ),
                                   <span class="pl-v">body</span><span class="pl-k">=</span>msg)
        <span class="pl-k">while</span> <span class="pl-c1">self</span>.response <span class="pl-k">is</span> <span class="pl-c1">None</span>:
            <span class="pl-c1">self</span>.connection.process_data_events()
        raw <span class="pl-k">=</span> <span class="pl-c1">self</span>.response
        decoded <span class="pl-k">=</span> json.loads(raw)
        <span class="pl-k">return</span> decoded[<span class="pl-s"><span class="pl-pds">'</span>sum<span class="pl-pds">'</span></span>]

calculator_rpc <span class="pl-k">=</span> CalculatorRpcClient()

x <span class="pl-k">=</span> <span class="pl-c1">1</span>
y <span class="pl-k">=</span> <span class="pl-c1">2</span>
<span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span> [x] Requesting <span class="pl-pds">"</span></span>, x, <span class="pl-s"><span class="pl-pds">"</span> + <span class="pl-pds">"</span></span>, y
response <span class="pl-k">=</span> calculator_rpc.add(x, y)
<span class="pl-c1">print</span> <span class="pl-s"><span class="pl-pds">"</span> [.] Got <span class="pl-c1">%r</span><span class="pl-pds">"</span></span> <span class="pl-k">%</span> (response,)</pre>
  </div> 
  <h3><a id="user-content-from-ruby-using-ruby-amqp" class="anchor" href="https://github.com/sstone/akka-amqp-proxies#from-ruby-using-ruby-amqp" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>From ruby (using <a href="https://github.com/ruby-amqp/amqp" target="_blank">ruby-amqp</a>)</h3> 
  <div class="highlight highlight-source-ruby">
   <pre><span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>amqp<span class="pl-pds">'</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>json<span class="pl-pds">'</span></span>
<span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>securerandom<span class="pl-pds">'</span></span>

x <span class="pl-k">=</span> <span class="pl-c1">1</span>
y <span class="pl-k">=</span> <span class="pl-c1">2</span>

<span class="pl-c1">EventMachine</span>.run <span class="pl-k">do</span>
  connection <span class="pl-k">=</span> <span class="pl-c1">AMQP</span>.connect(<span class="pl-c1">:host</span> =&gt; <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>)
  puts <span class="pl-s"><span class="pl-pds">"</span>Connecting to AMQP broker. Running <span class="pl-pse">#{</span><span class="pl-s1"><span class="pl-c1">AMQP</span>::<span class="pl-c1">VERSION</span></span><span class="pl-pse"><span class="pl-s1">}</span></span> version of the gem...<span class="pl-pds">"</span></span>

  channel <span class="pl-k">=</span> <span class="pl-c1">AMQP</span>::<span class="pl-c1">Channel</span>.<span class="pl-k">new</span>(connection)
  exchange <span class="pl-k">=</span> channel.default_exchange

  <span class="pl-c"><span class="pl-c">#</span> create a JSON AddRequest message</span>
  request <span class="pl-k">=</span> <span class="pl-c1">JSON</span>.generate({<span class="pl-c1">:x</span> =&gt; x, <span class="pl-c1">:y</span> =&gt; y})

  <span class="pl-c"><span class="pl-c">#</span> "standard" RPC pattern: create an exclusive private queue with a unique, randomized, broker-generated name</span>
  <span class="pl-c"><span class="pl-c">#</span> and publish message with the 'reply-to' property set to the name of this reply queue</span>
  reply_queue <span class="pl-k">=</span> channel.queue(<span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>, <span class="pl-c1">:exclusive</span> =&gt; <span class="pl-c1">true</span>, <span class="pl-c1">:auto_delete</span> =&gt; <span class="pl-c1">true</span>) <span class="pl-k">do </span>|<span class="pl-smi">queue</span>|
    exchange.publish request, {
        <span class="pl-c1">:routing_key</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>calculator<span class="pl-pds">"</span></span>,
        <span class="pl-c1">:correlation_id</span> =&gt; <span class="pl-c1">SecureRandom</span>.uuid,
        <span class="pl-c1">:reply_to</span> =&gt; queue.name,
        <span class="pl-c1">:content_encoding</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>json<span class="pl-pds">"</span></span>,
        <span class="pl-c1">:content_type</span> =&gt; <span class="pl-s"><span class="pl-pds">"</span>com.github.sstone.amqp.proxy.Demo$AddRequest<span class="pl-pds">"</span></span>
    }
  <span class="pl-k">end</span>
  reply_queue.subscribe <span class="pl-k">do </span>|<span class="pl-smi">metadata</span>, <span class="pl-smi">payload</span>|
    puts <span class="pl-s"><span class="pl-pds">"</span>raw esponse for <span class="pl-pse">#{</span><span class="pl-s1">metadata.correlation_id</span><span class="pl-pse"><span class="pl-s1">}</span></span>: <span class="pl-pse">#{</span><span class="pl-s1">metadata.content_encoding</span><span class="pl-pse"><span class="pl-s1">}</span></span> <span class="pl-pse">#{</span><span class="pl-s1">metadata.content_type</span><span class="pl-pse"><span class="pl-s1">}</span></span> <span class="pl-pse">#{</span><span class="pl-s1">payload.inspect</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>

    <span class="pl-c"><span class="pl-c">#</span> payload shoud look like { "x" : x, "y" : y, "sum" : sum }</span>
    response <span class="pl-k">=</span> <span class="pl-c1">JSON</span>.parse(payload)
    puts <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pse">#{</span><span class="pl-s1">x</span><span class="pl-pse"><span class="pl-s1">}</span></span> + <span class="pl-pse">#{</span><span class="pl-s1">y</span><span class="pl-pse"><span class="pl-s1">}</span></span> = <span class="pl-pse">#{</span><span class="pl-s1">response[<span class="pl-s"><span class="pl-pds">'</span>sum<span class="pl-pds">'</span></span>]</span><span class="pl-pse"><span class="pl-s1">}</span></span><span class="pl-pds">"</span></span>

    connection.close {
      <span class="pl-c1">EventMachine</span>.stop { exit }
    }
  <span class="pl-k">end</span>

<span class="pl-k">end</span></pre>
  </div> 
 </article>
</div>