<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a href="https://github.com/spotify/hype#hype" aria-hidden="true" class="anchor" id="user-content-hype" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>hype</h1> 
  <p><a href="https://circleci.com/gh/spotify/hype" target="_blank"><img src="https://camo.githubusercontent.com/27eebcf184a489030265403410a47203250744cf/68747470733a2f2f696d672e736869656c64732e696f2f636972636c6563692f70726f6a6563742f6769746875622f73706f746966792f687970652f6d61737465722e737667" alt="Build Status" data-canonical-src="https://img.shields.io/circleci/project/github/spotify/hype/master.svg" style="max-width:100%;"></a> <a href="https://codecov.io/github/spotify/hype?branch=master" target="_blank"><img src="https://camo.githubusercontent.com/be66e83424c96eae961bd96fb03a7d27882b10a4/68747470733a2f2f636f6465636f762e696f2f6769746875622f73706f746966792f687970652f636f7665726167652e7376673f6272616e63683d6d6173746572" alt="codecov.io" data-canonical-src="https://codecov.io/github/spotify/hype/coverage.svg?branch=master" style="max-width:100%;"></a> <a href="https://search.maven.org/#search%7Cga%7C1%7Cg%3A%22com.spotify%22%20hype*" target="_blank"><img src="https://camo.githubusercontent.com/096429824276946fb7cc1ead4e51d51e7080f331/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f636f6d2e73706f746966792f687970652d726f6f742e737667" alt="Maven Central" data-canonical-src="https://img.shields.io/maven-central/v/com.spotify/hype-root.svg" style="max-width:100%;"></a> <a href="https://github.com/spotify/hype/blob/master/LICENSE" target="_blank"><img src="https://camo.githubusercontent.com/99b7f28195fb28171af8005073a30d54e0ddc01e/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f6c6963656e73652f73706f746966792f687970652e737667" alt="GitHub license" data-canonical-src="https://img.shields.io/github/license/spotify/hype.svg" style="max-width:100%;"></a></p> 
  <p>A library for seamlessly executing arbitrary JVM closures in <a href="https://www.docker.com" target="_blank">Docker</a> containers on <a href="https://kubernetes.io/" target="_blank">Kubernetes</a>.</p> 
  <hr> 
  <ul> 
   <li><a href="https://github.com/spotify/hype#user-guide" target="_blank">User guide</a> 
    <ul> 
     <li><a href="https://github.com/spotify/hype#dependecy" target="_blank">Dependency</a></li> 
     <li><a href="https://github.com/spotify/hype#run-functions" target="_blank">Run functions</a></li> 
     <li><a href="https://github.com/spotify/hype#full-example" target="_blank">Full example</a></li> 
     <li><a href="https://github.com/spotify/hype#leveraging-implicits" target="_blank">Leveraging implicits</a></li> 
     <li><a href="https://github.com/spotify/hype#custom-environment-images" target="_blank">Custom environment images</a></li> 
    </ul> </li> 
   <li><a href="https://github.com/spotify/hype#process-overview" target="_blank">Process overview</a></li> 
   <li><a href="https://github.com/spotify/hype#persistent-disk" target="_blank">Persistent disk</a> 
    <ul> 
     <li><a href="https://github.com/spotify/hype#gce-persistent-disk" target="_blank">GCE Persistent Disk</a> 
      <ul> 
       <li><a href="https://github.com/spotify/hype#volume-re-use" target="_blank">Volume re-use</a></li> 
      </ul> </li> 
    </ul> </li> 
   <li><a href="https://github.com/spotify/hype#environment-pod-from-yaml" target="_blank">Environment Pod from YAML</a></li> 
  </ul> 
  <hr> 
  <h1><a href="https://github.com/spotify/hype#user-guide" aria-hidden="true" class="anchor" id="user-content-user-guide" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>User guide</h1> 
  <p>Hype lets you execute arbitrary JVM code in a distributed environment where different parts might run concurrently in separate Docker containers, each using different amounts of memory, CPU and disk. With the help of Kubernetes and a cloud provider such as Google Cloud Platform, you'll have dynamically scheduled resources available for your code to utilize.</p> 
  <p>All this might sound a bit abstract, so let's run through a concrete example. We'll be using Scala for the examples, but all the core functionality is available from Java as well.</p> 
  <h2><a href="https://github.com/spotify/hype#dependency" aria-hidden="true" class="anchor" id="user-content-dependency" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Dependency</h2> 
  <p>SBT</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-s"><span class="pl-pds">"</span>com.spotify<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>hype<span class="pl-pds">"</span></span> <span class="pl-k">%</span> &lt;<span class="pl-ent">version</span>&gt;</pre>
  </div> 
  <h2><a href="https://github.com/spotify/hype#run-functions" aria-hidden="true" class="anchor" id="user-content-run-functions" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Run functions</h2> 
  <p>In order to run functions on the cluster, you'll have to set up a <code>Submitter</code> value. The submitter encapsulates "where" to submit your functions.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">submitter</span> <span class="pl-k">=</span> <span class="pl-en">GkeSubmitter</span>(<span class="pl-s"><span class="pl-pds">"</span>gcp-project-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gce-zone-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gke-cluster-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gs://my-staging-bucket<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>For testing, where you might want to run on a local Docker daemon, use <code>LocalSubmitter(...)</code>.</p> 
  <p>Writing functions that can be executed with Hype is simple, just wrap them up as an <code>HFn[T]</code>. An <code>HFn[T]</code> is a closure that allows Hype to move the actual evaluation into a Docker container.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">def</span> <span class="pl-en">example</span>(<span class="pl-v">arg</span>: <span class="pl-k">String</span>) <span class="pl-k">=</span> <span class="pl-en">HFn</span>[<span class="pl-k">String</span>] {
  arg <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> world!<span class="pl-pds">"</span></span>
}</pre>
  </div> 
  <p>In the previous example, the default Hype Docker image (<code>spotify/hype</code>) is used. If you wish to use your own image, you can easily do so:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">def</span> <span class="pl-en">example</span>(<span class="pl-v">arg</span>: <span class="pl-k">String</span>) <span class="pl-k">=</span> <span class="pl-en">HFn</span>.withImage(<span class="pl-s"><span class="pl-pds">"</span>us.gcr.io/my-image:42<span class="pl-pds">"</span></span>) {
  arg <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">"</span> world!<span class="pl-pds">"</span></span>
}</pre>
  </div> 
  <p>Now we'll have to define the environment we want this function to run in.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">env</span> <span class="pl-k">=</span> <span class="pl-en">RunEnvironment</span>()</pre>
  </div> 
  <p>Finally, use use the <code>Submitter</code> and <code>RunEnvironment</code> to execute an <code>HFn[T]</code>. When execution is complete, it'll return the function value back to your local context.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">result</span> <span class="pl-k">=</span> submitter.submit(example(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>), env.withRequest(<span class="pl-s"><span class="pl-pds">"</span>cpu<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>750m<span class="pl-pds">"</span></span>))</pre>
  </div> 
  <h2><a href="https://github.com/spotify/hype#full-example" aria-hidden="true" class="anchor" id="user-content-full-example" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Full example</h2> 
  <p>This is a full example that runs a simple function that executes an arbitrary command and lists all environment variables. It uses the Scala <a href="http://www.scala-lang.org/api/rc2/scala/sys/process/package.html" target="_blank">sys.process</a> package to execute commands in the function. Also see the <a href="https://kubernetes.io/docs/concepts/configuration/secret/#creating-your-own-secrets" target="_blank">docs on how to create k8s secrets</a></p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">sys.process.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">com.spotify.hype.</span><span class="pl-v">_</span>

<span class="pl-c"><span class="pl-c">//</span> A simple model for describing the runtime environment</span>
<span class="pl-k">case</span> <span class="pl-k">class</span> <span class="pl-en">EnvVar</span>(<span class="pl-v">name</span>: <span class="pl-k">String</span>, <span class="pl-v">value</span>: <span class="pl-k">String</span>)
<span class="pl-k">case</span> <span class="pl-k">class</span> <span class="pl-en">Res</span>(<span class="pl-v">cmdOutput</span>: <span class="pl-k">String</span>, <span class="pl-v">mounts</span>: <span class="pl-k">String</span>, <span class="pl-v">vars</span>: <span class="pl-en">List</span>[<span class="pl-en">EnvVar</span>])

<span class="pl-k">def</span> <span class="pl-en">extractEnv</span>(<span class="pl-v">cmd</span>: <span class="pl-k">String</span>) <span class="pl-k">=</span> <span class="pl-en">HFn</span>[<span class="pl-en">Res</span>] {
  <span class="pl-k">val</span> <span class="pl-en">cmdOutput</span> <span class="pl-k">=</span> cmd <span class="pl-k">!!</span>
  <span class="pl-k">val</span> <span class="pl-en">mounts</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>df -h<span class="pl-pds">"</span></span> <span class="pl-k">!!</span>
  <span class="pl-k">val</span> <span class="pl-en">vars</span> <span class="pl-k">=</span> <span class="pl-k">for</span> ((key, value) <span class="pl-k">&lt;</span><span class="pl-k">-</span> sys.env.toList)
    <span class="pl-k">yield</span> <span class="pl-en">EnvVar</span>(key, value)

  <span class="pl-en">Res</span>(cmdOutput, mounts, vars)
}

<span class="pl-k">val</span> <span class="pl-en">submitter</span> <span class="pl-k">=</span> <span class="pl-en">GkeSubmitter</span>(<span class="pl-s"><span class="pl-pds">"</span>gcp-project-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gce-zone-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gke-cluster-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gs://my-staging-bucket<span class="pl-pds">"</span></span>)
<span class="pl-k">val</span> <span class="pl-en">env</span> <span class="pl-k">=</span> <span class="pl-en">RunEnvironment</span>()
    .withSecret(<span class="pl-s"><span class="pl-pds">"</span>gcp-key<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>/etc/gcloud<span class="pl-pds">"</span></span>) <span class="pl-c"><span class="pl-c">//</span> a pre-created k8s secret volume named "gcp-key"</span>

<span class="pl-k">val</span> <span class="pl-en">res</span> <span class="pl-k">=</span> submitter.submit(extractEnv(<span class="pl-s"><span class="pl-pds">"</span>uname -a<span class="pl-pds">"</span></span>), env)

println(res.cmdOutput)
println(res.mounts)
res.vars.foreach(println)</pre>
  </div> 
  <p>The <code>res.vars</code> list returned should contain the environment variables that were present in the docker container while running on the cluster. Here's the output:</p> 
  <pre><code>[info] Running HypeExample
[info] 22:15:14.211 | INFO | StagingUtil |&gt; Uploading 69 files to staging location gs://my-staging-bucket to prepare for execution.
[info] 22:15:51.057 | INFO | StagingUtil |&gt; Uploading complete: 4 files newly uploaded, 65 files cached
[info] 22:15:51.673 | INFO | Submitter  |&gt; Submitting gs://my-staging-bucket/manifest-9vhb5u18.txt to RunEnvironment{base=RunEnvironment.SimpleBase{image=gcr.io/gcp-project-id/env-image}, secretMounts=[Secret{name=gcp-key, mountPath=/etc/gcloud}], volumeMounts=[], resourceRequests={}}
[info] 22:15:52.221 | INFO | DockerRunner |&gt; Created pod hype-run-mymlbuw8
[info] 22:15:52.351 | INFO | DockerRunner |&gt; Pod hype-run-mymlbuw8 assigned to node gke-hype-test-default-pool-e1122946-fg9k
[info] 22:16:02.454 | INFO | DockerRunner |&gt; Kubernetes pod hype-run-mymlbuw8 exited with status Succeeded
[info] 22:16:02.455 | INFO | DockerRunner |&gt; Got termination message: gs://my-staging-bucket/continuation-993467547293976140-eUWBfwL9J2tHvWuJw0lU3g-hype-run-mymlbuw8-return.bin
[info] Linux hype-run-mymlbuw8 4.4.21+ #1 SMP Fri Feb 17 15:34:45 PST 2017 x86_64 GNU/Linux
[info]
[info] Filesystem      Size  Used Avail Use% Mounted on
[info] overlay          95G  4.1G   91G   5% /
[info] tmpfs           7.4G     0  7.4G   0% /dev
[info] tmpfs           7.4G     0  7.4G   0% /sys/fs/cgroup
[info] tmpfs           7.4G  4.0K  7.4G   1% /etc/gcloud
[info] /dev/sda1        95G  4.1G   91G   5% /etc/hosts
[info] tmpfs           7.4G   12K  7.4G   1% /run/secrets/kubernetes.io/serviceaccount
[info] shm              64M     0   64M   0% /dev/shm
[info]
[info] EnvVar(HYPE_EXECUTION_ID,hype-run-mymlbuw8)
[info] EnvVar(GOOGLE_APPLICATION_CREDENTIALS,/etc/gcloud/key.json)
[info] EnvVar(HOSTNAME,hype-run-cv7cln6y)
[info] EnvVar(PATH,/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin)
[info] EnvVar(JAVA_VERSION,8u121)
[info] EnvVar(KUBERNETES_SERVICE_HOST,xx.xx.xx.xx)
...
</code></pre> 
  <h2><a href="https://github.com/spotify/hype#leveraging-implicits" aria-hidden="true" class="anchor" id="user-content-leveraging-implicits" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Leveraging implicits</h2> 
  <p>In order to save some keystrokes, you can use our <code>implicit</code> operators:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">com.spotify.hype.magic.</span><span class="pl-v">_</span></pre>
  </div> 
  <p>Now you can set up an <code>implicit</code> <code>Submitter</code> value.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">implicit</span> <span class="pl-k">val</span> <span class="pl-en">submitter</span> <span class="pl-k">=</span> <span class="pl-en">GkeSubmitter</span>(<span class="pl-s"><span class="pl-pds">"</span>gcp-project-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gce-zone-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gke-cluster-id<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gs://my-staging-bucket<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>The environment value can also be declared <code>implicit</code>, but this is not required as it can explicitly be referenced when submitting functions.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">implicit</span> <span class="pl-k">val</span> <span class="pl-en">env</span> <span class="pl-k">=</span> <span class="pl-en">RunEnvironment</span>().withSecret(<span class="pl-s"><span class="pl-pds">"</span>gcp-key<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>/etc/gcloud<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>Finally, use the <code>#!</code> (hashbang) operator to execute an <code>HFn[T]</code> in a given environment. It will use the <code>Submitter</code> and <code>RunEnvironment</code> which should be in scope.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">result</span> <span class="pl-k">=</span> example(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>) #<span class="pl-k">!</span></pre>
  </div> 
  <p>Using an <code>implicit</code> value as we did above works in most cases, but the hashbang (<code>#!</code>) operator also allows you to specify an explicit environment.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">result</span> <span class="pl-k">=</span> example(<span class="pl-s"><span class="pl-pds">"</span>hello<span class="pl-pds">"</span></span>) #<span class="pl-k">!</span> env.withRequest(<span class="pl-s"><span class="pl-pds">"</span>cpu<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>750m<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <h2><a href="https://github.com/spotify/hype#custom-environment-images" aria-hidden="true" class="anchor" id="user-content-custom-environment-images" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Custom environment images</h2> 
  <p>In order for Hype to be able to execute functions in your custom Docker images, you'll have to install the <code>hype-run</code> command by adding the following to your <code>Dockerfile</code>:</p> 
  <div class="highlight highlight-source-dockerfile">
   <pre><span class="pl-c"><span class="pl-c">#</span> Install hype-run command</span>
<span class="pl-k">RUN</span> /bin/sh -c <span class="pl-s">"$(curl -fsSL https://goo.gl/kSogpF)"</span>
<span class="pl-k">ENTRYPOINT</span> [<span class="pl-s">"hype-run"</span>]</pre>
  </div> 
  <p>It is important to have exactly this <code>ENTRYPOINT</code> as the Kubernetes Pods will expect to run the <code>hype-run</code> command.</p> 
  <p>See example <a href="https://github.com/spotify/hype/blob/master/hype-docker/Dockerfile" target="_blank"><code>Dockerfile</code></a></p> 
  <h1><a href="https://github.com/spotify/hype#process-overview" aria-hidden="true" class="anchor" id="user-content-process-overview" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Process overview</h1> 
  <p>This describes what Hype does from a high level point of view.</p> 
  <p align="center"> <a href="https://github.com/spotify/hype/blob/master/doc/hype.png?raw=true" target="_blank"><img src="https://github.com/spotify/hype/raw/master/doc/hype.png?raw=true" width="723" height="336" style="max-width:100%;"></a> </p> 
  <h1><a href="https://github.com/spotify/hype#persistent-disk" aria-hidden="true" class="anchor" id="user-content-persistent-disk" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Persistent disk</h1> 
  <p>Hype makes it easy to schedule persistent disk volumes across different closures in a workflow. A typical pattern seen in many use cases is to first use a disk in read-write mode to download and prepare some data, and then fork out to several parallel tasks that use the disk in read-only mode.</p> 
  <p align="center"> <a href="https://github.com/spotify/hype/blob/master/doc/hype-volumes.png?raw=true" target="_blank"><img src="https://github.com/spotify/hype/raw/master/doc/hype-volumes.png?raw=true" width="406" height="213" style="max-width:100%;"></a> </p> 
  <h2><a href="https://github.com/spotify/hype#gce-persistent-disk" aria-hidden="true" class="anchor" id="user-content-gce-persistent-disk" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>GCE Persistent Disk</h2> 
  <p>In this example, we're using a StorageClass for <a href="http://blog.kubernetes.io/2016/10/dynamic-provisioning-and-storage-in-kubernetes.html" target="_blank">GCE Persistent Disk</a> that we've already set up on our cluster.</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-ent">kind</span>: <span class="pl-s">StorageClass</span>
<span class="pl-ent">apiVersion</span>: <span class="pl-s">storage.k8s.io/v1beta1</span>
<span class="pl-ent">metadata</span>:
  <span class="pl-ent">name</span>: <span class="pl-s">gce-ssd-pd</span>
<span class="pl-ent">provisioner</span>: <span class="pl-s">kubernetes.io/gce-pd</span>
<span class="pl-ent">parameters</span>:
  <span class="pl-ent">type</span>: <span class="pl-s">pd-ssd</span></pre>
  </div> 
  <p>We can then request volumes from this StorageClass using the Hype API:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">sys.process.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">com.spotify.hype.magic.</span><span class="pl-v">_</span>

<span class="pl-k">implicit</span> <span class="pl-k">val</span> <span class="pl-en">submitter</span> <span class="pl-k">=</span> <span class="pl-en">GkeSubmitter</span>(<span class="pl-s"><span class="pl-pds">"</span>gcp-project-id<span class="pl-pds">"</span></span>,
                                      <span class="pl-s"><span class="pl-pds">"</span>gce-zone-id<span class="pl-pds">"</span></span>,
                                      <span class="pl-s"><span class="pl-pds">"</span>gke-cluster-id<span class="pl-pds">"</span></span>,
                                      <span class="pl-s"><span class="pl-pds">"</span>gs://my-staging-bucket<span class="pl-pds">"</span></span>)

<span class="pl-c"><span class="pl-c">//</span> Create a 10Gi volume from the 'gce-ssd-pd' storage class</span>
<span class="pl-k">val</span> <span class="pl-en">ssd10Gi</span> <span class="pl-k">=</span> <span class="pl-en">TransientVolume</span>(<span class="pl-s"><span class="pl-pds">"</span>gce-ssd-pd<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>10Gi<span class="pl-pds">"</span></span>)
<span class="pl-k">val</span> <span class="pl-en">mount</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>/usr/share/volume<span class="pl-pds">"</span></span> 

<span class="pl-k">val</span> <span class="pl-en">env</span> <span class="pl-k">=</span> <span class="pl-en">RunEnvironment</span>()
<span class="pl-k">val</span> <span class="pl-en">readWriteEnv</span> <span class="pl-k">=</span> env.withMount(ssd10Gi.mountReadWrite(mount))
<span class="pl-k">val</span> <span class="pl-en">readOnlyEnv</span> <span class="pl-k">=</span> env.withMount(ssd10Gi.mountReadOnly(mount))

<span class="pl-k">def</span> <span class="pl-en">write</span> <span class="pl-k">=</span> <span class="pl-en">HFn</span>[<span class="pl-k">Int</span>] {
  <span class="pl-c"><span class="pl-c">//</span> get a random word and store it in the volume</span>
  s<span class="pl-s"><span class="pl-pds">"</span>curl -so $mount/word http://www.setgetgo.com/randomword/get.php<span class="pl-pds">"</span></span> <span class="pl-k">!</span>
}

<span class="pl-k">def</span> <span class="pl-en">read</span> <span class="pl-k">=</span> <span class="pl-en">HFn</span>[<span class="pl-k">String</span>] {
  <span class="pl-c"><span class="pl-c">//</span> read the word file</span>
  s<span class="pl-s"><span class="pl-pds">"</span>cat $mount/word<span class="pl-pds">"</span></span> <span class="pl-k">!!</span>
}

<span class="pl-c"><span class="pl-c">//</span> Write to the volume</span>
write #<span class="pl-k">!</span> readWriteEnv

<span class="pl-c"><span class="pl-c">//</span> Run 10 parallel functions that have read only access to the volume</span>
<span class="pl-k">val</span> <span class="pl-en">results</span> <span class="pl-k">=</span> <span class="pl-k">for</span> (_ <span class="pl-k">&lt;</span><span class="pl-k">-</span> <span class="pl-en">Range</span>(<span class="pl-c1">0</span>, <span class="pl-c1">10</span>).par)
    <span class="pl-k">yield</span> read #<span class="pl-k">!</span> readOnlyEnv</pre>
  </div> 
  <p>The submissions from the parallel range will each run concurrently in separate pods and have read-only access to the <code>/usr/share/volume</code> mount. The volume should contain the random word that was written to it from the <code>write</code> function.</p> 
  <p>Coordinating metadata and parameters across multiple submissions should be just as trivial as passing values from function calls as arguments to other functions.</p> 
  <h3><a href="https://github.com/spotify/hype#volume-re-use" aria-hidden="true" class="anchor" id="user-content-volume-re-use" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Volume re-use</h3> 
  <p>By default, the backing claim for a <code>TransientVolume</code> on Kubernetes is deleted when the JVM terminates.</p> 
  <p>If you wish to persist the Volume between invocations, you can use:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">disk</span> <span class="pl-k">=</span> <span class="pl-en">PersistentVolume</span>(<span class="pl-s"><span class="pl-pds">"</span>my-persistent-volume<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>gce-ssd-pd<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>10Gi<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>If the volume does not exist, it will be created. Subsequent invocations will return use already created volume.</p> 
  <p>This is useful in use cases with larger volumes that take a significant amount of time to load, or when there's some sort of workflow orchestration around the Hype code that might run different parts in separate JVM invocations.</p> 
  <h1><a href="https://github.com/spotify/hype#environment-pod-from-yaml" aria-hidden="true" class="anchor" id="user-content-environment-pod-from-yaml" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Environment Pod from YAML</h1> 
  <p>Sometimes more control over the Kubernetes Pod is desired. For these cases a regular Pod YAML file can be used as a base for the <code>RunEnvironment</code>. Hype will still manage any used Volume Claims and mounts, but will leave all other details as you've specified them.</p> 
  <p>Hype will expect at least this field to be specified:</p> 
  <ul> 
   <li><code>spec.containers[name:hype-run]</code> - There must at least be a container named <code>hype-run</code></li> 
  </ul> 
  <p>Please note that the image field should <em>not</em> bet set (Hype requires each module to define its image).</p> 
  <p><em>Hype will override the <code>spec.containers[name:hype-run].args</code> field, so don't set it.</em></p> 
  <p>Here's a minimal Pod YAML file with some custom settings, <code>./src/main/resources/pod.yaml</code>:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-ent">apiVersion</span>: <span class="pl-s">v1</span>
<span class="pl-ent">kind</span>: <span class="pl-s">Pod</span>

<span class="pl-ent">spec</span>:
  <span class="pl-ent">restartPolicy</span>: <span class="pl-s">Never </span><span class="pl-c"><span class="pl-c">#</span> do not retry on failure</span>

  <span class="pl-ent">containers</span>:
  - <span class="pl-ent">name</span>: <span class="pl-s">hype-run</span>
    <span class="pl-ent">imagePullPolicy</span>: <span class="pl-s">Always </span><span class="pl-c"><span class="pl-c">#</span> pull the image on each run</span>

    <span class="pl-ent">env</span>: <span class="pl-c"><span class="pl-c">#</span> additional environment variables</span>
    - <span class="pl-ent">name</span>: <span class="pl-s">EXAMPLE</span>
      <span class="pl-ent">value</span>: <span class="pl-s">my-env-value</span></pre>
  </div> 
  <p>Any resource requests added through the <code>RunEnvironment</code> API will merge with, and override the ones set in the YAML file.</p> 
  <p>Then simply load your <code>RunEnvironment</code> through</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">env</span> <span class="pl-k">=</span> <span class="pl-en">RunEnvironmentFromYaml</span>(<span class="pl-s"><span class="pl-pds">"</span>/pod.yaml<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <hr> 
  <p><em>This project is in early development stages, expect anything you see to change.</em></p> 
 </article>
</div>