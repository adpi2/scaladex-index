<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h2><a href="https://github.com/yannick-cw/elastic-indexer4s#elasticindexer4s" aria-hidden="true" class="anchor" id="user-content-elasticindexer4s" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>ElasticIndexer4s</h2> 
  <p><a href="https://travis-ci.org/yannick-cw/elastic-indexer4s" target="_blank"><img src="https://camo.githubusercontent.com/d300580685e821ed8bc80b84cb945b570cf5c68c/68747470733a2f2f7472617669732d63692e6f72672f79616e6e69636b2d63772f656c61737469632d696e646578657234732e7376673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/yannick-cw/elastic-indexer4s.svg?branch=master" style="max-width:100%;"></a> <a href="https://coveralls.io/github/yannick-cw/elastic-indexer4s?branch=master" target="_blank"><img src="https://camo.githubusercontent.com/1208d4f84a8eca2486930c0241a8ba6a8e06aad0/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f79616e6e69636b2d63772f656c61737469632d696e646578657234732f62616467652e7376673f6272616e63683d6d6173746572" alt="Coverage Status" data-canonical-src="https://coveralls.io/repos/github/yannick-cw/elastic-indexer4s/badge.svg?branch=master" style="max-width:100%;"></a></p> 
  <h3><a href="https://github.com/yannick-cw/elastic-indexer4s#overview" aria-hidden="true" class="anchor" id="user-content-overview" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Overview</h3> 
  <p>ElasticIndexer4s is a Library that helps you write to elasticsearch from your scala application. The main purpose is to spare you from writing your own implementation for streaming data to elasticsearch and taking care of switching alias and deleting old indicies. It builds heavily on <a href="https://github.com/sksamuel/elastic4s" target="_blank">elastic4s</a></p> 
  <h4><a href="https://github.com/yannick-cw/elastic-indexer4s#why" aria-hidden="true" class="anchor" id="user-content-why" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Why?</h4> 
  <p>At work we had multiple scala jobs running to write elasticseach indices. These jobs were running on a nightly basis and each one had its own implementation and follow up for switching to the new alias and deleting old indices. So this is a perfect place to generify this task. This library does exactly that for your, write to elasticsearch and afterwards optionally switch the alias to the newly written index and delete old versions of the index. The only thing you have to provide are some settings, an <code>akka.stream.scaladsl.Source[A]</code> and a <code>com.sksamuel.elastic4s.Indexable[A]</code>.</p> 
  <h3><a href="https://github.com/yannick-cw/elastic-indexer4s#getting-started" aria-hidden="true" class="anchor" id="user-content-getting-started" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Getting Started</h3> 
  <p>ElasticIndexer4s is currently available for Scala 2.12, if you need it for scala 2.11 open an issue.</p> 
  <p>To get started with SBT, simply add the following to your <code>build.sbt</code> file:</p> 
  <div class="highlight highlight-source-scala">
   <pre>libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>io.github.yannick-cw<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>elastic_indexer4s_2.12<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>0.2<span class="pl-pds">"</span></span></pre>
  </div> 
  <p>First you need a Configuration:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">com.yannick_cw.elastic_indexer4s.elasticsearch.elasic_config.</span><span class="pl-v">ElasticWriteConfig</span>

<span class="pl-c"><span class="pl-c">//</span> basic configuration, without mapping, settings or analyzers</span>
<span class="pl-c"><span class="pl-c">//</span> will create an index with test_index_&lt;current_date&gt;</span>
<span class="pl-k">val</span> <span class="pl-en">config</span> <span class="pl-k">=</span> <span class="pl-en">ElasticWriteConfig</span>(
    esTargetHosts <span class="pl-k">=</span> <span class="pl-en">List</span>(<span class="pl-s"><span class="pl-pds">"</span>localhost<span class="pl-pds">"</span></span>),
    esTargetPort <span class="pl-k">=</span> <span class="pl-c1">9300</span>,
    esTargetCluster <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>elasticsearch<span class="pl-pds">"</span></span>,
    esTargetIndexPrefix <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>test_index<span class="pl-pds">"</span></span>,
    esTargetType <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>documents<span class="pl-pds">"</span></span>
  )</pre>
  </div> 
  <p>Then you'll need a akka Source of data with an <code>Indexable</code>, in this case using circe to transform to json:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">akka.stream.scaladsl.</span><span class="pl-v">Source</span>
<span class="pl-k">import</span> <span class="pl-v">com.sksamuel.elastic4s.</span><span class="pl-v">Indexable</span>
<span class="pl-k">import</span> <span class="pl-v">io.circe.generic.auto.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">io.circe.syntax.</span><span class="pl-v">_</span>

<span class="pl-k">case</span> <span class="pl-k">class</span> <span class="pl-en">Document</span>(<span class="pl-v">s</span>: <span class="pl-k">String</span>)
<span class="pl-k">object</span> <span class="pl-en">Document</span> {
  <span class="pl-k">implicit</span> <span class="pl-k">val</span> <span class="pl-en">indexable</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Indexable</span>[<span class="pl-en">Document</span>] {
    <span class="pl-k">override</span> <span class="pl-k">def</span> <span class="pl-en">json</span>(<span class="pl-v">t</span>: <span class="pl-en">Document</span>)<span class="pl-k">:</span> <span class="pl-k">String</span> <span class="pl-k">=</span> t.asJson.noSpaces
  }
}

<span class="pl-k">val</span> <span class="pl-en">dummySource</span> <span class="pl-k">=</span> <span class="pl-en">Source</span>.single(<span class="pl-en">Document</span>(<span class="pl-s"><span class="pl-pds">"</span>testDoc<span class="pl-pds">"</span></span>))</pre>
  </div> 
  <p>In the last step you connect the Source and run the Indexer with optional steps:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">com.yannick_cw.elastic_indexer4s.</span><span class="pl-v">ElasticIndexer4s</span>

 <span class="pl-k">val</span> <span class="pl-en">runResult</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-en">Either</span>[<span class="pl-en">IndexError</span>, <span class="pl-en">RunResult</span>]] <span class="pl-k">=</span> <span class="pl-en">ElasticIndexer4s</span>(config)
    .from(dummySource)
    .switchAliasFrom(alias <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>alias<span class="pl-pds">"</span></span>, minT <span class="pl-k">=</span> <span class="pl-c1">0.95</span>, maxT <span class="pl-k">=</span> <span class="pl-c1">1.25</span>)
    .deleteOldIndices(keep <span class="pl-k">=</span> <span class="pl-c1">2</span>, aliasProtection <span class="pl-k">=</span> <span class="pl-c1">true</span>)
    .run</pre>
  </div> 
  <p>Your result will either be a <code>RunResult</code> if all went fine or an <code>IndexError</code>, with detailed information on what steps succeeded and what failed. The switching and deleting are optional.</p> 
  <h3><a href="https://github.com/yannick-cw/elastic-indexer4s#more-information" aria-hidden="true" class="anchor" id="user-content-more-information" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>More Information</h3> 
  <h4><a href="https://github.com/yannick-cw/elastic-indexer4s#possible-configuration" aria-hidden="true" class="anchor" id="user-content-possible-configuration" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Possible configuration</h4> 
  <table> 
   <thead> 
    <tr> 
     <th>config name</th> 
     <th>meaning</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td><code>hosts: List[String]</code></td> 
     <td>all elasticsearch nodes to connec to</td> 
    </tr> 
    <tr> 
     <td><code>port: Int</code></td> 
     <td>the port of the nodes open to tcp traffic, usually 9300</td> 
    </tr> 
    <tr> 
     <td><code>cluster: String</code></td> 
     <td>the name of the elasticsearch cluster</td> 
    </tr> 
    <tr> 
     <td><code>indexPrefix: String</code></td> 
     <td>the prefix that will be used in the index name, a date will be added</td> 
    </tr> 
    <tr> 
     <td><code>docType: String</code></td> 
     <td>name for the type of documents to be writte to elasticsearch, will be used as elasticsearch <code>type</code></td> 
    </tr> 
    <tr> 
     <td><code>mappingSetting: MappingSetting</code></td> 
     <td>all mappings and settings, see below for more details</td> 
    </tr> 
    <tr> 
     <td><code>writeBatchSize: Int</code></td> 
     <td>the number of documents written in one batch, default to 50</td> 
    </tr> 
    <tr> 
     <td><code>writeConcurrentRequest: Int</code></td> 
     <td>the number of parallel request to elasticsearch, defaults to 10</td> 
    </tr> 
    <tr> 
     <td><code>writeMaxAttempts: Int</code></td> 
     <td>the retry attempts to write before failure, defaults to 5</td> 
    </tr> 
    <tr> 
     <td><code>logWriteSpeedEvery: FiniteDuration</code></td> 
     <td>the time interval in which it is logged how many documents were written, defaults to a minute</td> 
    </tr> 
    <tr> 
     <td><code>waitForElasticTimeout: FiniteDuratio</code></td> 
     <td>time to wait to count the documents before switching alias, default to 5 seconds</td> 
    </tr>
   </tbody>
  </table> 
  <p>The <code>MappingSetting</code> can be passed to specify mappings and settings for the index. You can either pass a</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">case</span> <span class="pl-k">class</span> <span class="pl-en">TypedMappingSetting</span>(
  <span class="pl-v">analyzer</span>: <span class="pl-en">List</span>[<span class="pl-en">AnalyzerDefinition</span>] <span class="pl-k">=</span> <span class="pl-en">List</span>.empty,
  <span class="pl-v">mappings</span>: <span class="pl-en">List</span>[<span class="pl-en">MappingDefinition</span>] <span class="pl-k">=</span> <span class="pl-en">List</span>.empty,
  <span class="pl-v">shards</span>: <span class="pl-en">Option</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> <span class="pl-c1">None</span>,
  <span class="pl-v">replicas</span>: <span class="pl-en">Option</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> <span class="pl-c1">None</span>
)</pre>
  </div> 
  <p>with analyzers and mappings defined in elastic4s syntax or pass a</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-en">StringMappingSetting</span>.unsafeString(<span class="pl-v">source</span>: <span class="pl-k">String</span>)<span class="pl-k">:</span> <span class="pl-en">Either</span>[<span class="pl-en">ParsingFailure</span>, <span class="pl-en">MappingSetting</span>]</pre>
  </div> 
  <p>which gives you a <code>parsingFailure</code> on creation if the string can't be parsed to json.</p> 
  <p>The <code>.from([source])</code> method requires you to give an <code>Indexable</code> for the elements to be indexed. Alternatively you can use <code>.fromBuilder</code>, if you want to give an implicit <code>RequestBuilder</code>. This allows for more configuration for the indexing, e.g. you can specify which <code>id</code> or which <code>timestamp</code> to use.</p> 
  <h4><a href="https://github.com/yannick-cw/elastic-indexer4s#alias-switching" aria-hidden="true" class="anchor" id="user-content-alias-switching" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Alias switching</h4> 
  <p>You can add the <code>.switchAliasFrom</code> step to the process of writing, if you want to switch an alias from an old index to the newly written one. If no old index with this alias was found, the new index gets the alias without switching. There are three parameters you can pass to</p> 
  <div class="highlight highlight-source-scala">
   <pre>.switchAliasFrom(alias <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>alias<span class="pl-pds">"</span></span>, minT <span class="pl-k">=</span> <span class="pl-c1">0.95</span>, maxT <span class="pl-k">=</span> <span class="pl-c1">1.25</span>)</pre>
  </div> 
  <p>The <code>alias</code> to switch from and add to the new index, a <code>minT</code> threshold defining how many percent of the old index the new index must have as document count and the <code>maxT</code> defining how many more documents the new index is allowed to have to allow switching.</p> 
  <h4><a href="https://github.com/yannick-cw/elastic-indexer4s#index-deletion" aria-hidden="true" class="anchor" id="user-content-index-deletion" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Index deletion</h4> 
  <p>Another optional step is <code>.deleteOldIndices</code> which allows you to clean up old indices. It has two paramters</p> 
  <div class="highlight highlight-source-scala">
   <pre>.deleteOldIndices(keep <span class="pl-k">=</span> <span class="pl-c1">2</span>, aliasProtection <span class="pl-k">=</span> <span class="pl-c1">true</span>)</pre>
  </div> 
  <p>where <code>keep</code> defines how many indices with the defined <code>indexPrefix</code> are left in the cluster and with <code>aliasProtection</code>, which, if set to <code>true</code>, does not allow deletion of any index with and alias set.</p> 
  <h4><a href="https://github.com/yannick-cw/elastic-indexer4s#akka-stream" aria-hidden="true" class="anchor" id="user-content-akka-stream" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Akka Stream</h4> 
  <p>For writing the stream to elasticsearch a <code>system</code> and <code>materializer</code> are needed. You can either pass them in to the <code>ElasticIndexer4s</code> or you can let ElasticIndexer4s create its own system. Additionally you can pass in a <code>Decider</code> before starting to write, to control what happens on failure in the stream.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-en">ElasticIndexer4s</span>(config)
    .withDecider(decider)  
    .from(dummySource)</pre>
  </div> 
 </article>
</div>