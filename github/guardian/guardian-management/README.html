<div class="announce instapaper_body md" data-path="readme.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-guardian-management" class="anchor" href="https://github.com/guardian/guardian-management#guardian-management" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Guardian Management</h1> 
  <p><a href="https://maven-badges.herokuapp.com/maven-central/com.gu/management_2.12" target="_blank"><img src="https://camo.githubusercontent.com/d92a6b248cc3ad847dcc09f0070551e806079a8f/68747470733a2f2f6d6176656e2d6261646765732e6865726f6b756170702e636f6d2f6d6176656e2d63656e7472616c2f636f6d2e67752f6d616e6167656d656e745f322e31322f62616467652e737667" alt="Maven Central" data-canonical-src="https://maven-badges.herokuapp.com/maven-central/com.gu/management_2.12/badge.svg" style="max-width:100%;"></a></p> 
  <p>In order to simplify their management, Guardian web-apps should conform to our [web applications specification] (<a href="https://docs.google.com/document/d/12ckZC0fGtilntcsJy6mBUylvohLoxUKjkwGDaur-pE8/edit" target="_blank">https://docs.google.com/document/d/12ckZC0fGtilntcsJy6mBUylvohLoxUKjkwGDaur-pE8/edit</a>). This library provides standard management pages and makes it easy to create new app-specific ones in order to fulfill those criteria.</p> 
  <p>The library is intended to be web framework agnostic and currently has support for anything using the servlet API, the Play framework (provided in <a href="https://github.com/guardian/guardian-management-play" target="_blank">guardian-management-play</a>) and as a standalone internal server running on a separate port. A small adapter library for the request and response abstractions, blatantly inspired by/ripped off from <a href="http://www.liftweb.net" target="_blank">lift</a>, needs to be added to support other frameworks.</p> 
  <h1><a id="user-content-getting-started-servlet-api" class="anchor" href="https://github.com/guardian/guardian-management#getting-started-servlet-api" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Getting Started (Servlet API)</h1> 
  <h2><a id="user-content-add-the-dependency-to-your-build" class="anchor" href="https://github.com/guardian/guardian-management#add-the-dependency-to-your-build" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Add the dependency to your build</h2> 
  <p>In your build.sbt:</p> 
  <pre><code>libraryDependencies += "com.gu" %% "management-servlet-api" % "5.37"
</code></pre> 
  <p>It's published for Scala <code>2.11</code> and <code>2.12</code> to maven-central.</p> 
  <h2><a id="user-content-add-the-management-filter-to-your-webxml" class="anchor" href="https://github.com/guardian/guardian-management#add-the-management-filter-to-your-webxml" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Add the management filter to your web.xml</h2> 
  <p>To avoid any conflict with your choice of web framework, the managment pages are implemented as a filter. So, for example:</p> 
  <pre><code>&lt;!DOCTYPE web-app PUBLIC
        "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
        "http://java.sun.com/dtd/web-app_2_3.dtd" &gt;

&lt;web-app&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;managementFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;com.gu.management.example.MyAppManagementFilter&lt;/filter-class&gt;
    &lt;/filter&gt;

    &lt;filter-mapping&gt;
        &lt;filter-name&gt;managementFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/management/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;

&lt;/web-app&gt;
</code></pre> 
  <p>The filter-class is a class that you are going to implement.</p> 
  <h2><a id="user-content-implement-the-filter-class" class="anchor" href="https://github.com/guardian/guardian-management#implement-the-filter-class" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Implement the filter class</h2> 
  <p>Your filter class should derive from <code>com.gu.management.ManagementFilter</code> and implement the pages member and have a UserProvider:</p> 
  <pre><code>class MyAppManagementFilter extends ManagementFilter {
  val applicationName = "My Application Name"
  val userProvider = new UserProvider {
    def realm = "My App"
    def isValid(credentials: UserCredentials) = credentials.password == "letmein"
  }
  lazy val pages =
    new DummyPage() ::
    new ManifestPage() ::
    new Switchboard(applicationName, Switches.all) ::
    new StatusPage(applicationName, TimingMetrics.all) ::
    Nil
}
</code></pre> 
  <p>Even for mostly java projects, you'll need to write your management pages in scala. However, things like timing metrics and switches have a java-friendly interface and are usable from java.</p> 
  <p>The UserProvider is responsible for deciding whether an authenticated page can be viewed. The Switchboard and Logback pages are authenticated by default and any management page which can change the state of the system or reveal confidential information should be protected.</p> 
  <p>If you want to store a username and password in configuration and you are using Guardian Configuration, a sample provider would be:</p> 
  <pre><code>val userProvider = new UserProvider {
    def realm = "Content-Api"
    def isValid(credentials: UserCredentials) =
      credentials.username == ContentApiConfiguration.configuration.getStringProperty("management.username") &amp;&amp;
      credentials.password == ContentApiConfiguration.configuration.getStringProperty("management.password")
}
</code></pre> 
  <h2><a id="user-content-look-at-the-example" class="anchor" href="https://github.com/guardian/guardian-management#look-at-the-example" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Look at the example!</h2> 
  <p>The <a href="https://github.com/guardian/guardian-management/tree/master/example-servlet-api" target="_blank">example project</a> has a filter set up and uses some switches and timing metrics from both scala and java.</p> 
  <pre><code>$ git clone git@github.com:guardian/guardian-management.git
$ cd guardian-management
$ ./sbt010
&gt; project example-servlet-api
&gt; container:start
</code></pre> 
  <p>Try the following URLs locally:</p> 
  <ul> 
   <li><a href="http://localhost:8080/java-app" target="_blank">http://localhost:8080/java-app</a></li> 
   <li><a href="http://localhost:8080/scala-app" target="_blank">http://localhost:8080/scala-app</a></li> 
   <li><a href="http://localhost:8080/management" target="_blank">http://localhost:8080/management</a></li> 
   <li><a href="http://localhost:8080/management/switchboard" target="_blank">http://localhost:8080/management/switchboard</a></li> 
  </ul> 
  <p>Also, enable the <code>take-it-down</code> switch and retry <code>/scala-app</code> and <code>/java-app</code>.</p> 
  <p>The application also has very simple custom management page, but the best thing to do if you want to write your own management pages is to look at how the pre-defined ones are implemented: a simple readonly page to look at is the <a href="https://github.com/guardian/guardian-management/blob/master/management/src/main/scala/com/gu/management/StatusPage.scala" target="_blank">status page</a>, and a more complex page that supports POSTs is <a href="https://github.com/guardian/guardian-management/blob/master/management/src/main/scala/com/gu/management/switchables.scala" target="_blank">the switchboard</a>.</p> 
  <h1><a id="user-content-getting-started-standalone" class="anchor" href="https://github.com/guardian/guardian-management#getting-started-standalone" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Getting started (standalone)</h1> 
  <p>The management-internal shim allows the management libraries to run separate of any container or framework, on a second port, making use of an internally implemented HTTP server.</p> 
  <p>The library will use the first port that it can bind to from 18080 to 18099 and, if permissions allow it will write a file out to /var/run/ports/.port containing the number of the port that it has bound to.</p> 
  <h2><a id="user-content-add-the-dependency-to-your-build-1" class="anchor" href="https://github.com/guardian/guardian-management#add-the-dependency-to-your-build-1" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Add the dependency to your build</h2> 
  <p>In your build.sbt for sbt 0.10:</p> 
  <pre><code>resolvers += "Guardian Github Snapshots" at "http://guardian.github.com/maven/repo-releases"
libraryDependencies += "com.gu" %% "management-internal" % "5.21"
</code></pre> 
  <h2><a id="user-content-implement-a-handler" class="anchor" href="https://github.com/guardian/guardian-management#implement-a-handler" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Implement a handler</h2> 
  <p>Implement the ManagementHandler variable applicationName and pages. The latter should contain the list of pages for your application - see above.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">handler</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">ManagementHandler</span> {
    <span class="pl-k">val</span> <span class="pl-en">applicationName</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>my-application-name<span class="pl-pds">"</span></span>
    <span class="pl-k">def</span> <span class="pl-en">pages</span> <span class="pl-k">=</span> <span class="pl-en">List</span>(
        <span class="pl-k">new</span> <span class="pl-en">ManifestPage</span>(),
        <span class="pl-k">new</span> <span class="pl-en">Switchboard</span>(applicationName, <span class="pl-en">Switches</span>.all),
        <span class="pl-k">new</span> <span class="pl-en">StatusPage</span>(applicationName,<span class="pl-en">TimingMetrics</span>.all)
    )
}</pre>
  </div> 
  <h2><a id="user-content-start-and-stop-the-internal-server" class="anchor" href="https://github.com/guardian/guardian-management#start-and-stop-the-internal-server" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Start and stop the internal server</h2> 
  <p>You should call ManagementServer.start and ManagementServer.shutdown at appropriate points in your application.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> bind the port and try to write the port number out to file</span>
<span class="pl-en">ManagementServer</span>.start(handler)</pre>
  </div> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> shutdown to unregister the port binding properly</span>
<span class="pl-en">ManagementServer</span>.shutdown()</pre>
  </div> 
  <h1><a id="user-content-providing-metrics-for-ganglia" class="anchor" href="https://github.com/guardian/guardian-management#providing-metrics-for-ganglia" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Providing metrics for GANGLIA</h1> 
  <p>Since version 5, guardian-management has been designed to allow application to simply provide metrics for consumption by the <a href="http://ganglia.sourceforge.net/" target="_blank">Ganglia monitoring system</a>.</p> 
  <ul> 
   <li>Metrics are presented by a StatusPage object, the name of which should be the name of your app:</li> 
  </ul> 
  <p><code>new StatusPage("My App Name", Metrics.....)</code></p> 
  <p>So for example identity has 2 status pages:</p> 
  <p><code>new StatusPage("identity-webapp", Metrics.....)</code> <code>new StatusPage("identity-api", Metrics.....)</code></p> 
  <ul> 
   <li> <p>There are three types of metric currently supported:</p> 
    <ul> 
     <li>Timing: standard timing metric, takes number of events over a time period. Also provides a count of those events.</li> 
     <li>Count: Constantly incrementing counter.</li> 
     <li>Gauge: Count at a particular point in time.</li> 
    </ul> </li> 
   <li> <p>Creating A Metric</p> </li> 
  </ul> 
  <p>You need to provide four arguments, with an optional fifth.</p> 
  <p><code>new TimingMetic("group", "name", "title", "description")</code></p> 
  <pre><code>GROUP: this is used as a logical grouping. Think of it as a noun. For example "emails"
NAME: This is a verb related to the noun defined in group. For example "sent"
TITLE: This is a text string used to title the graphs. Keep it short. For example "Emails Sent"
DESCRIPTION: This is a longer description of the metric. Used on the hover over.
For example "Total number of emails sent"
</code></pre> 
  <p>Group and Name are munged together in ganglia to give the actual name used on the console. There is another console in Graphite (graphing tool) which will allow subdivision on group. Allowing you to see all the "emails" metrics and to create mash ups of all of these. Using the groups as it's top level option.</p> 
  <p>As a rule use underscores (_) not hyphens (-) as delimiters.</p> 
  <p>So in scala:</p> 
  <p><code>object SuccessfulEmails extends CountMetric("emails", "sent", "Emails Sent", "Number of emails sent")</code></p> 
  <p>The fifth metric is the field master. This takes Option[Metric] with a default of None. This is used to indicate that the metric you are creating is a child of a another metric. The parameter is the metric you wish to be a child of</p> 
  <p>For example. Imagine there is a time taken for a request metric:</p> 
  <p><code>object Requests extends TimingMetric("requests", "api", "Api Requests Timer", "Total number and time taken for API request")</code></p> 
  <p>You may have a mongoDB requests metric, which is a child of the overall HTTP request:</p> 
  <p><code>object MongoRequests extends TimingMetric("requests", "mongodb", "Mongodb Requests", "Mongo request timer", Some(Requests))</code></p> 
  <p>This allows Ganglia to give the proportion of time of the HTTP request taken talking to mongo. You could have another:</p> 
  <p><code>object MongoRequests extends TimingMetric("requests", "oracle", "Oracle Requests", "Oracle request timer", Some(Requests))</code></p> 
  <p>Ganglia would now be able to show you propertions of each DB request as a proportion of total HTTP time.</p> 
 </article>
</div>