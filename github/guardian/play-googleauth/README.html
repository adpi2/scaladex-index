<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-play-google-auth-module" class="anchor" href="https://github.com/guardian/play-googleauth#play-google-auth-module" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Play Google Auth Module</h1> 
  <p>This module is a very simple implementation of OpenID Connect authentication for Play 2 applications. It can also be used to get information about the groups of your Google Apps Domain using the Directory API.</p> 
  <h2><a id="user-content-versions" class="anchor" href="https://github.com/guardian/play-googleauth#versions" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Versions</h2> 
  <p>For Play 2.5.x use version <a href="https://maven-badges.herokuapp.com/maven-central/com.gu/play-googleauth_2.11" target="_blank"><img src="https://camo.githubusercontent.com/f9a5f8c40b5f04da18e202044ba055cddc68141a/68747470733a2f2f6d6176656e2d6261646765732e6865726f6b756170702e636f6d2f6d6176656e2d63656e7472616c2f636f6d2e67752f706c61792d676f6f676c65617574685f322e31312f62616467652e737667" alt="Maven Central" data-canonical-src="https://maven-badges.herokuapp.com/maven-central/com.gu/play-googleauth_2.11/badge.svg" style="max-width:100%;"></a>:</p> 
  <pre><code>libraryDependencies += "com.gu" %% "play-googleauth" % "0.6.0"
</code></pre> 
  <p>This version has a dependancy on <code>cats 0.8.*</code>. Therefore, (for compatibility) it is advised your project or any of its dependendancies do not depend on <code>cats 0.7.*</code> or below.</p> 
  <p>For Play 2.4.x use version 0.3.x (<code>play-2.4.x</code> branch)</p> 
  <pre><code>libraryDependencies += "com.gu" %% "play-googleauth" % "0.3.7"
</code></pre> 
  <p>For Play 2.3.x use version 0.2.x (<code>play-2.3.x</code> branch):</p> 
  <pre><code>libraryDependencies += "com.gu" %% "play-googleauth" % "0.2.2"
</code></pre> 
  <h2><a id="user-content-adding-to-your-application" class="anchor" href="https://github.com/guardian/play-googleauth#adding-to-your-application" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Adding to your application</h2> 
  <p>In order to add Google authentication to your Play app you must:</p> 
  <ul> 
   <li>get a set of API credentials for your app from the <a href="https://console.developers.google.com" target="_blank">Google Developer Console</a></li> 
   <li>ensure that you have switched on access to the <code>Google+ API</code> for your credentials</li> 
   <li>add play-googleauth to your libraryDependencies</li> 
   <li>create a GoogleAuthConfig instance with your API credentials and callback details (the callback must match both your app and the value you set in the developer console)</li> 
   <li>implement a login controller that has actions and routes for the login action, oauth callback, logout and a login screen (if required)</li> 
   <li>implement a trait that extends com.gu.googleauth.Actions, sets the appropriate redirect targets and provides an <code>authConfig</code> from your Google credentials</li> 
   <li>(optionally) configure a Google Group Checker to enforce Google Group membership</li> 
   <li>use <code>AuthAction</code> instead of <code>Action</code> to wrap actions in your controllers (these should be made available by extending the trait you implemented earlier</li> 
  </ul> 
  <p>See the <a href="https://github.com/guardian/play-googleauth/tree/master/example" target="_blank">example</a> application to see how this is done.</p> 
  <h2><a id="user-content-caveats" class="anchor" href="https://github.com/guardian/play-googleauth#caveats" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Caveats</h2> 
  <p>If your login expires and the next request you make is a GET method then your login will be transparently revalidated, but if your next request is a POST method then it is not possible to sensibly redirect the request and you will end up being redirected to the correct URL but with a GET request.</p> 
  <p>AJAX requests will similarly not be re-validated. Two options exist - you can turn off re-validation using the <code>enforceValidity</code> parameter in <code>GoogleAuthConfig</code> or implement a specific ApiAuth endpoint that returns a 419 if your session is no longer valid. This can then be used to implement client side logic in an invisible iframe to re-auth.</p> 
  <p>This module brings in Apache Commons 1.9 which is later than the version Play requires by default. This is usually fine as it is compatible.</p> 
  <p>The token acquired from Google is <strong>NOT</strong> cryptographically verified. This is not a problem as it is obtained directly from Google over an SSL connection, used to authenticate the user and then thrown away. Do not keep the token around and use it elsewhere unless this code is modified to carry out the verification.</p> 
  <h2><a id="user-content-implement-googlegroups-based-access-control-using-the-directory-api" class="anchor" href="https://github.com/guardian/play-googleauth#implement-googlegroups-based-access-control-using-the-directory-api" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Implement GoogleGroups-based access control using the <a href="https://developers.google.com/admin-sdk/directory/" target="_blank">Directory API</a></h2> 
  <p>You can use the library to check that a user of your domain (e.g. guardian.co.uk) belongs to certain Google Groups. This is convenient to create an authorisation system in which only people who are members of some groups can access your application.</p> 
  <p>In order to be able to use the Directory API, you must first set up your own Service account and make sure it has the right permissions.</p> 
  <p>First, log in to your <a href="https://console.developers.google.com/" target="_blank">Google Developer Console</a>, go to your project and create a new service account. Follow the instructions given <a href="https://developers.google.com/identity/protocols/OAuth2ServiceAccount" target="_blank">here</a> to create a service account. When asked to download the public/private key pair, choose the JSON option and keep it in a secure place.</p> 
  <p>You will then need to contact the administrator of your organisation's Google Apps domain and ask them to authorise your service account to access user data in the Google Apps Domain.</p> 
  <p>They will need to do so by adding specific <a href="https://developers.google.com/admin-sdk/directory/v1/guides/authorizing" target="_blank">scopes</a> to the service account. This is done by granting the <em>clientId</em> of the service account with access to the required API scopes.</p> 
  <p>In order to find out which groups the users of your domain belong to, the only scope you will need is <em><a href="https://www.googleapis.com/auth/admin.directory.group.readonly" target="_blank">https://www.googleapis.com/auth/admin.directory.group.readonly</a></em></p> 
  <p>Finally, you need the email address of a user who has the permission to access the Admin APIs. It is not enough to be able to authenticate to your domain with a client ID and private key, you also need to specify the email address of one of the organisation's admin users. This email address should be set up to have specific privileges to read groups. We call this user the "impersonated user".</p> 
  <p>As explained in the Google documentation about <a href="https://developers.google.com/admin-sdk/directory/v1/guides/delegation" target="_blank">Domain-Wide delegation of authority</a>:</p> 
  <blockquote> 
   <p>Only users with access to the Admin APIs can access the Admin SDK Directory API, therefore your service account needs to impersonate one of those users to access the Admin SDK Directory API.</p> 
  </blockquote> 
  <p>Ask the administrator of your organisation's Google Apps domain if you are unsure of what this email address is supposed to be.</p> 
  <p>Once you have completed those 3 steps, you should be able to integrate it in your application:</p> 
  <ul> 
   <li> <p>Make sure that the service account certificate is accessible</p> </li> 
   <li> <p>This is how you can build your credentials from the json cert file you have downloaded:</p> </li> 
  </ul> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">java.io.</span><span class="pl-v">FileInputStream</span>

<span class="pl-k">import</span> <span class="pl-v">com.google.api.client.googleapis.auth.oauth2.</span><span class="pl-v">GoogleCredential</span>
<span class="pl-k">import</span> <span class="pl-v">com.gu.googleauth.</span><span class="pl-v">GoogleServiceAccount</span>

<span class="pl-k">object</span> <span class="pl-en">GoogleAuthConf</span> {
  <span class="pl-k">val</span> <span class="pl-en">impersonatedUser</span> <span class="pl-k">=</span> <span class="pl-k">???</span> <span class="pl-c"><span class="pl-c">//</span> read from config</span>
}

<span class="pl-k">private</span> <span class="pl-k">lazy</span> <span class="pl-k">val</span> <span class="pl-en">credentials</span><span class="pl-k">:</span> <span class="pl-en">GoogleCredential</span> <span class="pl-k">=</span> {
  <span class="pl-k">val</span> <span class="pl-en">fileInputStream</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">FileInputStream</span>(<span class="pl-s"><span class="pl-pds">"</span>/path/to/your-service-account-cert.json<span class="pl-pds">"</span></span>)
  <span class="pl-en">GoogleCredential</span>.fromStream(fileInputStream)
}

<span class="pl-k">private</span> <span class="pl-k">val</span> <span class="pl-en">serviceAccount</span> <span class="pl-k">=</span> <span class="pl-en">GoogleServiceAccount</span>(
  credentials.getServiceAccountId, <span class="pl-c"><span class="pl-c">//</span> This should contain the *email address* that is associated with your service account</span>
  credentials.getServiceAccountPrivateKey, <span class="pl-c"><span class="pl-c">//</span> This should contain the *private key* that is associated with your service account</span>
  <span class="pl-en">GoogleAuthConf</span>.impersonatedUser <span class="pl-c"><span class="pl-c">//</span> This is the admin user email address we mentioned earlier</span>
)</pre>
  </div> 
  <ul> 
   <li>You should now be able to retrieve the groups for a given user</li> 
  </ul> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">com.gu.googleauth.</span><span class="pl-v">GoogleGroupChecker</span>

<span class="pl-k">val</span> <span class="pl-en">checker</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">GoogleGroupChecker</span>(serviceAccount)
checker.retrieveGroupsFor(email)</pre>
  </div> 
 </article>
</div>