<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <p>#&nbsp;mongodb-auto-discovery</p> 
  <p><a href="https://travis-ci.org/guardian/mongodb-auto-discovery" target="_blank"><img src="https://camo.githubusercontent.com/fabffe02222f6c65ac0b9c2d61053985b2be52e2/68747470733a2f2f7472617669732d63692e6f72672f677561726469616e2f6d6f6e676f64622d6175746f2d646973636f766572792e7376673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/guardian/mongodb-auto-discovery.svg?branch=master" style="max-width:100%;"></a></p> 
  <p><a href="https://search.maven.org/#search%7Cgav%7C1%7Cg%3A%22com.gu%22%20AND%20a%3A%22mongodb-auto-discovery_2.11%22" target="_blank">Releases at Maven Central</a></p> 
  <p>##&nbsp;Motivation</p> 
  <p>Auto-discover your MongoDB instances in AWS and generate connection configuration during run-time.</p> 
  <p>Reserving private IP addresses in an AWS VPC is tricky and relying on a privately hosted Route 53 is a bit of a pain. By using instance tags we can instead auto-discover which hosts that are designated to run MongoDB and generate the configuration using that.</p> 
  <h2><a href="https://github.com/guardian/mongodb-auto-discovery#using-the-library" aria-hidden="true" class="anchor" id="user-content-using-the-library" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using the library</h2> 
  <p>###&nbsp;Add it as a dependency in <code>build.sbt</code></p> 
  <pre><code>libraryDependencies += "com.gu" %% "mongodb-auto-discovery" % "1.6"
</code></pre> 
  <h3><a href="https://github.com/guardian/mongodb-auto-discovery#make-sure-your-instances-have-the-right-permissions" aria-hidden="true" class="anchor" id="user-content-make-sure-your-instances-have-the-right-permissions" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Make sure your instances have the right permissions</h3> 
  <p>Your EC2 instances need to be able to read EC2 meta-data in order to find the MongoDB servers. The easiest way to set this up is to grant the following permissions to the instances in your stack(s) as part of your CloudFormation:</p> 
  <pre><code>{
  "Effect": "Allow",
  "Action": "ec2:Describe*",
  "Resource": "*"
}
</code></pre> 
  <p>###&nbsp;Example using the Play framework</p> 
  <pre><code>import com.gu.aws.{EC2, EC2DiscoveryService}
import com.gu.mongodb.AutoDiscovery
import play.api.Play
import play.api.Play.current

object MongoConfig {

  val mongoAutoDiscovery = new AutoDiscovery(EC2DiscoveryService, EC2)

  def uri: String = {
    Play.configuration.getString("mongodb.uri") match {
      case Some(uriFromConfig) =&gt; uriFromConfig
      case _ =&gt; {
        val uri = for {
          username &lt;- Play.configuration.getString("mongodb.username")
          password &lt;- Play.configuration.getString("mongodb.password")
          database &lt;- Play.configuration.getString("mongodb.database")
        } yield mongoAutoDiscovery.mongoUri(username, password, database, Config.stage, Config.stack)
        uri.getOrElse(throw new RuntimeException("Could not construct Mongo URI. Missing mongodb.username, mongodb.password or mongodb.database.")).toString
      }
    }
  }

}
</code></pre> 
 </article>
</div>