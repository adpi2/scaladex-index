<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-kafka-message-queue" class="anchor" href="https://github.com/softwaremill/kmq#kafka-message-queue" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Kafka Message Queue</h1> 
  <p><a href="https://gitter.im/softwaremill/kmq?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" target="_blank"><img src="https://camo.githubusercontent.com/772cfae209182f789c830dd0e33d178ee63a4ece/68747470733a2f2f6261646765732e6769747465722e696d2f736f6674776172656d696c6c2f6b6d712e737667" alt="Join the chat at https://gitter.im/softwaremill/kmq" data-canonical-src="https://badges.gitter.im/softwaremill/kmq.svg" style="max-width:100%;"></a> <a href="https://maven-badges.herokuapp.com/maven-central/com.softwaremill.kmq/core_2.12" target="_blank"><img src="https://camo.githubusercontent.com/43e916d59b436a4b4024fbe0568578ecae5e920f/68747470733a2f2f6d6176656e2d6261646765732e6865726f6b756170702e636f6d2f6d6176656e2d63656e7472616c2f636f6d2e736f6674776172656d696c6c2e6b6d712f636f72655f322e31322f62616467652e737667" alt="Maven Central" data-canonical-src="https://maven-badges.herokuapp.com/maven-central/com.softwaremill.kmq/core_2.12/badge.svg" style="max-width:100%;"></a></p> 
  <p>Using <code>kmq</code> you can acknowledge processing of individual messages in Kafka, and have unacknowledged messages re-delivered after a timeout.</p> 
  <p>This is in contrast to the usual Kafka offset-committing mechanism, using which you can acknowledge all messages up to a given offset only.</p> 
  <p>If you are familiar with <a href="https://aws.amazon.com/sqs/" target="_blank">Amazon SQS</a>, <code>kmq</code> implements a similar message processing model.</p> 
  <h1><a id="user-content-how-does-this-work" class="anchor" href="https://github.com/softwaremill/kmq#how-does-this-work" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>How does this work?</h1> 
  <p>For a more in-depth overview see the blog: <a href="https://softwaremill.com/using-kafka-as-a-message-queue/" target="_blank">Using Kafka as a message queue</a>, and for performance benchmarks: <a href="https://softwaremill.com/kafka-with-selective-acknowledgments-performance/" target="_blank">Kafka with selective acknowledgments (kmq) performance &amp; latency benchmark</a></p> 
  <p>The acknowledgment mechanism uses a <code>marker</code> topic, which should have the same number of partitions as the "main" data topic (called the <code>queue</code> topic). The marker topic is used to track which messages have been processed, by writing start/end markers for every message.</p> 
  <p><a href="https://camo.githubusercontent.com/8a9db9040ff46c6d03c0fe43cb559641a78e95fc/68747470733a2f2f736f6674776172656d696c6c2e636f6d2f696d616765732f75706c6f6164732f323031372f30322f6b6d712e39336638343263662e706e67" target="_blank"><img src="https://camo.githubusercontent.com/8a9db9040ff46c6d03c0fe43cb559641a78e95fc/68747470733a2f2f736f6674776172656d696c6c2e636f6d2f696d616765732f75706c6f6164732f323031372f30322f6b6d712e39336638343263662e706e67" alt="message flow diagram" data-canonical-src="https://softwaremill.com/images/uploads/2017/02/kmq.93f842cf.png" style="max-width:100%;"></a></p> 
  <h1><a id="user-content-using-kmq" class="anchor" href="https://github.com/softwaremill/kmq#using-kmq" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using kmq</h1> 
  <p>An application using <code>kmq</code> should consist of the following components:</p> 
  <ul> 
   <li>a number of <code>RedeliveryTracker</code>s. This components consumes the <code>marker</code> topic and redelivers messages if appropriate. Multiple copies should be started in a cluster for fail-over. Uses automatic partition assignment.</li> 
   <li>components which send data to the <code>queue</code> topic to be processed</li> 
   <li>queue clients, either custom or using the <code>KmqClient</code></li> 
  </ul> 
  <h1><a id="user-content-mavensbt-dependency" class="anchor" href="https://github.com/softwaremill/kmq#mavensbt-dependency" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Maven/SBT dependency</h1> 
  <p>SBT:</p> 
  <pre><code>"com.softwaremill.kmq" %% "core" % "0.2"
</code></pre> 
  <p>Maven:</p> 
  <pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.softwaremill.kmq&lt;/groupId&gt;
    &lt;artifactId&gt;core_2.12&lt;/artifactId&gt;
    &lt;version&gt;0.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre> 
  <p>(Use <code>core_2.11</code> if you are using other components depending on Scala 2.11.)</p> 
  <h1><a id="user-content-client-flow" class="anchor" href="https://github.com/softwaremill/kmq#client-flow" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Client flow</h1> 
  <p>The flow of processing a message is as follow:</p> 
  <ol> 
   <li>read messages from the <code>queue</code> topic, in batches</li> 
   <li>write a <code>start</code> marker to the <code>markers</code> topic for each message, wait until the markers are written</li> 
   <li>commit the biggest message offset to the <code>queue</code> topic</li> 
   <li>process messages</li> 
   <li>for each message, write an <code>end</code> marker. No need to wait until the markers are written.</li> 
  </ol> 
  <p>This ensures at-least-once processing of each message. Note that the acknowledgment of each message (writing the <code>end</code> marker) can be done for each message separately, out-of-order, from a different thread, server or application.</p> 
  <h1><a id="user-content-example-code" class="anchor" href="https://github.com/softwaremill/kmq#example-code" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Example code</h1> 
  <p>There are three example applications:</p> 
  <ul> 
   <li><code>example-java/embedded</code>: a single java application that starts all three components (sender, client, redelivery tracker)</li> 
   <li><code>example-java/standalone</code>: three separate runnable classes to start the different components</li> 
   <li><code>example-scala</code>: an implementation of the client using <a href="https://github.com/akka/reactive-kafka" target="_blank">reactive-kafka</a></li> 
  </ul> 
  <h1><a id="user-content-time--timestamps" class="anchor" href="https://github.com/softwaremill/kmq#time--timestamps" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Time &amp; timestamps</h1> 
  <p>How time is handled is crucial for message redelivery, as messages are redelivered after a given amount of time passes since the <code>start</code> marker was sent.</p> 
  <p>To track what was sent when, <code>kmq</code> uses Kafka's message timestamp. By default this is messages create time (<code>message.timestamp.type=CreateTime</code>), but for the <code>markers</code> topic, it is advisable to switch this to <code>LogAppendTime</code>. That way, the timestamps more closely reflect when the markers are really written to the log, and are guaranteed to be monotonic in each partition (which is important for redelivery - see below).</p> 
  <p>To calculate which messages should be redelivered, we need to know the value of "now", to check which <code>start</code> markers have been sent later than the configured timeout. When a marker has been received from a partition recently, the maximum such timestamp is used as the value of "now" - as it indicates exactly how far we are in processing the partition. What "recently" means depends on the <code>useNowForRedeliverDespiteNoMarkerSeenForMs</code> config setting. Otherwise, the current system time is used, as we assume that all markers from the partition have been processed.</p> 
  <h1><a id="user-content-project-status" class="anchor" href="https://github.com/softwaremill/kmq#project-status" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Project status</h1> 
  <h2><a id="user-content-version-02-19-jun-2017" class="anchor" href="https://github.com/softwaremill/kmq#version-02-19-jun-2017" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Version 0.2 (19 Jun 2017)</h2> 
  <ul> 
   <li>redelivery component optimizations</li> 
   <li>bug fixes</li> 
  </ul> 
  <h2><a id="user-content-version-01-24-apr-2017" class="anchor" href="https://github.com/softwaremill/kmq#version-01-24-apr-2017" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Version 0.1 (24 Apr 2017)</h2> 
  <ul> 
   <li>initial release</li> 
  </ul> 
 </article>
</div>