<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h2><a id="user-content-rebox" class="anchor" href="https://github.com/non/rebox#rebox" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Rebox</h2> 
  <h3><a id="user-content-overview" class="anchor" href="https://github.com/non/rebox#overview" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Overview</h3> 
  <p>Rebox is a companion package to <a href="https://github.com/non/rebox/blob/master" target="_blank">Debox</a>.</p> 
  <p>Rebox is designed to provide an immutable veneer around Debox instances, including immutable updating with structural sharing. The ideal use case is a situation where a large amount of unboxed data is needed, but where an immutable collection (which can be updated) is required.</p> 
  <p>The name refers to the fact that Rebox's immutability and structural-sharing come at the cost of additional boxing.</p> 
  <h3><a id="user-content-examples" class="anchor" href="https://github.com/non/rebox#examples" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Examples</h3> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c">// construct a very large debox.Set instance, and wrap it in</span>
<span class="pl-c">// rebox.Set for safety. this will save space, while providing</span>
<span class="pl-c">// a generic and immutable facade (but will cause boxing).</span>
<span class="pl-k">def</span> <span class="pl-en">load</span>(...)<span class="pl-k">:</span> rebox.<span class="pl-en">Set</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> {
  <span class="pl-c">// lots of unboxed values hashed into an int[].</span>
  <span class="pl-k">val</span> <span class="pl-en">largeSet</span><span class="pl-k">:</span> debox.<span class="pl-en">Set</span>[<span class="pl-k">Int</span>] <span class="pl-k">=</span> ...

  <span class="pl-c">// create a threadsafe, immutable veneer</span>
  rebox.<span class="pl-en">Set</span>(largeSet)
}

<span class="pl-c">// create a rebox.Set instance to play with.</span>
<span class="pl-k">val</span> <span class="pl-en">values1</span> <span class="pl-k">=</span> load(...)

<span class="pl-c">// does not copy underlying debox.Set instance.</span>
<span class="pl-c">// adds 999 to an additional internal immutable.Set[Int].</span>
<span class="pl-c">// values1 is still totally viable and unchanged.</span>
<span class="pl-k">val</span> <span class="pl-en">values2</span> <span class="pl-k">=</span> values1 <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-c1">999</span>

<span class="pl-c">// still shares underlying int[] with values1 and values2</span>
<span class="pl-c">// internal immutable.Set[Int] contains all "new" values.</span>
<span class="pl-k">val</span> <span class="pl-en">values3</span> <span class="pl-k">=</span> (<span class="pl-c1">1001</span> to <span class="pl-c1">14255</span>).foldLeft(values2) { (set, n) <span class="pl-k">=&gt;</span> set <span class="pl-k">+</span><span class="pl-k">=</span> n }

<span class="pl-c">// updates an additional Set[Int] to track deletions.</span>
<span class="pl-c">// structurally sharing additions with values3 and</span>
<span class="pl-c">// the int[] with all previous rebox.Set instances.</span>
<span class="pl-k">val</span> <span class="pl-en">values4</span> <span class="pl-k">=</span> values3 <span class="pl-k">-</span> <span class="pl-c1">1111</span>

<span class="pl-c">// allocates new int[] with all "current" values.</span>
<span class="pl-c">// if values1 through values4 are freed, the original</span>
<span class="pl-c">// underlying array will be freed too.</span>
<span class="pl-k">val</span> <span class="pl-en">values5</span> <span class="pl-k">=</span> values4.compact</pre>
  </div> 
  <h3><a id="user-content-getting-rebox" class="anchor" href="https://github.com/non/rebox#getting-rebox" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Getting Rebox</h3> 
  <p>Rebox is published to <a href="https://bintray.com/" target="_blank">bintray</a> using the <a href="https://github.com/softprops/bintray-sbt" target="_blank">bintray-sbt</a> plugin.</p> 
  <p>Rebox supports Scala 2.10 and 2.11. If you use SBT, you can include Rebox via the following <code>build.sbt</code> snippets:</p> 
  <pre><code>resolvers += "bintray/non" at "http://dl.bintray.com/non/maven"

libraryDependencies += "org.spire-math" %% "rebox" % "0.0.1"
</code></pre> 
  <h3><a id="user-content-details" class="anchor" href="https://github.com/non/rebox#details" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Details</h3> 
  <p>Rebox's design is based around the idea of shared, read-only Debox instances along with an immutable "changelog". This means that additions and deletions will not have to copy a large array, but will use the immutable map and set instances that Scala is known for. It also means that Rebox's immutable instances are threadsafe (and use structural sharing) while also conserving underlying storage space.</p> 
  <p>One critical detail is that the underlying Debox instances must be considered read-only. This invariant is not enforced by the code; users who wish to code defensively can use the <code>.copy</code> method to create a fresh Debox instance.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">largeSet</span><span class="pl-k">:</span> debox.<span class="pl-en">Set</span>[<span class="pl-k">Double</span>] <span class="pl-k">=</span> ...

<span class="pl-c">// as long as no one else modifies largeSet this is fine</span>
<span class="pl-k">val</span> <span class="pl-en">trusting</span><span class="pl-k">:</span> rebox.<span class="pl-en">Set</span>[<span class="pl-k">Double</span>] <span class="pl-k">=</span> rebox.<span class="pl-en">Set</span>(largeSet)

<span class="pl-c">// this is a safer option, but duplicates largeSet's contents</span>
<span class="pl-k">val</span> <span class="pl-en">safe</span><span class="pl-k">:</span> rebox.<span class="pl-en">Set</span>[<span class="pl-k">Double</span>] <span class="pl-k">=</span> rebox.<span class="pl-en">Set</span>(largeSet.copy)</pre>
  </div> 
  <p>After a Rebox instance accumulates a lot of changes, it will start using up more space. Users can manually compact Rebox instances in two ways:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">items</span><span class="pl-k">:</span> rebox.<span class="pl-en">Map</span>[<span class="pl-en">K</span>, <span class="pl-en">V</span>] <span class="pl-k">=</span> ...

<span class="pl-c">// unconditionally compact the items, ensuring a maximally-efficient</span>
<span class="pl-c">// unboxed representation.</span>
<span class="pl-k">val</span> <span class="pl-en">a</span> <span class="pl-k">=</span> items.compact

<span class="pl-c">// only compact the items if the given storage ratio is exceed. the</span>
<span class="pl-c">// percentage parameter (0.5 in this case) means that if the number</span>
<span class="pl-c">// of changes reaches 50% of the underlying map's size, compacting</span>
<span class="pl-c">// will occur.</span>
b <span class="pl-k">=</span> items.compactAt(<span class="pl-c1">0.5</span>)</pre>
  </div> 
  <h3><a id="user-content-known-issues-and-future-work" class="anchor" href="https://github.com/non/rebox#known-issues-and-future-work" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Known Issues and Future Work</h3> 
  <p>Rebox is not specialized. While immutable structures will always do more boxing than a "raw" array-based approach it's possible we can do much better here.</p> 
  <p>Rebox does not do any automatic compacting. It might be the case that there is an optimal percentage at which it should automatically compact.</p> 
  <p>Rebox instances only implement the <code>Iterable</code> interface, and don't support many collections methods directly. There are definitely additional methods we should be overriding, and it's also possible we should be trying to use <code>SetLike</code> and <code>MapLike</code> (although getting that working correctly will be a thankless task). This means that equality tests with Scala's set and map classes will always return <code>false</code>.</p> 
  <p>Rebox could use more benchmarks (both performance and memory).</p> 
  <h3><a id="user-content-copyright-and-license" class="anchor" href="https://github.com/non/rebox#copyright-and-license" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Copyright and License</h3> 
  <p>All code is available to you under the MIT license, available at <a href="http://opensource.org/licenses/mit-license.php" target="_blank">http://opensource.org/licenses/mit-license.php</a> and also in the <a href="https://github.com/non/rebox/blob/master/COPYING" target="_blank">COPYING</a> file.</p> 
  <p>Copyright Erik Osheim, 2014.</p> 
 </article>
</div>