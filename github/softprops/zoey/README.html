<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-zoey" class="anchor" href="https://github.com/softprops/zoey#zoey" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>zoey</h1> 
  <p><a href="https://travis-ci.org/softprops/zoey" target="_blank"><img src="https://camo.githubusercontent.com/6a385afdb47b24e63c29a1507b4ed5770ab4a9b9/68747470733a2f2f7472617669732d63692e6f72672f736f667470726f70732f7a6f65792e737667" alt="Build Status" data-canonical-src="https://travis-ci.org/softprops/zoey.svg" style="max-width:100%;"></a></p> 
  <blockquote> 
   <p>taking Scala to the zoo</p> 
  </blockquote> 
  <p>a non-blocking interface for <a href="http://zookeeper.apache.org/" target="_blank">apache zookeeper</a>. Inspired by Twitter's wonderful zk-client, implemented in terms of scala's standard library features.</p> 
  <h2><a id="user-content-goals" class="anchor" href="https://github.com/softprops/zoey#goals" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>goals</h2> 
  <ul> 
   <li>be simple</li> 
  </ul> 
  <p>The underlying concepts of zookeeper are simple. Interacting with the standard java driver is not.</p> 
  <ul> 
   <li>be robust</li> 
  </ul> 
  <p>Zookeeper is a mature HA answer for many distributed systems questions. Despite that, networks are still unreliable. These zookeeper interfaces should be designed with that in mind.</p> 
  <ul> 
   <li>be asyncronous by default</li> 
  </ul> 
  <p>The standard java zookeeper driver supports blocking operations with an optional support for callback style async operations. Scala's standard library Futures model latter very well providing a familiar interface that works well with existing scala libraries. </p> 
  <ul> 
   <li>model interfaces more closely to the domain</li> 
  </ul> 
  <p>The standard java zookeeper driver defines one entry point, the client, which defines a number of methods for both managing a session's connection state and performing operations on paths. Zoey splits up this interface in a way that makes ZNodes, a core zookeeper abstraction, a first class citizen in zoey's client interface.</p> 
  <h2><a id="user-content-install" class="anchor" href="https://github.com/softprops/zoey#install" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>install</h2> 
  <p>add the following to your sbt build definition</p> 
  <div class="highlight highlight-source-scala">
   <pre>resolvers <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>softprops-maven<span class="pl-pds">"</span></span> at <span class="pl-s"><span class="pl-pds">"</span>http://dl.bintray.com/content/softprops/maven<span class="pl-pds">"</span></span>

libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>me.lessis<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>zoey-core<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>0.1.2<span class="pl-pds">"</span></span></pre>
  </div> 
  <h2><a id="user-content-usage" class="anchor" href="https://github.com/softprops/zoey#usage" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>usage</h2> 
  <h3><a id="user-content-zoey-core" class="anchor" href="https://github.com/softprops/zoey#zoey-core" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>zoey core</h3> 
  <p>Zoey core defines interfaces for creating a configurable and robust client to communicate with zookeeper servers.</p> 
  <h4><a id="user-content-creating-a-client" class="anchor" href="https://github.com/softprops/zoey#creating-a-client" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Creating a client</h4> 
  <p>Creating a new client with default options is simple.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">cli</span> <span class="pl-k">=</span> zoey.<span class="pl-en">ZkClient</span>()</pre>
  </div> 
  <p>The default client will connect a zookeeper server listening on <code>0.0.0.0:2181</code>. If you've spun up a zookeeper locally this may be fine, but if you've spun one up on another host just provide that connection string as an argument to your clients constructor.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">cli</span> <span class="pl-k">=</span> zoey.<span class="pl-en">ZkClient</span>(connectString)</pre>
  </div> 
  <p>Many clients connecting to the same servers to perform operations can have an undesirable herding effect. Zookeeper servers are often distributed across a number of hosts for high availability. A <em>round robin</em> interface is provided for creating a zookeeper client that will perform requests on a different host for each operation in the order the hosts are defined.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">cli</span> <span class="pl-k">=</span> zoey.<span class="pl-en">ZkClient</span>.roundRobin(hostA <span class="pl-k">::</span> hostB <span class="pl-k">::</span> hostC <span class="pl-k">::</span> <span class="pl-c1">Nil</span>)</pre>
  </div> 
  <p>If a given server is unavailable, you don't want to wait on a connection to establish all day. In these cases you may with to set a connection timeout, specified as a <a href="http://www.scala-lang.org/api/current/index.html#scala.concurrent.duration.FiniteDuration" target="_blank">FiniteDuration</a>.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">scala.concurrent.duration.</span><span class="pl-v">_</span>
<span class="pl-k">val</span> <span class="pl-en">cli</span> <span class="pl-k">=</span> zoey.<span class="pl-en">ZkClient</span>(connectString, connectTimeout <span class="pl-k">=</span> <span class="pl-en">Some</span>(<span class="pl-c1">3</span> seconds))</pre>
  </div> 
  <p>Once connected the server, the server will attempt to make sure its connection with you is healthy by establishing a session timeout for gaps in network connectivity. By default, this session timeout is set to 4 seconds. If you wish to change this, set the sessionTimeout when creating your client.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">scala.concurrent.duration.</span><span class="pl-v">_</span>
<span class="pl-k">val</span> <span class="pl-en">cli</span> <span class="pl-k">=</span> zoey.<span class="pl-en">ZkClient</span>(connectStr, sessionTimeout <span class="pl-k">=</span> <span class="pl-c1">10.</span>seconds)</pre>
  </div> 
  <p>Once you've created a client, you may which to configure it's <a href="http://zookeeper.apache.org/doc/r3.4.6/api/org/apache/zookeeper/CreateMode.html" target="_blank">mode</a> of operation. Typically this will be one of ephemeral or persistent and optionally sequential. The client mode defines the semantics for how long of information written to zookeeper is stored. The default is persistent.</p> 
  <p>Zoey's client interfaces produce immutable instances but who share a client connection. Keep this in mind when storing references to client instances.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">ephemeralSeqCli</span> <span class="pl-k">=</span> cli.emphermalSequential</pre>
  </div> 
  <p>Operations requested over a distributed network system are not guaranteed to be successful due to a number of potential factors. To make zoey more robust in the face of these potential issues, zoey provides an interface for retrying failed operations, leveraging interfaces defined in the <a href="https://github.com/softprops/retry" target="_blank">retry</a> library.</p> 
  <p>The following will attempt to retry operations up to 4 times with an <a href="https://github.com/softprops/retry#backoff" target="_blank">exponential backoff</a> time starting at 1 second.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">retryingCli</span> <span class="pl-k">=</span> cli.retryWith(
  retry.<span class="pl-en">Backoff</span>(max <span class="pl-k">=</span> <span class="pl-c1">4</span>, delay <span class="pl-k">=</span> <span class="pl-c1">1.</span>second))</pre>
  </div> 
  <h3><a id="user-content-getting-data-out" class="anchor" href="https://github.com/softprops/zoey#getting-data-out" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Getting data out</h3> 
  <p>Zookeeper stores data with structures called ZNodes which are addressable by directory-like paths. To reference a ZNode, provide it's path to the client.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">node</span> <span class="pl-k">=</span> cli.node(<span class="pl-s"><span class="pl-pds">"</span>/foo/bar<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>or more simply...</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">node</span> <span class="pl-k">=</span> cli(<span class="pl-s"><span class="pl-pds">"</span>/foo/bar<span class="pl-pds">"</span></span>)</pre>
  </div> 
  <p>The above <code>node</code> is a reference to a zookeepers ZNode's address. No information as been collected from or sent to the server yet. It is just a description for a future point of reference when invoking operations.</p> 
  <p>Zookeeper defines a basic set of operations for creating, updating and reading data from ZNodes.</p> 
  <p>Read operations are unique in that you can request information, and optionally, request to get notified when this information changes.</p> 
  <p>Zookeeper calls these notifications "watches"</p> 
  <p>For example, given the znode reference we created above, <code>node</code>, we can ask zookeeper if this ZNode exists <em>and</em> to get notified when it that fact changes.</p> 
  <p>These watch notifications only fire once, and thus, are perfectly represented as scala Futures which also may only be satisfied once.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> the `exists` operation</span>
<span class="pl-k">val</span> <span class="pl-en">exists</span> <span class="pl-k">=</span> node.exists

<span class="pl-c"><span class="pl-c">//</span> calling apply() on a read operation produces a future which will be satisfied once information is retried once</span>
<span class="pl-k">val</span> <span class="pl-en">future</span> <span class="pl-k">=</span> exists()
future.foreach {
  <span class="pl-k">case</span> exists <span class="pl-k">=&gt;</span> println(s<span class="pl-s"><span class="pl-pds">"</span>rec $exists<span class="pl-pds">"</span></span>)
}

<span class="pl-c"><span class="pl-c">//</span> calling watch() on a read operation produces a structure that exposes of the result of the operation as a Try and a future </span>
<span class="pl-c"><span class="pl-c">//</span> which will be satisfied when an update to this information occurs. Since futures may only be satisfied once, when</span>
<span class="pl-c"><span class="pl-c">//</span> and update occurs you will need to re-request a new watch for the read operation on the ZNode</span>
<span class="pl-k">val</span> <span class="pl-en">watch</span> <span class="pl-k">=</span> exists.watch()
watch.foreach {
  <span class="pl-k">case</span> zoey.<span class="pl-en">Watch</span>(exists, updateFuture) <span class="pl-k">=&gt;</span>
    println(s<span class="pl-s"><span class="pl-pds">"</span>exists $exists<span class="pl-pds">"</span></span>)
    updateFuture.foreach {
      <span class="pl-k">case</span> event <span class="pl-k">=&gt;</span> onPathChanged(event)
    }
}</pre>
  </div> 
  <p>Besides knowing that a given ZNode exists, you can ask for what data is contain with the <code>data</code> operation.</p> 
  <div class="highlight highlight-source-scala">
   <pre>node.data().foreach {
  <span class="pl-k">case</span> data <span class="pl-k">=&gt;</span>
    <span class="pl-c"><span class="pl-c">//</span> data is a znode ref populated with the bytes stored at its path</span>
    println(s<span class="pl-s"><span class="pl-pds">"</span>node stores ${data.bytes.size} bytes<span class="pl-pds">"</span></span>)
}</pre>
  </div> 
  <p>ZNodes differ from traditional file system file descriptors in that they can act as both containers for data <em>and</em> directories which have a list of child paths which are addresses to other ZNodes.</p> 
  <div class="highlight highlight-source-scala">
   <pre>node.children().foreach {
  <span class="pl-k">case</span> children <span class="pl-k">=&gt;</span>
    <span class="pl-c"><span class="pl-c">//</span> children is a znode ref populated with the nodes stored at its path</span>
    println(s<span class="pl-s"><span class="pl-pds">"</span>node has ${children.nodes.size} children<span class="pl-pds">"</span></span>)
}</pre>
  </div> 
  <p>An instance of <a href="http://www.scala-lang.org/api/current/index.html#scala.math.Ordering" target="_blank">Ordering</a> is defined for ZNodes which accounts for <a href="http://zookeeper.apache.org/doc/r3.4.6/api/org/apache/zookeeper/CreateMode.html#EPHEMERAL_SEQUENTIAL" target="_blank">sequential</a> <a href="http://zookeeper.apache.org/doc/r3.4.6/api/org/apache/zookeeper/CreateMode.html#PERSISTENT_SEQUENTIAL" target="_blank">names</a>. This is useful due to the fact that getting the children of a given znode defines <a href="http://zookeeper.apache.org/doc/r3.4.6/api/org/apache/zookeeper/ZooKeeper.html#getChildren(java.lang.String,%20boolean)" target="_blank">no guarantees</a> about the order in which they are returned.</p> 
  <h3><a id="user-content-getting-data-in" class="anchor" href="https://github.com/softprops/zoey#getting-data-in" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Getting data in</h3> 
  <p>Now that you know how to get information out of zookeeper. Let's look at how you get it in.</p> 
  <p>ZNode path addresses work just like UNIX paths. You can't create path "/foo/bar" is path "/foo" doesn't exist. In the UNIX world you can request the <code>-p</code> (parent) flag to the <code>mkdir</code> command to ensure parent directories get created. With zoey, if you are storing data addressed at path "/foo/bar" and don't know for sure that ZNode "/foo" exists you can set the <code>parent</code> parameter to true on create requests</p> 
  <div class="highlight highlight-source-scala">
   <pre>node.create(<span class="pl-s"><span class="pl-pds">"</span>test<span class="pl-pds">"</span></span>.getBytes, parent <span class="pl-k">=</span> <span class="pl-c1">true</span>)
 .foreach {
   <span class="pl-k">case</span> created <span class="pl-k">=&gt;</span> println(s<span class="pl-s"><span class="pl-pds">"</span>created $created<span class="pl-pds">"</span></span>)
 }</pre>
  </div> 
  <p>What you can create, you can also update, but the current data a ZNode holds, as seen by you, may not be consistent with the data as seen by the zookeeper server if there are other zookeeper clients interacting with the server. To accommodate this consistency conundrum zookeeper attaches version information to ZNodes. You can read this version information by requesting the znode <a href="http://zookeeper.apache.org/doc/r3.4.6/api/org/apache/zookeeper/data/Stat.html" target="_blank">Stat</a> with <code>znode.exists</code>.</p> 
  <div class="highlight highlight-source-scala">
   <pre>node.set(<span class="pl-s"><span class="pl-pds">"</span>updated<span class="pl-pds">"</span></span>.getBytes, version).foreach {
  <span class="pl-k">case</span> result <span class="pl-k">=&gt;</span> println(s<span class="pl-s"><span class="pl-pds">"</span>updated $result<span class="pl-pds">"</span></span>)
}</pre>
  </div> 
  <h3><a id="user-content-closing-time" class="anchor" href="https://github.com/softprops/zoey#closing-time" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Closing time</h3> 
  <p>Since a zoey ZkClient maintains a persistent connection with a zookeeper server, you should instrument your application in a way to gracefully terminate this connection. To do this. Simply call the <code>close</code> method defined on ZkClient which will return a Future that will be satisfied when the close operation is complete.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">closeFuture</span> <span class="pl-k">=</span> zkClient.close()
closeFuture.foreach {
  <span class="pl-k">case</span> _ <span class="pl-k">=&gt;</span> println(<span class="pl-s"><span class="pl-pds">"</span>the zoo is closed<span class="pl-pds">"</span></span>)
}</pre>
  </div> 
  <p>Close should only be called once.</p> 
  <p>Doug Tangren (softprops) 2013-2014</p> 
 </article>
</div>