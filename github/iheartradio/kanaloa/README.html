<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <p><a href="https://gitter.im/iheartradio/kanaloa?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge" target="_blank"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/iheartradio/kanaloa" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a> <a href="https://travis-ci.org/iheartradio/kanaloa" target="_blank"><img src="https://camo.githubusercontent.com/59f0a40fd228d26ffc59ac1202c853f4eb3a00b6/68747470733a2f2f7472617669732d63692e6f72672f696865617274726164696f2f6b616e616c6f612e737667" alt="Build Status" data-canonical-src="https://travis-ci.org/iheartradio/kanaloa.svg" style="max-width:100%;"></a> <a href="https://coveralls.io/github/iheartradio/kanaloa?branch=master" target="_blank"><img src="https://camo.githubusercontent.com/11ca886adf92b58833eacc043a38e5d3bf31c2b0/68747470733a2f2f636f766572616c6c732e696f2f7265706f732f6769746875622f696865617274726164696f2f6b616e616c6f612f62616467652e7376673f6272616e63683d6d6173746572" alt="Coverage Status" data-canonical-src="https://coveralls.io/repos/github/iheartradio/kanaloa/badge.svg?branch=master" style="max-width:100%;"></a> <a href="https://bintray.com/iheartradio/maven/kanaloa-core/_latestVersion" target="_blank"><img src="https://camo.githubusercontent.com/58b11beb38c5adb25a936f85ea2dc4425cf7e9cb/68747470733a2f2f6170692e62696e747261792e636f6d2f7061636b616765732f696865617274726164696f2f6d6176656e2f6b616e616c6f612d636f72652f696d616765732f646f776e6c6f61642e737667" alt="Download" data-canonical-src="https://api.bintray.com/packages/iheartradio/maven/kanaloa-core/images/download.svg" style="max-width:100%;"></a></p> 
  <h1><a id="user-content-kanaloa" class="anchor" href="https://github.com/iheartradio/kanaloa#kanaloa" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Kanaloa</h1> 
  <p>Add auto backpressure, proportional load balancer and realtime monitor to your service. </p> 
  <h3><a id="user-content-this-library-is-still-pre-beta" class="anchor" href="https://github.com/iheartradio/kanaloa#this-library-is-still-pre-beta" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>This library is still pre-beta</h3> 
  <p>Right now we are at 0.4.0, the plan is the stablize the API from 0.5.0 going on. So there will still be major API changes coming. </p> 
  <h3><a id="user-content-tldr" class="anchor" href="https://github.com/iheartradio/kanaloa#tldr" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>TLDR</h3> 
  <p>When you hit a service that has a max capacity of 100 request per second with 200 requests per second, you get:</p> 
  <p><strong>Without Kanaloa</strong> Latency increases until few requests get handled within accetable time <a href="https://cloud.githubusercontent.com/assets/83257/17779409/8bc82d2e-6535-11e6-8917-f54ef634ad80.png" target="_blank"><img src="https://cloud.githubusercontent.com/assets/83257/17779409/8bc82d2e-6535-11e6-8917-f54ef634ad80.png" alt="Without" style="max-width:100%;"></a></p> 
  <p><strong>With Kanaloa</strong> Latency is controlled, half of requests are handled timely, the other half are rejected immediately. <a href="https://cloud.githubusercontent.com/assets/83257/17779483/c88e3f5a-6535-11e6-8594-4df40771372c.png" target="_blank"><img src="https://cloud.githubusercontent.com/assets/83257/17779483/c88e3f5a-6535-11e6-8594-4df40771372c.png" alt="withKanaloa" style="max-width:100%;"></a></p> 
  <p>Kanaloa automatically figures out the capacity of your service and let it handles at maximum capacity, rejects requests above it. <a href="https://cloud.githubusercontent.com/assets/83257/17779633/55339568-6536-11e6-9bdd-27723927f076.png" target="_blank"><img src="https://cloud.githubusercontent.com/assets/83257/17779633/55339568-6536-11e6-9bdd-27723927f076.png" alt="rejections" style="max-width:100%;"></a></p> 
  <p>Kanaloa also adaptes to your backend capacity change automatically. </p> 
  <h3><a id="user-content-behind-the-scene" class="anchor" href="https://github.com/iheartradio/kanaloa#behind-the-scene" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Behind the scene</h3> 
  <p>Kanaloa work dispatchers sit in front of your service and provides auto back pressure through the following means:</p> 
  <ol> 
   <li><strong>Autothrottle</strong> - it dynamically figures out the optimal number of concurreny your service can handle, and make sure that at any given time your service handles no more than that number of concurrent requests. This simple mechanism was also ported and contributed to Akka as <a href="http://doc.akka.io/docs/akka/2.4.1/scala/routing.html#Optimal_Size_Exploring_Resizer" target="_blank">Optimal Size Exploring Resizer</a> with some limitations. See <a href="https://github.com/iheartradio/kanaloa#implAutothrottle" target="_blank">details of the algorithm below</a>.</li> 
   <li><strong>PIE</strong> - A traffic regulator based on the PIE algo (Proportional Integral controller Enhanced) suggested in this paper <a href="https://www.ietf.org/mail-archive/web/iccrg/current/pdfB57AZSheOH.pdf" target="_blank">https://www.ietf.org/mail-archive/web/iccrg/current/pdfB57AZSheOH.pdf</a> by Rong Pan and his collaborators. See <a href="https://github.com/iheartradio/kanaloa#implPIE" target="_blank">details of the algorithm below</a>.</li> 
   <li><strong>Circuit breaker</strong> - when error rate from your service goes above a certain threshold, the kanaloa will slow down sending work to them for a short period of time to give your service a chance to "cool down".</li> 
   <li><strong>Real-time monitoring</strong> - a built-in statsD reporter allows you to monitor a set of critical metrics (throughput, failure rate, queue length, expected wait time, service process time, number of concurrent requests, etc) in real time. It also provides real-time insights into how kanaloa dispatchers are working. An example on Grafana: <a href="https://cloud.githubusercontent.com/assets/83257/17714327/449e09d2-63cd-11e6-8527-3ee9e9bbf755.png" target="_blank"><img src="https://cloud.githubusercontent.com/assets/83257/17714327/449e09d2-63cd-11e6-8527-3ee9e9bbf755.png" alt="Dashboard" style="max-width:100%;"></a></li> 
  </ol> 
  <h3><a id="user-content-get-started" class="anchor" href="https://github.com/iheartradio/kanaloa#get-started" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Get started</h3> 
  <h4><a id="user-content-install-dependency" class="anchor" href="https://github.com/iheartradio/kanaloa#install-dependency" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Install dependency</h4> 
  <pre><code>resolvers += Resolver.jcenterRepo

libraryDependencies +=  "com.iheart" %% "kanaloa-core" % "0.4.0"
</code></pre> 
  <h4><a id="user-content-config" class="anchor" href="https://github.com/iheartradio/kanaloa#config" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Config</h4> 
  <p>An example of a <code>my-dispatcher</code></p> 
  <pre><code>kanaloa {
  dispatchers {
    my-service1 {
      workerPool {
       startingPoolSize = 8
      }
      workTimeout = 3s
    }
  }
}
</code></pre> 
  <p>For more configuration settings and their documentation please see the <a href="https://github.com/iheartradio/kanaloa/blob/master/src/main/resources/reference.conf" target="_blank">reference configuration</a></p> 
  <h4><a id="user-content-usage" class="anchor" href="https://github.com/iheartradio/kanaloa#usage" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Usage</h4> 
  <p>There are two types kanaloa dispatchers: <code>PushingDispatcher</code> and <code>PullingDispatcher</code>. <code>PushingDispatcher</code> takes work requests when you send message to it.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">system</span> <span class="pl-k">=</span> <span class="pl-en">ActorSystem</span>()

<span class="pl-c">// suppose you wrote your service in an actor,</span>
<span class="pl-c">// which takes a SomeWork(someRequest) message and</span>
<span class="pl-c">// replies SuccessResult(someResults) when it succeeds</span>
<span class="pl-k">val</span> <span class="pl-en">serviceActor</span> <span class="pl-k">=</span> system.actorOf(<span class="pl-en">MyServiceActor</span>.props)

<span class="pl-k">val</span> <span class="pl-en">dispatcher</span> <span class="pl-k">=</span>
  system.actorOf(<span class="pl-en">PushingDispatcher</span>.props(
    name <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>my-service1<span class="pl-pds">"</span></span>,
    serviceActor
  ) {
    <span class="pl-k">case</span> <span class="pl-en">SuccessResult</span>(r) <span class="pl-k">=&gt;</span> <span class="pl-en">Right</span>(r)  <span class="pl-c">// ResultChecker that tells kanaloa if the request is handled succesffully</span>
    <span class="pl-k">case</span> _ <span class="pl-k">=&gt;</span> <span class="pl-en">Left</span>(<span class="pl-s"><span class="pl-pds">"</span>something bad happened<span class="pl-pds">"</span></span>)
  })

dispatcher <span class="pl-k">!</span> <span class="pl-en">SomeWork</span>(<span class="pl-s"><span class="pl-pds">"</span>blahblah<span class="pl-pds">"</span></span>) <span class="pl-c">//dispatcher replies the result (whatever wrapped in the SuccessResult) back.</span>
</pre>
  </div> 
  <p><code>PullingPatcher</code> pulls work from an iterator, ideal when you have control over the source of the work (e.g. a task iterates through your DB)</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c">//assume you have the same system and serviceActor as above.</span>

<span class="pl-c">//unrealistic example of an iterator you would pass into a PullingDispatcher</span>
<span class="pl-k">val</span> <span class="pl-en">iterator</span> <span class="pl-k">=</span> <span class="pl-en">List</span>(<span class="pl-en">SomeWork</span>(<span class="pl-s"><span class="pl-pds">"</span>work1<span class="pl-pds">"</span></span>), <span class="pl-en">SomeWork</span>(<span class="pl-s"><span class="pl-pds">"</span>work2<span class="pl-pds">"</span></span>), <span class="pl-en">SomeWork</span>(<span class="pl-s"><span class="pl-pds">"</span>work3<span class="pl-pds">"</span></span>)).iterator

<span class="pl-k">val</span> <span class="pl-en">dispatcher</span> <span class="pl-k">=</span>
  system.actorOf(<span class="pl-en">PullingDispatcher</span>.props(
    name <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>my-service2<span class="pl-pds">"</span></span>,
    iterator,
    serviceActor
  ) {
    <span class="pl-k">case</span> <span class="pl-en">SuccessResult</span>(r) <span class="pl-k">=&gt;</span> <span class="pl-en">Right</span>(r)     <span class="pl-c">// this is your ResultChecker which tell kanaloa if the request is handled succesffully</span>
    <span class="pl-k">case</span> _ <span class="pl-k">=&gt;</span> <span class="pl-en">Left</span>(<span class="pl-s"><span class="pl-pds">"</span>something bad happened<span class="pl-pds">"</span></span>)
  })

<span class="pl-c">// dispatcher will pull all work in dispatch them to service and shutdown itself when all done. </span>
</pre>
  </div> 
  <p>We used an <a href="http://doc.akka.io/api/akka/snapshot/index.html#akka.actor.ActorRef" target="_blank">ActorRef</a> as service here, Kanaloa also supports <a href="http://doc.akka.io/api/akka/snapshot/index.html#akka.actor.Props" target="_blank">Props</a> and <code>T =&gt; Future[R]</code> function as service. You can use any <code>T</code> as service if you implement an implicit <code>T =&gt; Backend</code> where <code>Backend</code> is a simple trait:</p> 
  <pre><code>trait Backend { def apply(af: ActorRefFactory): ActorRef }
</code></pre> 
  <h3><a id="user-content-statsd-monitor" class="anchor" href="https://github.com/iheartradio/kanaloa#statsd-monitor" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>StatsD monitor</h3> 
  <p>Kanaloa has a built-in statsD reporter that allows users to monitor important metrics in real time.</p> 
  <h4><a id="user-content-config-statsd" class="anchor" href="https://github.com/iheartradio/kanaloa#config-statsd" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Config StatsD</h4> 
  <p>Add following to your config</p> 
  <pre><code>kanaloa {
  default-dispatcher {
    metrics {
      enabled = on
      statsD {
        host = "localhost" #host of your statsD server
        port = 8125
      }
    }
  }
}
</code></pre> 
  <p>Metrics reporting settings at the dispatcher level, e.g.</p> 
  <pre><code>kanaloa {
  dispatchers {
    example {
      metrics.enabled = off
    }
    example2 {
      metrics {
        statsD {
          eventSampleRate = 0.01
        }
      }
    }
  }
}
</code></pre> 
  <p>For more settings please see the <a href="https://github.com/iheartradio/kanaloa/blob/master/src/main/resources/reference.conf" target="_blank">reference configuration</a></p> 
  <h4><a id="user-content-visualize-with-grafana" class="anchor" href="https://github.com/iheartradio/kanaloa#visualize-with-grafana" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Visualize with Grafana</h4> 
  <p>We provide a <a href="https://github.com/iheartradio/kanaloa/blob/master/grafana/dashboard.json" target="_blank">grafana dashboard</a> if you are using grafana for statsD visualization. We also provide a <a href="https://github.com/iheartradio/docker-grafana-graphite" target="_blank">docker image</a> with which you can quickly get up and running a statsD server and visualization web app. Please follow the instructions there.</p> 
  <h3><a id="user-content-implementation-detail-for-autothrottle" class="anchor" href="https://github.com/iheartradio/kanaloa#implementation-detail-for-autothrottle" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a><a name="user-content-implAutothrottle" target="_blank" href=""></a>Implementation detail for Autothrottle</h3> 
  <p><em>Disclosure: some of the following descriptions were adapted from the documentation of Akka's <a href="http://doc.akka.io/docs/akka/2.4.1/scala/routing.html#Optimal_Size_Exploring_Resizer" target="_blank">OptimalSizeExploringResizer</a>, which was also written by the original author of this document.</em></p> 
  <p>Behind the scene kanaloa dispatchers create a set of workers that pull work on behave of your service. These workers wait for result coming back from the service before they accept more work from the dispatcher. This way it thorttles the number of concurrent requests the service handles. The autothrottle constantly search for the optimal concurrency, i.e. the just right concurrency that allows backend to provide maximum capactity. For example, if the service achieves maximum output by handling 30 requests at the same time, kanaloa will make sure it doesn't handle more than 30 requests concurrently. Typcially, hitting a service with above its optimum concurrency will result in either higher latency (the extra requests have to wait in a queue) or lower throughput (extra concucrrent requests have to compete for limited resource causing contention.) </p> 
  <p>The autothrottle keeps track of throughput and latency at each pool size and perform the following three resizing operations (one at a time) periodically:</p> 
  <ol> 
   <li>Downsize if it hasn't seen all workers ever fully utilized for a period of time.</li> 
   <li>Explore to a random nearby pool size to try and collect throughput metrics.</li> 
   <li>Optimize to a nearby pool size with a better (than any other nearby sizes) throughput and latency metrics.</li> 
  </ol> 
  <p>When the pool is fully-utilized (i.e. all workers are busy), it randomly chooses between exploring and optimizing. When the pool has not been fully-utilized for a period of time, it will downsize the pool to the last seen max utilization multiplied by a configurable ratio.</p> 
  <p>By constantly exploring and optimizing, the resizer will eventually walk to the optimal size and remain nearby. When the optimal size changes it will start walking towards the new one.</p> 
  <p>If autothrottle is all you need, you should consider using <a href="http://doc.akka.io/docs/akka/2.4.1/scala/routing.html#Optimal_Size_Exploring_Resizer" target="_blank">OptimalSizeExploringResizer</a> in an Akka router. (The caveat is that you need to make sure that your routees block on handling messages, i.e. they can’t simply asynchronously pass work to the backend service).</p> 
  <h3><a id="user-content-implementation-cetail-for-pie" class="anchor" href="https://github.com/iheartradio/kanaloa#implementation-cetail-for-pie" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a><a name="user-content-implPIE" target="_blank" href=""></a>Implementation cetail for PIE</h3> 
  <p>A traffic regulator based on the PIE algo (Proportional Integral controller Enhanced) suggested in this paper <a href="https://www.ietf.org/mail-archive/web/iccrg/current/pdfB57AZSheOH.pdf" target="_blank">https://www.ietf.org/mail-archive/web/iccrg/current/pdfB57AZSheOH.pdf</a> by Rong Pan and his collaborators. The algo drop request with a probability, here is the pseudocode:</p> 
  <p>Every update interval <code>Tupdate</code></p> 
  <ol> 
   <li><p>Estimation current queueing delay</p> <pre><code> currentDelay = queueLength / averageDequeueRate
</code></pre></li> 
   <li><p>Based on current drop probability, p, determine suitable step scales:</p> <pre><code> if p &lt; 1%       :  α = α΄ / 8, β = β΄ / 8
 else if p &lt; 10% :  α = α΄ / 2, β = β΄  2
 else            :  α = α΄,  β = β΄
</code></pre></li> 
   <li><p>Calculate drop probability as:</p> <pre><code> p = p
    + α * (currentDelay - referenceDelay) / referenceDelay
    + β * (currentDelay - oldDelay) / referenceDelay
</code></pre></li> 
   <li><p>Update previous delay sample rate as</p> <pre><code> OldDelay - currentDelay
</code></pre></li> 
  </ol> 
  <p>The regulator allows for a burst, here is the calculation</p> 
  <ol> 
   <li><p>When enqueueing</p> <pre><code> if burstAllowed &gt; 0
   enqueue request bypassing random drop
</code></pre></li> 
   <li><p>upon <code>Tupdate</code></p> <pre><code>   if p == 0 and currentDelay &lt; referenceDelay / 2 and oldDelay &lt; referenceDelay / 2
    burstAllowed = maxBurst
 else
    burstAllowed = burstAllowed - timePassed (roughly Tupdate)
</code></pre></li> 
  </ol> 
  <h3><a id="user-content-contribute" class="anchor" href="https://github.com/iheartradio/kanaloa#contribute" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Contribute</h3> 
  <p>Any contribution and feedback is more than welcome.</p> 
  <h3><a id="user-content-special-thanks" class="anchor" href="https://github.com/iheartradio/kanaloa#special-thanks" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Special Thanks</h3> 
  <p>The autothrottle algorithm was first suggested by @richdougherty. @ktoso kindly reviewed this library and provided valuable feedback.</p> 
 </article>
</div>