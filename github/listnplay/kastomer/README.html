<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-kastomer" class="anchor" href="https://github.com/listnplay/kastomer#kastomer" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Kastomer</h1> 
  <p>This is a <a href="http://www.reactive-streams.org/" target="_blank">Reactive-streams</a> REST client for <a href="https://customer.io/docs/api/rest.html" target="_blank">Customer.io API</a> implemented <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/snapshot/scala.html" target="_blank">with Akka-Http</a></p> 
  <p>If you are looking for an alternative for Scala - see <a href="http://dispatch.databinder.net/Dispatch.html" target="_blank">Dispatch</a>-based <a href="https://github.com/learndot/customer-io-scala" target="_blank">client</a>.</p> 
  <h2><a id="user-content-user-guide" class="anchor" href="https://github.com/listnplay/kastomer#user-guide" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>User Guide</h2> 
  <h3><a id="user-content-sbt" class="anchor" href="https://github.com/listnplay/kastomer#sbt" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>sbt</h3> 
  <p>To include it in your project add</p> 
  <pre><code>"com.featurefm" %% "kastomer" % "0.0.2"
</code></pre> 
  <p>Only Scala 2.11 is currently supported.</p> 
  <h3><a id="user-content-code" class="anchor" href="https://github.com/listnplay/kastomer#code" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Code</h3> 
  <p>Customer.io API provide 3 end-points: identify, track and delete. This library gives you 3 corresponding flows.</p> 
  <pre><code> trait Flows {
   def health:   Source[HealthInfo, Unit]
   def identify: Flow[User,  (Try[Int], User),  Any]
   def track:    Flow[Event, (Try[Int], Event), Any]
   def delete:   Flow[String, Try[Int],         Any]
 }
</code></pre> 
  <p>The main implementation is <code>Kastomer</code> class, you can create an instance with <code>Kastomer()</code>, providing that you have an implicit ActorSystem in scope. To create one:</p> 
  <pre><code> implicit val system = ActorSystem("My-App")
</code></pre> 
  <h3><a id="user-content-checking-connection" class="anchor" href="https://github.com/listnplay/kastomer#checking-connection" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Checking connection</h3> 
  <p>To run the client you need to provide <code>CUSTOMERIO_SITEID</code> and <code>CUSTOMERIO_APIKEY</code> environment variables.</p> 
  <p>Use <code>health.runWith(Sink.head)</code> to test connection, it will produce <code>Future[HealthInfo]</code> and if you provided good credentials you will get <code>HealthInfo(HealthState.GOOD, "nice credentials")</code></p> 
  <h3><a id="user-content-before-you-start---general-notes-about-the-api" class="anchor" href="https://github.com/listnplay/kastomer#before-you-start---general-notes-about-the-api" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Before you start - general notes about the API</h3> 
  <p><code>Try[Int]</code> represents the HTTP response status after calling customer.io API, and it should be Success(200) if all went well. If Failure is returned it probably signals either connection problem or bug in the code. Non-200 return code will indicate problem on customer.io side or invalid credentials.</p> 
  <p>The flow can be used to send a single request to customer.io, or it can be used to stream requests from some source to customer.io, for example results of a database query, a file read, or just an in-memory list of elements. When streaming multiple elements, it may be useful to correlate the responses (especially failures) with the element which processing produced them, for example to report or to retry the request. For that purpose the library provides a tuple in response to <strong>track</strong> and <strong>identify</strong>, first element of the tuple is the response, and the second is the element which processing produced the result.</p> 
  <p>If you are new to akka-streams: to build any stream you need an implicit <code>Materializer</code> value in scope, it s usually created like this:</p> 
  <pre><code> implicit val materializer = ActorMaterializer()
</code></pre> 
  <p>that in turn assumes an implicit ActorSystem.</p> 
  <h3><a id="user-content-identifying-user" class="anchor" href="https://github.com/listnplay/kastomer#identifying-user" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Identifying user</h3> 
  <p>We provide a simple <code>User</code> class:</p> 
  <pre><code>case class User(id: String, email: String, data: Any)
</code></pre> 
  <p>The <code>data</code> field should be of a type serializable to json, e.g. a case class or a Map (of serializable values). See <em>JSON</em> section below for more details.</p> 
  <p>In a general case to identify request you can use code like:</p> 
  <pre><code>val source: Source[User, _] = ??? //some source, e.g. Source.single(user)
val sink = Sink.head[(Try[Int], User)] //you can of course use any other sink of your choosing
val f: Future[(Try[Int], User)] = source.via(identify).runWith()
</code></pre> 
  <p>But for a single request we recommend using a convenience <code>identifySingle</code> method:</p> 
  <pre><code>val f: Future[Int] = Source.single(user).via(identifySingle).runWith(Sink.head)
</code></pre> 
  <h3><a id="user-content-tracking-events" class="anchor" href="https://github.com/listnplay/kastomer#tracking-events" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Tracking events</h3> 
  <p>We provide a simple <code>Event</code> class:</p> 
  <pre><code>case class Event(id: String, name: String, data: Any)
</code></pre> 
  <p>The <code>data</code> field should be of a type serializable to json, e.g. a case class or a Map (of serializable values). See <em>JSON</em> section below for more details.</p> 
  <p>In a general case to track a request you can use code like:</p> 
  <pre><code>val source: Source[Event, _] = ??? //some source, e.g. Source.single(user)
val sink: Sink[(Try[Int], Event), _] = ??? //some sink of your choosing
val x = source.via(track).runWith(sink)
</code></pre> 
  <p>As with identifying users, in case of a single request, you can use convenience <code>trackSingle</code> method:</p> 
  <pre><code>val f: Future[Int] = Source.single(event).via(trackSingle).runWith(Sink.head)
</code></pre> 
  <h3><a id="user-content-delete-user" class="anchor" href="https://github.com/listnplay/kastomer#delete-user" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Delete user</h3> 
  <p>The <code>delete</code> flow takes user id as parameter. It can be used in the same way as <code>identify</code> and <code>track</code> above, but it does not return additional information with failure, as there's not much that can be done in such case. It has <code>deleteSingle</code> shortcut method, like the other flows.</p> 
  <h3><a id="user-content-configuring-http" class="anchor" href="https://github.com/listnplay/kastomer#configuring-http" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Configuring HTTP</h3> 
  <p>Under the hood, this library uses <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/snapshot/scala.html" target="_blank">Akka-Http</a> and Akka-Streams. Specifically it is based on <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/snapshot/scala/http/client-side/host-level.html#host-level-api" target="_blank">Host-Level Client Api</a>. There are several parameters that can be configured for the connection pool, see <strong>reference.conf</strong> file <code>http.host-connection-pool</code> section for their list.</p> 
  <h3><a id="user-content-json" class="anchor" href="https://github.com/listnplay/kastomer#json" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>JSON</h3> 
  <p>The library uses <a href="https://github.com/json4s/json4s#jackson" target="_blank">json4s with jackson</a> via the <a href="https://github.com/hseeberger/akka-http-json" target="_blank">akka-http-json</a> to serialize the requests. In addition to default serializers, <a href="http://www.joda.org/joda-time/" target="_blank">Joda-Time</a> and UUID are supported.</p> 
  <h3><a id="user-content-metrics-and-health" class="anchor" href="https://github.com/listnplay/kastomer#metrics-and-health" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Metrics and Health</h3> 
  <p>The library registers Health and Metrics extensions that enable Akka integration with <a href="http://metrics.dropwizard.io/" target="_blank">Dropwizard (formerly known as CodaHale) Metrics</a>.</p> 
  <p>The library automatically registers a timer with each type of flows. If you wish to access the <a href="https://github.com/erikvanoosten/metrics-scala/blob/master/src/main/scala/nl/grons/metrics/scala/Timer.scala" target="_blank">timers</a> in your code, you can get them from Kastomer instance Timer property that returns</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">nl.grons.metrics.scala.</span>{<span class="pl-v">Timer</span> <span class="pl-k">=&gt;</span> <span class="pl-v">ScalaTimer</span>}

<span class="pl-k">trait</span> <span class="pl-en">Timers</span> {
  <span class="pl-k">def</span> <span class="pl-en">health</span><span class="pl-k">:</span>   <span class="pl-en">ScalaTimer</span>
  <span class="pl-k">def</span> <span class="pl-en">identify</span><span class="pl-k">:</span> <span class="pl-en">ScalaTimer</span>
  <span class="pl-k">def</span> <span class="pl-en">track</span><span class="pl-k">:</span>    <span class="pl-en">ScalaTimer</span>
  <span class="pl-k">def</span> <span class="pl-en">delete</span><span class="pl-k">:</span>   <span class="pl-en">ScalaTimer</span>
}</pre>
  </div> 
  <p>For example: <code>K.Timer.track.count</code> or <code>K.Timer.track.mean</code></p> 
  <p>To register itself as a HealthCheck, your application needs to call <code>Health().addCheck</code> passing the Kastomer instance.</p> 
  <h2><a id="user-content-implementation" class="anchor" href="https://github.com/listnplay/kastomer#implementation" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Implementation</h2> 
  <p><code>com.featurefm.io.HttpClient</code> class provides most of the heavy lifting here. This class is part of our (<a href="http://www.feature.fm/" target="_blank">feature.fm</a>) <a href="https://github.com/ListnPlay/RiverSong" target="_blank">micro-service infrastructure</a> that provides both server and client implementation based on Akka-Http. We use the client to connect to many services, both internal and external, not just customer.io.</p> 
  <h2><a id="user-content-reactive-streams" class="anchor" href="https://github.com/listnplay/kastomer#reactive-streams" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Reactive-Streams</h2> 
  <p>Since Akka-Streams provide integration with <a href="http://www.reactive-streams.org/" target="_blank">Reactive-streams</a>, this library also provides <code>Processor</code>s that correspond to <strong>identify</strong>, <strong>track</strong> and <strong>delete</strong> flows.</p> 
  <h2><a id="user-content-advanced-example" class="anchor" href="https://github.com/listnplay/kastomer#advanced-example" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Advanced Example</h2> 
  <p>Akka-Http Site client will retry idempotent requests (according to configuration). Since <strong>identify</strong> request is a <code>PUT</code>, it is considered idempotent. But <strong>track</strong> is a <code>POST</code>, therefore if we want to retry it, we need to do it ourselves.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">com.featurefm.io.customer.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">akka.stream.scaladsl.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">scala.util.</span><span class="pl-v">_</span>
<span class="pl-k">import</span> <span class="pl-v">scala.concurrent.</span><span class="pl-v">Future</span>
<span class="pl-k">import</span> <span class="pl-v">java.util.concurrent.atomic.</span><span class="pl-v">AtomicLong</span>

<span class="pl-k">val</span> <span class="pl-en">K</span> <span class="pl-k">=</span> <span class="pl-en">Kastomer</span>()
<span class="pl-k">val</span> <span class="pl-en">track</span><span class="pl-k">:</span> <span class="pl-en">Flow</span>[<span class="pl-en">Event</span>, (<span class="pl-en">Try</span>[<span class="pl-k">Int</span>], <span class="pl-en">Event</span>), _] <span class="pl-k">=</span> <span class="pl-en">K</span>.track
<span class="pl-k">val</span> <span class="pl-en">failed</span><span class="pl-k">:</span> <span class="pl-en">Flow</span>[(<span class="pl-en">Try</span>[<span class="pl-k">Int</span>],<span class="pl-en">Event</span>), <span class="pl-en">Event</span>, _] <span class="pl-k">=</span>
  <span class="pl-en">Flow</span>[(<span class="pl-en">Try</span>[<span class="pl-k">Int</span>],<span class="pl-en">Event</span>)].filter(_._1.filter(_ <span class="pl-k">==</span> <span class="pl-c1">200</span>).isFailure).map(_._2)

<span class="pl-k">val</span> <span class="pl-en">successes</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">AtomicLong</span>()
<span class="pl-k">val</span> <span class="pl-en">countSuccess</span> <span class="pl-k">=</span>
    <span class="pl-en">Sink</span>.foreach[(<span class="pl-en">Try</span>[<span class="pl-k">Int</span>], <span class="pl-en">Event</span>)] {
      <span class="pl-k">case</span> (<span class="pl-en">Success</span>(<span class="pl-c1">200</span>), _)  <span class="pl-k">=&gt;</span> successes.incrementAndGet()
      <span class="pl-k">case</span> _ <span class="pl-k">=&gt;</span> <span class="pl-c"><span class="pl-c">//</span>do nothing</span>
    }
<span class="pl-k">val</span> <span class="pl-en">report</span><span class="pl-k">:</span> <span class="pl-en">Sink</span>[(<span class="pl-en">Try</span>[<span class="pl-k">Int</span>], <span class="pl-en">Event</span>), <span class="pl-en">Future</span>[<span class="pl-en">List</span>[<span class="pl-en">Event</span>]]] <span class="pl-k">=</span>
    <span class="pl-en">Sink</span>.fold[<span class="pl-en">List</span>[<span class="pl-en">Event</span>], (<span class="pl-en">Try</span>[<span class="pl-k">Int</span>], <span class="pl-en">Event</span>)](<span class="pl-en">List</span>[<span class="pl-en">Event</span>]()) {
      <span class="pl-k">case</span> (res, (<span class="pl-en">Success</span>(<span class="pl-c1">200</span>), event))  <span class="pl-k">=&gt;</span>
        successes.incrementAndGet()
        res
      <span class="pl-k">case</span> (res, (<span class="pl-en">Success</span>(code), event)) <span class="pl-k">=&gt;</span>
        res <span class="pl-k">:</span><span class="pl-k">+</span> event
      <span class="pl-k">case</span> (res, (<span class="pl-en">Failure</span>(e),    event)) <span class="pl-k">=&gt;</span>
        res <span class="pl-k">:</span><span class="pl-k">+</span> event
    }
<span class="pl-k">val</span> <span class="pl-en">source</span><span class="pl-k">:</span> <span class="pl-en">Source</span>[<span class="pl-en">Event</span>, _ ] <span class="pl-k">=</span> <span class="pl-k">???</span>

(source via track alsoTo countSuccess
      via failed via track <span class="pl-c"><span class="pl-c">//</span>retry failed</span>
      ).runWith(report)</pre>
  </div> 
 </article>
</div>