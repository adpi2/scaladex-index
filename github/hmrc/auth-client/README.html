<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-auth-client" class="anchor" href="https://github.com/hmrc/auth-client#auth-client" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>auth-client</h1> 
  <p><a href="https://travis-ci.org/hmrc/play-auth" target="_blank"><img src="https://camo.githubusercontent.com/1cbcc5ffbe98dff0943ad67fd02a58ec2a165a6c/68747470733a2f2f7472617669732d63692e6f72672f686d72632f706c61792d617574682e737667" alt="Build Status" data-canonical-src="https://travis-ci.org/hmrc/play-auth.svg" style="max-width:100%;"></a> <a href="https://bintray.com/hmrc/releases/play-auth/_latestVersion" target="_blank"> <img src="https://camo.githubusercontent.com/9a431737260bdde5644c04bcb744b1402fe2f57e/68747470733a2f2f6170692e62696e747261792e636f6d2f7061636b616765732f686d72632f72656c65617365732f706c61792d617574682f696d616765732f646f776e6c6f61642e737667" alt="Download" data-canonical-src="https://api.bintray.com/packages/hmrc/releases/play-auth/images/download.svg" style="max-width:100%;"> </a> <a href="http://www.apache.org/licenses/LICENSE-2.0.html" target="_blank"><img src="https://camo.githubusercontent.com/d00d3a7dec5b7f60761b739a5e3b3447eaac743e/687474703a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4170616368652d627269676874677265656e2e737667" alt="Apache-2.0 license" data-canonical-src="http://img.shields.io/badge/license-Apache-brightgreen.svg" style="max-width:100%;"></a></p> 
  <p>Library for supporting user authorisation on microservices.</p> 
  <h2><a id="user-content-installing" class="anchor" href="https://github.com/hmrc/auth-client#installing" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Installing</h2> 
  <p>Include the following dependency in your SBT build</p> 
  <div class="highlight highlight-source-scala">
   <pre>resolvers <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-en">Resolver</span>.bintrayRepo(<span class="pl-s"><span class="pl-pds">"</span>hmrc<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>releases<span class="pl-pds">"</span></span>)
 
libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>uk.gov.hmrc<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>auth-client<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>[INSERT-VERSION]<span class="pl-pds">"</span></span></pre>
  </div> 
  <h2><a id="user-content-usage" class="anchor" href="https://github.com/hmrc/auth-client#usage" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Usage</h2> 
  <h3><a id="user-content-using-the-function-wrapper" class="anchor" href="https://github.com/hmrc/auth-client#using-the-function-wrapper" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using the function wrapper</h3> 
  <p>First, in any controller, service or connector where you want to protect any part of your logic, mix in the AuthorisedFunctions trait:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> AuthorisedFunctions mixin</span>
<span class="pl-k">class</span> <span class="pl-en">MyController</span> <span class="pl-k">@</span><span class="pl-en">Inject</span>() (<span class="pl-k">val</span> <span class="pl-en">authConnector</span><span class="pl-k">:</span> <span class="pl-en">AuthConnector</span>) <span class="pl-k">extends</span> <span class="pl-e">BaseController</span> <span class="pl-k">with</span> <span class="pl-e">AuthorisedFunctions</span> {
  
}</pre>
  </div> 
  <p>The AuthConnector instance itself is then usually defined somewhere in your wiring setup:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> AuthConnector Wiring</span>

<span class="pl-k">class</span> <span class="pl-en">ConcreteAuthConnector</span>(<span class="pl-k">val</span> <span class="pl-en">serviceUrl</span><span class="pl-k">:</span> <span class="pl-k">String</span>
                            <span class="pl-k">val</span> <span class="pl-en">http</span><span class="pl-k">:</span> <span class="pl-en">HttpPost</span>) <span class="pl-k">extends</span> <span class="pl-e">PlayAuthConnector</span>
 
<span class="pl-k">class</span> <span class="pl-en">MyWSHttp</span> <span class="pl-k">extends</span> <span class="pl-e">WSHttp</span> {
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">hooks</span><span class="pl-k">:</span> <span class="pl-en">Seq</span>[<span class="pl-en">HttpHook</span>] <span class="pl-k">=</span> <span class="pl-en">NoneRequired</span>
}</pre>
  </div> 
  <hr> 
  <p>Depending on your requirements, you can define 0 to any number of predicates defining your authorisation logic, as well as 0 to any number of data retrievals from the current authority that you intend to use inside the function wrapper. In the simplest case (no authorisation predicates, no data retrieval) you can use an empty wrapper like this:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> Without Predicates</span>
authorised() {
  <span class="pl-c"><span class="pl-c">//</span> your protected logic</span>
}</pre>
  </div> 
  <p>The minimal check that this code will still do is that the user is currently logged into the MDTP platform and has a bearer token in their session that is not yet expired. In case these conditions are not met, the function body will not execute. If you do have a few authorisation requirements, you can pass them to the authorise function:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> With Predicates</span>
authorised(<span class="pl-en">Enrolment</span>(<span class="pl-s"><span class="pl-pds">"</span>SOME-ENROLMENT<span class="pl-pds">"</span></span>) and <span class="pl-en">AuthProvider</span>(<span class="pl-en">GovernmentGateway</span>)) {
  
  <span class="pl-c"><span class="pl-c">//</span> your protected logic</span>
}</pre>
  </div> 
  <p>In this example we require that the user has a SOME-ENROLMENT enrolment and only accept users logged in via Government Gateway. There are many other predicates that can be freely combined with and and/or or.</p> 
  <p>If you also want load some data for the current authority, add a retrieval call after the authorisation logic:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> With Data Retrieval</span>
<span class="pl-k">import</span> <span class="pl-v">uk.gov.hmrc.auth.core.Retrievals.</span><span class="pl-v">_</span>
  
authorised(<span class="pl-en">Enrolment</span>(<span class="pl-s"><span class="pl-pds">"</span>SOME-ENROLMENT)).retrieve(externalId) { externalId =&gt;</span>
<span class="pl-s"> </span>
<span class="pl-s">  // your protected logic</span>
<span class="pl-s">}</span></pre>
  </div> 
  <p>Here we specify that we want to retrieve the externalId of the current user, which is a stable identifier that can be used by external systems to key data for that user. Note that the function block now takes a parameter, which gives you the requested data in a type-safe manner. For all available retrieval options see the section on Retrievals below. If you request more than one data item, they will be passed in a flexible wrapper that can be best accessed via a pattern match in the body:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-c"><span class="pl-c">//</span> Multiple Data Retrievals</span>
<span class="pl-k">import</span> <span class="pl-v">uk.gov.hmrc.auth.core.Retrievals.</span><span class="pl-v">_</span>
  
authorised(<span class="pl-en">Enrolment</span>(<span class="pl-s"><span class="pl-pds">"</span>SOME-ENROLMENT<span class="pl-pds">"</span></span>)).retrieve(internalId and userDetailsUri) {
 
  <span class="pl-k">case</span> internalId <span class="pl-k">~</span> userDetailsUri <span class="pl-k">=&gt;</span> <span class="pl-c"><span class="pl-c">//</span> your protected logic</span>
}</pre>
  </div> 
  <hr> 
  <h3><a id="user-content-using-play-configuration" class="anchor" href="https://github.com/hmrc/auth-client#using-play-configuration" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using Play Configuration</h3> 
  <p>The following shows an example for a configuration for two controllers:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-s">controllers {</span>
 
  <span class="pl-s">authorisation {</span>
 
    <span class="pl-s">sa = {</span>
      <span class="pl-s">patterns = [</span>
        <span class="pl-s"><span class="pl-pds">"</span>/my-service/enrolment1/:identifier<span class="pl-pds">"</span></span>
        <span class="pl-s"><span class="pl-pds">"</span>/other-service/enrolment1/:identifier/<span class="pl-pds">"</span></span>
      <span class="pl-s">]</span>
      <span class="pl-s">predicates = [{</span>
        <span class="pl-s">enrolment = "ENROLMENT1"</span>
        <span class="pl-s">identifiers = [{ key = "SOME-IDENTIFIER-KEY", value = "identifier" }]</span>
      <span class="pl-s">}]</span>
    <span class="pl-s">}</span>
 
    <span class="pl-s">ct = {</span>
      <span class="pl-s">patterns = [</span>
        <span class="pl-s"><span class="pl-pds">"</span>/my-service/enrolment2/:identifier<span class="pl-pds">"</span></span>
        <span class="pl-s"><span class="pl-pds">"</span>/other-service/enrolment2/:identifier/:rest<span class="pl-pds">"</span></span>
      <span class="pl-s">]</span>
      <span class="pl-s">predicates = [{</span>
        <span class="pl-s">enrolment = "ENROLMENT2"</span>
        <span class="pl-s">identifiers = [{ key = "SOME-IDENTIFIER-KEY", value = "identifier" }]</span>
      <span class="pl-s">}]</span>
    <span class="pl-s">}</span>
 
  <span class="pl-s">}</span>
 
  <span class="pl-s">foo.FooController = {</span>
    <span class="pl-s">authorisedBy = ["enrolment1", "enrolment2"]</span>
    <span class="pl-s">needsLogging = false</span>
    <span class="pl-s">needsAuditing = false</span>
  <span class="pl-s">}</span>
 
  <span class="pl-s">bar.BarController = {</span>
    <span class="pl-s">authorisedBy = ["enrolment1"]</span>
    <span class="pl-s">needsLogging = false</span>
    <span class="pl-s">needsAuditing = false</span>
  <span class="pl-s">}</span>
 
<span class="pl-s">}</span></pre>
  </div> 
  <p>The example shows all aspects you need to define for protecting your endpoints:</p> 
  <h4><a id="user-content-1-add-one-or-more-authorisation-sections" class="anchor" href="https://github.com/hmrc/auth-client#1-add-one-or-more-authorisation-sections" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>1. Add one or more authorisation sections</h4> 
  <p>Inside the controllers section in the play configuration for your microservice, add an authorisation section, that contains one or more sections that define a concrete authorisation setup. In the example there are two sections named enrolment1 and enrolment2 respectively.</p> 
  <h4><a id="user-content-2-specify-one-or-more-uri-patterns-in-each-authorisation-section" class="anchor" href="https://github.com/hmrc/auth-client#2-specify-one-or-more-uri-patterns-in-each-authorisation-section" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>2. Specify one or more URI patterns in each authorisation section</h4> 
  <p>Within these sections, define one or more patterns for URIs that should be affected by this configuration. In the example both sections contain two path patterns each:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-s">patterns = [</span>
  <span class="pl-s"><span class="pl-pds">"</span>/my-service/enrolment1/:identifier<span class="pl-pds">"</span></span>
  <span class="pl-s"><span class="pl-pds">"</span>/other-service/enrolment1/:identifier/<span class="pl-pds">"</span></span>
<span class="pl-s">]</span></pre>
  </div> 
  <p>Note that the pattern syntax is close to the one used for Play routes definition, it is not a regular expression like in our older library. Both paths above have several literal path elements like enrolment1, and one dynamic path element each (:identifier). These dynamic path elements match any string and the actual concrete value can be referred to in the predicate definitions as shown further below. For each incoming request the paths will be tried against the URI of the request in the order they are defined until one of them matches.</p> 
  <h4><a id="user-content-3-specify-zero-or-more-predicates-in-each-authorisation-section" class="anchor" href="https://github.com/hmrc/auth-client#3-specify-zero-or-more-predicates-in-each-authorisation-section" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>3. Specify zero or more predicates in each authorisation section</h4> 
  <p>Below the path patterns, define zero or any number of predicates that define the authorisation requirements for each incoming request:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-s">predicates = [{</span>
  <span class="pl-s">enrolment = "ENROLMENT1"</span>
  <span class="pl-s">identifiers = [{ key = "SOME-IDENTIFIER-KEY", value = "identifier" }]</span>
<span class="pl-s">}]</span></pre>
  </div> 
  <p>In this example there is just one predicate. It specifies that the current user has to have an ENROLMENT-1 enrolment with a specific SOME-IDENTIFIER-KEY extracted from the URI. This ensures that all calls happen in this specific context. But as you see the predicates property is an array, so you can specify any number of predicates. They are combined with an implicit AND, if you need an OR combinator, you can use a mongo-style $or property:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-s">predicates = [{</span>
  <span class="pl-s">$or = [</span>
    <span class="pl-s">{ affinityGroup = "Organisation" }</span>
    <span class="pl-s">{ affinityGroup = "Individual" }</span>
  <span class="pl-s">]</span>
<span class="pl-s">}]</span></pre>
  </div> 
  <p>Here the endpoint is blocked for all agents, as we only allow either Organisations or Individuals in. Finally, like with the Scala API you can omit predicates altogether with an empty array:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-s">predicates = []</span></pre>
  </div> 
  <p>In this case the filter will only check that the user is currently logged into the platform and has a bearer token in her session that is not yet expired. For all the available predicates you can use see the Predicate Reference page.</p> 
  <h4><a id="user-content-4-link-protected-controllers-to-the-authorisation-sections-you-defined" class="anchor" href="https://github.com/hmrc/auth-client#4-link-protected-controllers-to-the-authorisation-sections-you-defined" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>4. Link protected controllers to the authorisation sections you defined.</h4> 
  <p>In our example one controller is linked to 2 authorisation presets:</p> 
  <div class="highlight highlight-source-yaml">
   <pre><span class="pl-s">foo.FooController = {</span>
  <span class="pl-s">authorisedBy = ["enrolment1", "enrolment2"]</span>
  <span class="pl-s">needsLogging = false</span>
  <span class="pl-s">needsAuditing = false</span>
<span class="pl-s">}</span></pre>
  </div> 
  <p>Here it will first try the 2 patterns defined in the "enrolment1" preset, and if any of the 2 matches, apply the predicates defined in there. If none of them matches, it tries the 2 patterns defined in the enrolment2 preset, and again, if any of the 2 matches, applies the predicates in that section. If no pattern matches it is considered an insecure call which will lead to a 401 response. This is to avoid that a new endpoint that got added to an existing controller with a pattern that does not match does not accidentally become unprotected. As a consequence this means that within a single controller all endpoints are either protected or not. If you need more flexibility, use the Scala API inside your controller implementations. If you want to leave a controller unprotected, simply omit the authorisedBy predicate.</p> 
  <hr> 
  <h3><a id="user-content-error-handling" class="anchor" href="https://github.com/hmrc/auth-client#error-handling" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Error handling</h3> 
  <h4><a id="user-content-backends" class="anchor" href="https://github.com/hmrc/auth-client#backends" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Backends</h4> 
  <p>For backend services you usually do not want to explicitly handle unauthorised calls. It is usually the task of a frontend to determine whether a user is allowed to perform a certain action and then the frontend implementation ensures that all calls to backend services happen in an authorised context. If this is not the case, it is best to let the 401 response bubble back up to the frontend.</p> 
  <h4><a id="user-content-frontends" class="anchor" href="https://github.com/hmrc/auth-client#frontends" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Frontends</h4> 
  <p>In frontends you would usually want to avoid letting 401 responses bubble up to the user, so you have two options to recover from such a failure:</p> 
  <p><em>Centralised Recovery in the Global object</em></p> 
  <p>In many frontends, the recovery from certain types of authorisation failures will probably be similar. So keeping the logic in the Global object is convenient.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">object</span> <span class="pl-en">MyGlobal</span> <span class="pl-k">extends</span> <span class="pl-e">DefaultFrontendGlobal</span> {
  
  <span class="pl-k">def</span> <span class="pl-en">resolveError</span>(<span class="pl-v">rh</span>: <span class="pl-en">RequestHeader</span>, <span class="pl-v">ex</span>: <span class="pl-en">Throwable</span>) <span class="pl-k">=</span> ex <span class="pl-k">match</span> {
 
    <span class="pl-k">case</span> <span class="pl-v">ex</span>: <span class="pl-en">InsufficientEnrolments</span> <span class="pl-k">=&gt;</span> <span class="pl-c"><span class="pl-c">//</span> your custom recovery logic, usually redirects</span>
 
    <span class="pl-k">case</span> _ <span class="pl-k">=&gt;</span> <span class="pl-c1">super</span>.resolveError(rh, ex)
 
  }
}</pre>
  </div> 
  <p><em>Individual Recoveries in Controllers</em></p> 
  <p>In rare cases where a single endpoint would require custom recovery logic, you can add it immediately after the authorised block in your controller logic:</p> 
  <div class="highlight highlight-source-scala">
   <pre>authorised(<span class="pl-en">Enrolment</span>(<span class="pl-s"><span class="pl-pds">"</span>SOME-ENROLMENT<span class="pl-pds">"</span></span>)) {
  
  <span class="pl-c"><span class="pl-c">//</span> your protected logic</span>
} recoverWith {
  
  <span class="pl-k">case</span> <span class="pl-v">ex</span>: <span class="pl-en">InsufficientEnrolments</span> <span class="pl-k">=&gt;</span> <span class="pl-c"><span class="pl-c">//</span> your custom recovery logic, usually redirects</span>
}</pre>
  </div> 
  <h3><a id="user-content-authorisation-exceptions" class="anchor" href="https://github.com/hmrc/auth-client#authorisation-exceptions" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Authorisation Exceptions</h3> 
  <p>Whenever the auth microservice returns a 401 response to the library, it will contain a <code>WWW-Authenticate</code> header with details about the failure which will then be translated to a custom exception. They are all a subtype of <code>AuthorisationException</code>. This is the complete list of possible exceptions:</p> 
  <ul> 
   <li>InsufficientEnrolments: One or more of the requested enrolments were not present in the authority</li> 
   <li>InsufficientConfidenceLevel: The confidence level requested for one of the enrolments was too low</li> 
   <li>UnsupportedAuthProvider: the provider for the current authority is not one of the providers your auth predicates listed as accepted</li> 
   <li>UnsupportedAffinityGroup: the requested affinityGroup did not match the one in the authority or the user is not a GG user</li> 
   <li>UnsupportedCredentialRole: the requested credentialRole did not match the one in the authority or the user is not a GG user</li> 
   <li>NoActiveSession: The user does not have an active session. This is an abstract type with 4 concrete subtypes, but you would usually handle all 4 types in the same way (most often by redirecting to the login page). The 4 subtypes are: MissingBearerToken (the user was probably not logged in), BearerTokenExpired (the user was logged in, but the session is expired), and two types which should never occur as they would hint at an internal error: InvalidBearerToken and SessionRecordNotFound.</li> 
  </ul> 
  <h2><a id="user-content-whitelisting--otac" class="anchor" href="https://github.com/hmrc/auth-client#whitelisting--otac" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Whitelisting / OTAC</h2> 
  <p>The library includes functional wrapper for whitelisting / OTAC authorisation, which used to be in passcode-verification.</p> 
  <h3><a id="user-content-using-the-otac-function-wrapper" class="anchor" href="https://github.com/hmrc/auth-client#using-the-otac-function-wrapper" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using the OTAC function wrapper</h3> 
  <p>First, in any controller, service or connector where you want to protect any part of your logic, mix in the OtacAuthorisationFunctions trait:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">class</span> <span class="pl-en">MyController</span> <span class="pl-k">@</span><span class="pl-en">Inject</span>() (<span class="pl-k">val</span> <span class="pl-en">authConnector</span><span class="pl-k">:</span> <span class="pl-en">AuthConnector</span>) <span class="pl-k">extends</span> <span class="pl-e">BaseController</span> <span class="pl-k">with</span> <span class="pl-e">OtacAuthorisationFunctions</span> {

}</pre>
  </div> 
  <p>The OtacAuthConnector instance itself is then usually defined somewhere in your wiring setup:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">class</span> <span class="pl-en">ConcreteOtacAuthConnector</span>(<span class="pl-k">val</span> <span class="pl-en">serviceUrl</span><span class="pl-k">:</span> <span class="pl-k">String</span>,
                                <span class="pl-k">val</span> <span class="pl-en">http</span><span class="pl-k">:</span> <span class="pl-en">HttpGet</span>) <span class="pl-k">extends</span> <span class="pl-e">PlayOtacAuthConnector</span>

<span class="pl-k">class</span> <span class="pl-en">MyWSHttp</span> <span class="pl-k">extends</span> <span class="pl-e">WSHttp</span> {
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">hooks</span><span class="pl-k">:</span> <span class="pl-en">Seq</span>[<span class="pl-en">HttpHook</span>] <span class="pl-k">=</span> <span class="pl-en">NoneRequired</span>
}</pre>
  </div> 
  <hr> 
  <p>Once that is set up you can use the OTAC functional wrapper in your controller:</p> 
  <pre><code>withVerifiedPasscode("myServiceName") {
  // your protected logic
}
</code></pre> 
  <p>Note that the function does not extract any data from the config the way passcode-verification did, so you need to provide the service name (previously called "regime") explicitly.</p> 
  <h2><a id="user-content-license" class="anchor" href="https://github.com/hmrc/auth-client#license" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>License</h2> 
  <p>This code is open source software licensed under the Apache 2.0 License.</p> 
 </article>
</div>