<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <p><strong>zap-automation</strong></p> 
  <p>This is a library utilising the <a href="https://www.owasp.org/index.php/OWASP_Zed_Attack_Proxy_Project" target="_blank">ZAP</a> API, with pre configured steps to run a spider attack and then an active scan.</p> 
  <h3><a id="user-content-run-the-unit-tests-for-the-library" class="anchor" href="https://github.com/hmrc/zap-automation#run-the-unit-tests-for-the-library" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Run the unit tests for the library</h3> 
  <div class="highlight highlight-source-scala">
   <pre>sbt test</pre>
  </div> 
  <h3><a id="user-content-adding-to-your-build" class="anchor" href="https://github.com/hmrc/zap-automation#adding-to-your-build" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Adding to your build</h3> 
  <p>In your SBT build add:</p> 
  <div class="highlight highlight-source-scala">
   <pre>resolvers <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-en">Resolver</span>.bintrayRepo(<span class="pl-s"><span class="pl-pds">"</span>hmrc<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>releases<span class="pl-pds">"</span></span>)

libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>uk.gov.hmrc<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>zap-automation<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>x.x.x<span class="pl-pds">"</span></span></pre>
  </div> 
  <h3><a id="user-content-how-to-use-the-library" class="anchor" href="https://github.com/hmrc/zap-automation#how-to-use-the-library" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>How to use the library</h3> 
  <ul> 
   <li>You will likely want to have a way to run some tests from the UI of the service/application you are testing, so that ZAP can learn about the URLs it needs to test.</li> 
   <li>You will also need to install and setup ZAP either locally, or on your build machine in order to use this library.</li> 
   <li>You will need a way to run the library, we have done this by using this file:</li> 
  </ul> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">package</span> <span class="pl-en">utils.Support</span>

<span class="pl-k">import</span> <span class="pl-v">uk.gov.hmrc.</span>{<span class="pl-v">ZapAlertFilter</span>, <span class="pl-v">ZapTest</span>}

<span class="pl-k">class</span> <span class="pl-en">ZapRunner</span> <span class="pl-k">extends</span> <span class="pl-e">ZapTest</span>{

<span class="pl-c">  <span class="pl-c">/**</span></span>
<span class="pl-c">    * zapBaseUrl is a required field - you'll need to set it in this file, for your project to compile.</span>
<span class="pl-c">    * It will rarely need to be changed. We've included it as an overridable field</span>
<span class="pl-c">    * for flexibility and just in case.</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">zapBaseUrl</span><span class="pl-k">:</span> <span class="pl-k">String</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>xxx<span class="pl-pds">"</span></span>

<span class="pl-c">  <span class="pl-c">/**</span></span>
<span class="pl-c">    * testUrl is a required field - you'll need to set it in this file, for your project to compile.</span>
<span class="pl-c">    * It needs to be the URL of the start page of your application (not just localhost:port).</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">testUrl</span><span class="pl-k">:</span> <span class="pl-k">String</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>xxx<span class="pl-pds">"</span></span>

<span class="pl-c">  <span class="pl-c">/**</span></span>
<span class="pl-c">    * alertsBaseUrl is not a required field. This is the url that the zap-automation library</span>
<span class="pl-c">    * will use to filter out the alerts that are shown to you. Note that while Zap is doing</span>
<span class="pl-c">    * testing, it is likely to find alerts from other services that you don't own - for example</span>
<span class="pl-c">    * from logging in, therefore we recommend that you set this to be the base url for the</span>
<span class="pl-c">    * service you are interested in.</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">alertsBaseUrl</span><span class="pl-k">:</span> <span class="pl-k">String</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>xxx<span class="pl-pds">"</span></span>

<span class="pl-c">  <span class="pl-c">/**</span></span>
<span class="pl-c">    * contextBaseUrl is not a required field. This url is added as the base url to your</span>
<span class="pl-c">    * context.</span>
<span class="pl-c">    * A context is a construct in Zap that limits the scope of any attacks run to a</span>
<span class="pl-c">    * particular domain (this doesn't mean that Zap won't find alerts on other services during the</span>
<span class="pl-c">    * browser test run).</span>
<span class="pl-c">    * This would usually be the base url of your service - eg http://localhost:xxxx.*</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">contextBaseUrl</span><span class="pl-k">:</span> <span class="pl-k">String</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>xxx.*<span class="pl-pds">"</span></span>

<span class="pl-c">  <span class="pl-c">/**</span></span>
<span class="pl-c">    * desiredTechnologyNames is not a required field. We recommend you don't change this</span>
<span class="pl-c">    * field, as we've made basic choices for the platform. We made it overridable just in case</span>
<span class="pl-c">    * your service differs from the standards of the Platform.</span>
<span class="pl-c">    *</span>
<span class="pl-c">    * The technologies that you put here will limit the amount of checks that ZAP will do to</span>
<span class="pl-c">    * just the technologies that are relevant. The default technologies are set to</span>
<span class="pl-c">    * "OS,OS.Linux,Language,Language.Xml,SCM,SCM.Git".</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-c"><span class="pl-c">//</span>override val desiredTechnologyNames: String = ""</span>
  
<span class="pl-c">    <span class="pl-c">/**</span></span>
<span class="pl-c">    * routesToBeIgnoredFromContext is not a required field. You may set this if you have any routes</span>
<span class="pl-c">    * that are part of your application, but you do not want tested. For example, if you had any</span>
<span class="pl-c">    * test-only routes, you could force Zap not to test them by adding them in here as a regex.</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-c"><span class="pl-c">//</span>override val routeToBeIgnoredFromContext: String = "xxx"</span>

<span class="pl-c">  <span class="pl-c">/**</span></span>
<span class="pl-c">    * If, when you run the Zap tests, you find alerts that you have investigated and don't see as a problem</span>
<span class="pl-c">    * you can filter them out using this code, on the cweid and the url that the alert was found on.</span>
<span class="pl-c">    * The CWE ID is a Common Weakness Enumeration (http://cwe.mitre.org/data/index.html), you can</span>
<span class="pl-c">    * find this by looking at the alert output from your tests.</span>
<span class="pl-c">    * As part of the trial, please try</span>
<span class="pl-c">    * filtering out a few alerts and seeing if this functionality works for you.</span>
<span class="pl-c">    * Below you can see an example of how this might work.</span>
<span class="pl-c">    <span class="pl-c">*/</span></span>
  <span class="pl-k">val</span> <span class="pl-en">alertToBeIgnored1</span><span class="pl-k">:</span> <span class="pl-en">ZapAlertFilter</span> <span class="pl-k">=</span> <span class="pl-en">ZapAlertFilter</span>(cweid <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>16<span class="pl-pds">"</span></span>, url <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>xxx<span class="pl-pds">"</span></span>)
  <span class="pl-k">override</span> <span class="pl-k">val</span> <span class="pl-en">alertsToIgnore</span><span class="pl-k">:</span> <span class="pl-en">List</span>[<span class="pl-en">ZapAlertFilter</span>] <span class="pl-k">=</span> <span class="pl-en">List</span>(alertToBeIgnored1)

}</pre>
  </div> 
  <ul> 
   <li>You’ll need to be able to create a new browser profile for ZAP, and switch your browser to this new profile. We’ve done this using this code:</li> 
  </ul> 
  <div class="highlight highlight-source-scala">
   <pre>  <span class="pl-k">def</span> <span class="pl-en">createZapDriver</span><span class="pl-k">:</span> <span class="pl-en">WebDriver</span> <span class="pl-k">=</span> {
    <span class="pl-k">val</span> <span class="pl-en">profile</span><span class="pl-k">:</span> <span class="pl-en">FirefoxProfile</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">FirefoxProfile</span>
    profile.setAcceptUntrustedCertificates(<span class="pl-c1">true</span>)
    profile.setPreference(<span class="pl-s"><span class="pl-pds">"</span>network.proxy.type<span class="pl-pds">"</span></span>, <span class="pl-c1">1</span>)
    profile.setPreference(<span class="pl-s"><span class="pl-pds">"</span>network.proxy.http<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>localhost<span class="pl-pds">"</span></span>)
    profile.setPreference(<span class="pl-s"><span class="pl-pds">"</span>network.proxy.http_port<span class="pl-pds">"</span></span>, <span class="pl-c1">11000</span>)
    profile.setPreference(<span class="pl-s"><span class="pl-pds">"</span>network.proxy.share_proxy_settings<span class="pl-pds">"</span></span>, <span class="pl-c1">true</span>)
    profile.setPreference(<span class="pl-s"><span class="pl-pds">"</span>network.proxy.no_proxies_on<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span><span class="pl-pds">"</span></span>)
    <span class="pl-k">val</span> <span class="pl-en">options</span><span class="pl-k">:</span> <span class="pl-en">FirefoxOptions</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">FirefoxOptions</span>
    options.setLegacy(<span class="pl-c1">true</span>)
    <span class="pl-k">val</span> <span class="pl-en">firefoxCapabilities</span><span class="pl-k">:</span> <span class="pl-en">DesiredCapabilities</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">DesiredCapabilities</span>()
    firefoxCapabilities.setCapability(<span class="pl-en">FirefoxDriver</span>.<span class="pl-en">PROFILE</span>, profile)
    firefoxCapabilities.setCapability(<span class="pl-s"><span class="pl-pds">"</span>marionette<span class="pl-pds">"</span></span>, <span class="pl-c1">false</span>)
    options.addDesiredCapabilities(firefoxCapabilities)
    <span class="pl-k">val</span> <span class="pl-en">capabilities</span> <span class="pl-k">=</span> options.toDesiredCapabilities
    println(<span class="pl-s"><span class="pl-pds">"</span>Running ZAP Firefox Driver<span class="pl-pds">"</span></span>)
    <span class="pl-k">new</span> <span class="pl-en">FirefoxDriver</span>(capabilities)
  }
  
    <span class="pl-k">def</span> <span class="pl-en">createZapChromeDriver</span><span class="pl-k">:</span> <span class="pl-en">WebDriver</span> <span class="pl-k">=</span> {
    <span class="pl-k">var</span> <span class="pl-en">options</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">ChromeOptions</span>()
    <span class="pl-k">var</span> <span class="pl-en">capabilities</span> <span class="pl-k">=</span> <span class="pl-en">DesiredCapabilities</span>.chrome()
    options.addArguments(<span class="pl-s"><span class="pl-pds">"</span>test-type<span class="pl-pds">"</span></span>)
    options.addArguments(<span class="pl-s"><span class="pl-pds">"</span>--proxy-server=http://localhost:11000<span class="pl-pds">"</span></span>)
    capabilities.setCapability(<span class="pl-en">ChromeOptions</span>.<span class="pl-en">CAPABILITY</span>, options)
    <span class="pl-k">val</span> <span class="pl-en">driver</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">ChromeDriver</span>(capabilities)
    <span class="pl-k">val</span> <span class="pl-en">caps</span> <span class="pl-k">=</span> driver.getCapabilities
    <span class="pl-k">val</span> <span class="pl-en">browserName</span> <span class="pl-k">=</span> caps.getBrowserName
    <span class="pl-k">val</span> <span class="pl-en">browserVersion</span> <span class="pl-k">=</span> caps.getVersion
    println( <span class="pl-s"><span class="pl-pds">"</span>Browser name &amp; version: <span class="pl-pds">"</span></span><span class="pl-k">+</span> browserName<span class="pl-k">+</span><span class="pl-s"><span class="pl-pds">"</span> <span class="pl-pds">"</span></span><span class="pl-k">+</span>browserVersion)
    driver
  }</pre>
  </div> 
  <h3><a id="user-content-run-the-zap-tests-on-your-machine" class="anchor" href="https://github.com/hmrc/zap-automation#run-the-zap-tests-on-your-machine" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Run the ZAP tests on your machine</h3> 
  <ul> 
   <li>Start your application locally</li> 
   <li>Start ZAP from the command line:</li> 
   <li> 
    <ul> 
     <li>Change directory to where ZAP is installed (default Mac installation is in the root Applications directory: /Applications)</li> 
    </ul> </li> 
   <li> 
    <ul> 
     <li>Run this command: ZAP\ 2.6.0.app/Contents/Java/zap.sh -daemon -config api.disablekey=true -port 11000</li> 
    </ul> </li> 
   <li>Run your acceptance tests pointing at your new ZAP profile. Our command to do this looks like this: <code>sbt -Dbrowser=zap -Denvironment=Local ‘test-only Suites.RunZapTests’</code></li> 
  </ul> 
  <p>You need to make sure you run enough UI tests to hit all the urls that you want to run your ZAP tests on. This may be all of your tests or a subset, it’s up to you. Run the penetration tests (using your new ZapRunner file) - our command to do this looks like this: <code>sbt "testOnly utils.Support.ZapRunner"</code></p> 
  <h3><a id="user-content-how-do-we-read-the-output-of-the-tests" class="anchor" href="https://github.com/hmrc/zap-automation#how-do-we-read-the-output-of-the-tests" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>How do we read the output of the tests?</h3> 
  <p>Green build - no html report is created as there are no alerts to give you more information about. If you are surprised about getting a green build, if may be that you need to adjust the variables you are passing to the library, or you may not have run enough UI tests proxying through ZAP. If you have doubts please contact us. Red build - alerts are printed in the console and a html report is created on the workspace. Note that the report will be deleted each time a new build is started.</p> 
  <h3><a id="user-content-supported-browsers" class="anchor" href="https://github.com/hmrc/zap-automation#supported-browsers" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Supported browsers</h3> 
  <p>We have tested the library using Chrome and Firefox.</p> 
  <h3><a id="user-content-license" class="anchor" href="https://github.com/hmrc/zap-automation#license" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>License</h3> 
  <p>This code is open source software licensed under the Apache 2.0 License.</p> 
 </article>
</div>