<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <h1><a id="user-content-spark-ext" class="anchor" href="https://github.com/collectivemedia/spark-ext#spark-ext" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Spark Ext</h1> 
  <p><a href="https://travis-ci.org/collectivemedia/spark-ext" target="_blank"><img src="https://camo.githubusercontent.com/2f85498f0833741f5f1db009578c5d5825e0ec2c/68747470733a2f2f7472617669732d63692e6f72672f636f6c6c6563746976656d656469612f737061726b2d6578742e7376673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/collectivemedia/spark-ext.svg?branch=master" style="max-width:100%;"></a></p> 
  <p>Spark ML transformers, estimator, Spark SQL aggregations, etc that are missing in Apache Spark.</p> 
  <p>That's how we are doing <a href="https://databricks.com/blog/2015/10/20/audience-modeling-with-spark-ml-pipelines.html" target="_blank">Audience Modeling</a> at Collective</p> 
  <h2><a id="user-content-where-to-get-it" class="anchor" href="https://github.com/collectivemedia/spark-ext#where-to-get-it" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Where to get it</h2> 
  <div class="highlight highlight-source-scala">
   <pre>resolvers <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>Collective Media Bintray<span class="pl-pds">"</span></span> at <span class="pl-s"><span class="pl-pds">"</span>https://dl.bintray.com/collectivemedia/releases<span class="pl-pds">"</span></span></pre>
  </div> 
  <p>And use following library dependencies:</p> 
  <pre><code>libraryDependencies +=  "com.collective.sparkext" %% "sparkext-sql" % "0.0.23"
libraryDependencies +=  "com.collective.sparkext" %% "sparkext-mllib" % "0.0.23"
</code></pre> 
  <h2><a id="user-content-testing" class="anchor" href="https://github.com/collectivemedia/spark-ext#testing" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Testing</h2> 
  <pre><code>sbt test
</code></pre> 
  <h2><a id="user-content-spark-sql" class="anchor" href="https://github.com/collectivemedia/spark-ext#spark-sql" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Spark SQL</h2> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">schema</span> <span class="pl-k">=</span> <span class="pl-en">StructType</span>(<span class="pl-en">Seq</span>(
  <span class="pl-en">StructField</span>(<span class="pl-s"><span class="pl-pds">"</span>cookie_id<span class="pl-pds">"</span></span>, <span class="pl-en">StringType</span>),
  <span class="pl-en">StructField</span>(<span class="pl-s"><span class="pl-pds">"</span>site<span class="pl-pds">"</span></span>, <span class="pl-en">StringType</span>),
  <span class="pl-en">StructField</span>(<span class="pl-s"><span class="pl-pds">"</span>impressions<span class="pl-pds">"</span></span>, <span class="pl-en">LongType</span>)
))

<span class="pl-k">val</span> <span class="pl-en">impressionLog</span> <span class="pl-k">=</span> sqlContext.createDataFrame(sc.parallelize(<span class="pl-en">Seq</span>(
  <span class="pl-en">Row</span>(<span class="pl-s"><span class="pl-pds">"</span>cookie_1<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>google.com<span class="pl-pds">"</span></span>, <span class="pl-c1">10L</span>),
  <span class="pl-en">Row</span>(<span class="pl-s"><span class="pl-pds">"</span>cookie_2<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>cnn.com<span class="pl-pds">"</span></span>, <span class="pl-c1">14L</span>),
  ...
)), schema)</pre>
  </div> 
  <h4><a id="user-content-collectarray" class="anchor" href="https://github.com/collectivemedia/spark-ext#collectarray" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>CollectArray</h4> 
  <p>Aggregation function that collects all values from a column</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">org.apache.spark.sql.ext.functions.</span><span class="pl-v">_</span>

<span class="pl-c"><span class="pl-c">//</span> collects all sites for cookie (with duplicates)</span>
impressionLog
      .groupBy(col(<span class="pl-s"><span class="pl-pds">"</span>cookie_id<span class="pl-pds">"</span></span>))
      .agg(collectArray(col(<span class="pl-s"><span class="pl-pds">"</span>site<span class="pl-pds">"</span></span>)))</pre>
  </div> 
  <h2><a id="user-content-spark-ml" class="anchor" href="https://github.com/collectivemedia/spark-ext#spark-ml" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Spark ML</h2> 
  <h4><a id="user-content-s2-geometry-cellid-transformer" class="anchor" href="https://github.com/collectivemedia/spark-ext#s2-geometry-cellid-transformer" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>S2 Geometry CellId transformer</h4> 
  <p>Gets Google S2 Geometry CellId from decimal <code>lat</code> and <code>lon</code></p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">schema</span> <span class="pl-k">=</span> <span class="pl-en">StructType</span>(<span class="pl-en">Seq</span>(
   <span class="pl-en">StructField</span>(<span class="pl-s"><span class="pl-pds">"</span>city<span class="pl-pds">"</span></span>, <span class="pl-en">StringType</span>),
   <span class="pl-en">StructField</span>(<span class="pl-s"><span class="pl-pds">"</span>lat<span class="pl-pds">"</span></span>, <span class="pl-en">DoubleType</span>),
   <span class="pl-en">StructField</span>(<span class="pl-s"><span class="pl-pds">"</span>lon<span class="pl-pds">"</span></span>, <span class="pl-en">DoubleType</span>)
 ))

 <span class="pl-k">val</span> <span class="pl-en">cities</span> <span class="pl-k">=</span> sqlContext.createDataFrame(sc.parallelize(<span class="pl-en">Seq</span>(
   <span class="pl-en">Row</span>(<span class="pl-s"><span class="pl-pds">"</span>New York<span class="pl-pds">"</span></span>, <span class="pl-c1">40.7142700</span>, <span class="pl-k">-</span><span class="pl-c1">74.0059700</span>),
   <span class="pl-en">Row</span>(<span class="pl-s"><span class="pl-pds">"</span>London<span class="pl-pds">"</span></span>, <span class="pl-c1">51.50722</span>, <span class="pl-k">-</span><span class="pl-c1">0.12750</span>),
   <span class="pl-en">Row</span>(<span class="pl-s"><span class="pl-pds">"</span>Princeton<span class="pl-pds">"</span></span>, <span class="pl-c1">40.3487200</span>, <span class="pl-k">-</span><span class="pl-c1">74.6590500</span>)
 )), schema)
 
  <span class="pl-k">val</span> <span class="pl-en">s2CellTransformer</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">S2CellTransformer</span>().setLevel(<span class="pl-c1">6</span>)
  s2CellTransformer.transform(cities)</pre>
  </div> 
  <h4><a id="user-content-optimal-binning" class="anchor" href="https://github.com/collectivemedia/spark-ext#optimal-binning" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Optimal Binning</h4> 
  <p>Continuous features may need to be transformed to binary format using binning to account for nonlinearity. In general, binning attempts to break a set of ordered values into evenly distributed groups, such that each group contains approximately the same number of values from the sample.</p> 
  <h4><a id="user-content-gather" class="anchor" href="https://github.com/collectivemedia/spark-ext#gather" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Gather</h4> 
  <p>Inspired by R <code>tidyr</code> and <code>reshape2</code> packages. Convert <code>long</code> <code>DataFrame</code> with values for each key into <code>wide</code> <code>DataFrame</code>, applying aggregation function if single key has multiple values</p> 
  <table> 
   <thead> 
    <tr> 
     <th>cookie_id</th> 
     <th>site_id</th> 
     <th>impressions</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>cookieAA</td> 
     <td>123</td> 
     <td>10</td> 
    </tr> 
    <tr> 
     <td>cookieAA</td> 
     <td>123</td> 
     <td>5</td> 
    </tr> 
    <tr> 
     <td>cookieAA</td> 
     <td>456</td> 
     <td>20</td> 
    </tr>
   </tbody>
  </table> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">gather</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Gather</span>()
      .setPrimaryKeyCols(<span class="pl-s"><span class="pl-pds">"</span>cookie_id<span class="pl-pds">"</span></span>)
      .setKeyCol(<span class="pl-s"><span class="pl-pds">"</span>site_id<span class="pl-pds">"</span></span>)
      .setValueCol(<span class="pl-s"><span class="pl-pds">"</span>impressions<span class="pl-pds">"</span></span>)
      .setOutputCol(<span class="pl-s"><span class="pl-pds">"</span>sites<span class="pl-pds">"</span></span>)
<span class="pl-k">val</span> <span class="pl-en">gathered</span> <span class="pl-k">=</span> gather.transform(siteLog)      </pre>
  </div> 
  <table> 
   <thead> 
    <tr> 
     <th>cookie_id</th> 
     <th>sites</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>cookieAA</td> 
     <td>[{ site_id: 123, impressions: 15.0 }, { site_id: 456, impressions: 20.0 }]</td> 
    </tr>
   </tbody>
  </table> 
  <h4><a id="user-content-gather-encoder" class="anchor" href="https://github.com/collectivemedia/spark-ext#gather-encoder" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Gather Encoder</h4> 
  <p>Encode categorical key-value pairs using dummy variables.</p> 
  <table> 
   <thead> 
    <tr> 
     <th>cookie_id</th> 
     <th>sites</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>cookieAA</td> 
     <td>[{ site_id: 1, impressions: 15.0 }, { site_id: 2, impressions: 20.0 }]</td> 
    </tr> 
    <tr> 
     <td>cookieBB</td> 
     <td>[{ site_id: 2, impressions: 7.0 }, { site_id: 3, impressions: 5.0 }]</td> 
    </tr>
   </tbody>
  </table> 
  <p>transformed into</p> 
  <table> 
   <thead> 
    <tr> 
     <th>cookie_id</th> 
     <th>site_features</th> 
    </tr> 
   </thead> 
   <tbody> 
    <tr> 
     <td>cookieAA</td> 
     <td>[ 15.0 , 20.0 , 0 ]</td> 
    </tr> 
    <tr> 
     <td>cookieBB</td> 
     <td>[ 0.0 , 7.0 , 5.0 ]</td> 
    </tr>
   </tbody>
  </table> 
  <p>Optionally apply dimensionality reduction using <code>top</code> transformation:</p> 
  <ul> 
   <li>Top coverage, is selecting categorical values by computing the count of distinct users for each value, sorting the values in descending order by the count of users, and choosing the top values from the resulting list such that the sum of the distinct user counts over these values covers c percent of all users, for example, selecting top sites covering 99% of users.</li> 
  </ul> 
  <h4><a id="user-content-downsampling-negatives" class="anchor" href="https://github.com/collectivemedia/spark-ext#downsampling-negatives" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Downsampling Negatives</h4> 
  <p>If class ratio between positives and negatives is too high, you might want to downsample all you negatives before building a model.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">downsampling</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Downsampling</span>()
      .setLabelCol(<span class="pl-s"><span class="pl-pds">"</span>label<span class="pl-pds">"</span></span>)
      .setOutputCol(<span class="pl-s"><span class="pl-pds">"</span>sample_weight<span class="pl-pds">"</span></span>)
      .setMaxClassRatio(<span class="pl-c1">30.0</span>)
      .setPrimaryClass(<span class="pl-c1">1.0</span>) <span class="pl-c"><span class="pl-c">//</span> positive class to keep as-is   </span></pre>
  </div> 
 </article>
</div>