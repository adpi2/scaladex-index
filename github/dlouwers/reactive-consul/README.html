<div class="announce instapaper_body md" data-path="README.md" id="readme">
 <article class="markdown-body entry-content" itemprop="text">
  <p><a href="https://travis-ci.org/dlouwers/reactive-consul" target="_blank"><img src="https://camo.githubusercontent.com/156272c72dc1019590d479fd0f579fa51c433832/68747470733a2f2f7472617669732d63692e6f72672f646c6f75776572732f72656163746976652d636f6e73756c2e7376673f6272616e63683d6d6173746572" alt="Build Status" data-canonical-src="https://travis-ci.org/dlouwers/reactive-consul.svg?branch=master" style="max-width:100%;"></a> <a href="https://maven-badges.herokuapp.com/maven-central/nl.stormlantern/reactive-consul" target="_blank"><img src="https://camo.githubusercontent.com/4b396952b9fd30c6bfe49579c975ccb3a4d84624/68747470733a2f2f696d672e736869656c64732e696f2f6d6176656e2d63656e7472616c2f762f6e6c2e73746f726d6c616e7465726e2f72656163746976652d636f6e73756c5f322e31312e737667" alt="Maven Central" data-canonical-src="https://img.shields.io/maven-central/v/nl.stormlantern/reactive-consul_2.11.svg" style="max-width:100%;"></a></p> 
  <h1><a id="user-content-reactive-consul" class="anchor" href="https://github.com/dlouwers/reactive-consul#reactive-consul" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Reactive Consul</h1> 
  <p>This project is a Consul client for Scala. It uses non-blocking I/O to communicate with a Consul cluster. You can use the ServiceBroker to get out of the box support for automatic-clustering, loadbalancing and failover or you can use the low-level ConsulHttpClient.</p> 
  <h2><a id="user-content-releases" class="anchor" href="https://github.com/dlouwers/reactive-consul#releases" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Releases</h2> 
  <h3><a id="user-content-020" class="anchor" href="https://github.com/dlouwers/reactive-consul#020" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>0.2.0</h3> 
  <ul> 
   <li>Supports Scala 2.12</li> 
   <li>Uses akka-http instead of Spray, reducing the amount of dependencies (thanks <a href="https://github.com/dbuschman7" target="_blank">David Buschman</a>)</li> 
   <li>Uses native JDK 8 base64, reducing the amount of dependencies (thanks <a href="https://github.com/dbuschman7" target="_blank">David Buschman</a>)</li> 
   <li>Bootstrapping the library with SRV record is now an extra dependency (thanks <a href="https://github.com/dbuschman7" target="_blank">David Buschman</a>)</li> 
  </ul> 
  <h2><a id="user-content-requirements" class="anchor" href="https://github.com/dlouwers/reactive-consul#requirements" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Requirements</h2> 
  <ul> 
   <li>Java 8</li> 
   <li>Scala 2.11 or 2.12</li> 
  </ul> 
  <h2><a id="user-content-adding-it-to-your-project" class="anchor" href="https://github.com/dlouwers/reactive-consul#adding-it-to-your-project" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Adding it to your project</h2> 
  <p>Reactive Consul is available via <a href="https://search.maven.org/" target="_blank">Maven Central</a>, simply add it to your SBT build:</p> 
  <div class="highlight highlight-source-scala">
   <pre>libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>nl.stormlantern<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>reactive-consul<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>0.2.0<span class="pl-pds">"</span></span></pre>
  </div> 
  <p>If you want to use a development snapshots, use the <a href="https://oss.sonatype.org/content/repositories/snapshots/nl/stormlantern/" target="_blank">Sonatype Snapshot Repository</a>. Add the following lines to your SBT build:</p> 
  <div class="highlight highlight-source-scala">
   <pre>resolvers <span class="pl-k">++</span><span class="pl-k">=</span> <span class="pl-en">Seq</span>(
  <span class="pl-s"><span class="pl-pds">"</span>Sonatype Snapshots<span class="pl-pds">"</span></span> at <span class="pl-s"><span class="pl-pds">"</span>https://oss.sonatype.org/content/repositories/snapshots/<span class="pl-pds">"</span></span>
)

libraryDependencies <span class="pl-k">+</span><span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>nl.stormlantern<span class="pl-pds">"</span></span> <span class="pl-k">%%</span> <span class="pl-s"><span class="pl-pds">"</span>reactive-consul<span class="pl-pds">"</span></span> <span class="pl-k">%</span> <span class="pl-s"><span class="pl-pds">"</span>0.1.1-SNAPSHOT<span class="pl-pds">"</span></span></pre>
  </div> 
  <h2><a id="user-content-using-the-servicebroker" class="anchor" href="https://github.com/dlouwers/reactive-consul#using-the-servicebroker" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Using the ServiceBroker</h2> 
  <p>The ServiceBroker can be used as follows:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.</span><span class="pl-v">ServiceBroker</span>

<span class="pl-k">val</span> <span class="pl-en">serviceBroker</span> <span class="pl-k">=</span> <span class="pl-en">ServiceBroker</span>(<span class="pl-s"><span class="pl-pds">"</span>localhost<span class="pl-pds">"</span></span>, connectionStrategies)

<span class="pl-k">val</span> <span class="pl-en">result</span> <span class="pl-k">=</span> serviceBroker.withService(<span class="pl-s"><span class="pl-pds">"</span>&lt;service_name&gt;<span class="pl-pds">"</span></span>) { myServiceConnection <span class="pl-k">=&gt;</span>
  myServiceConnection.getData()
}</pre>
  </div> 
  <p><em>connectionStrategies</em> are discussed in the next section.</p> 
  <h2><a id="user-content-creating-a-connectionstrategy" class="anchor" href="https://github.com/dlouwers/reactive-consul#creating-a-connectionstrategy" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Creating a ConnectionStrategy</h2> 
  <p>A connection strategy can optionally encapsulate connectionpooling and provides loadbalancing but it can be really straightforward, especially if underlying services do most of the work for you.</p> 
  <h3><a id="user-content-example-for-mongodb-using-casbah" class="anchor" href="https://github.com/dlouwers/reactive-consul#example-for-mongodb-using-casbah" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Example for MongoDB using Casbah</h3> 
  <p>The following example will create a connection strategy for connecting to MongoDB. MongoDB manages replication and sharding for you and will automatically route your query to the right instance, but you will have to connect to a node first. Consul can help you keep track of these.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.discovery.</span><span class="pl-v">ConnectionProvider</span>
<span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.discovery.</span><span class="pl-v">ConnectionStrategy</span>
<span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.</span><span class="pl-v">ServiceBroker</span>

<span class="pl-k">import</span> <span class="pl-v">com.mongodb.casbah.Imports.</span><span class="pl-v">_</span>

<span class="pl-k">val</span> <span class="pl-en">mongoConnectionProvider</span> <span class="pl-k">=</span> (<span class="pl-v">host</span>: <span class="pl-k">String</span>, <span class="pl-v">port</span>: <span class="pl-k">Int</span>) <span class="pl-k">=&gt;</span> <span class="pl-k">new</span> <span class="pl-en">ConnectionProvider</span> {
  <span class="pl-k">val</span> <span class="pl-en">client</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">MongoClient</span>(host, port)
  <span class="pl-k">override</span> <span class="pl-k">def</span> <span class="pl-en">getConnection</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-en">Any</span>] <span class="pl-k">=</span> <span class="pl-en">Future</span>.successful(client)
}
<span class="pl-k">val</span> <span class="pl-en">mongoConnectionStrategy</span> <span class="pl-k">=</span> <span class="pl-en">ConnectionStrategy</span>(<span class="pl-s"><span class="pl-pds">"</span>mongodb<span class="pl-pds">"</span></span>, mongoConnectionProvider)
<span class="pl-k">val</span> <span class="pl-en">serviceBroker</span> <span class="pl-k">=</span> <span class="pl-en">ServiceBroker</span>(<span class="pl-s"><span class="pl-pds">"</span>consul-http<span class="pl-pds">"</span></span>, <span class="pl-en">Set</span>(mongoConnectionStrategy))</pre>
  </div> 
  <p>This example assumes that you have Consul available through DNS and that you have registered Consul's HTTP interface under the service name "consul-http" and your MongoDB instances as "mongodb".</p> 
  <p>Instead of passing the full serviceBroker to your MongoDB DAO implementation you could declare your DAO implementations as a trait and then have them implement to following trait:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">trait</span> <span class="pl-en">MongoDbService</span> {  
  <span class="pl-k">def</span> <span class="pl-en">withService</span>[<span class="pl-en">T</span>]<span class="pl-k">:</span> (<span class="pl-en">MongoClient</span> <span class="pl-k">=&gt;</span> <span class="pl-en">Future</span>[<span class="pl-en">T</span>]) <span class="pl-k">=&gt;</span> <span class="pl-en">Future</span>[<span class="pl-en">T</span>] 
}</pre>
  </div> 
  <p>Then your MongoDB DAO implementations can be instantated as such:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">val</span> <span class="pl-en">myMongoDAO</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">MyMongoDAO</span> {
  <span class="pl-k">def</span> <span class="pl-en">withService</span>[<span class="pl-en">T</span>] <span class="pl-k">=</span> serviceBroker.withService[<span class="pl-en">MongoClient</span>, <span class="pl-en">T</span>](<span class="pl-s"><span class="pl-pds">"</span>mongodb<span class="pl-pds">"</span></span>)     
}</pre>
  </div> 
  <p>Or, more traditionally:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">class</span> <span class="pl-en">MongoDbServiceProvider</span>(<span class="pl-v">serviceBroker</span>: <span class="pl-en">ServiceBroker</span>) {
    <span class="pl-k">def</span> <span class="pl-en">withService</span>[<span class="pl-en">T</span>] <span class="pl-k">=</span> serviceBroker.withService[<span class="pl-en">MongoClient</span>, <span class="pl-en">T</span>](<span class="pl-s"><span class="pl-pds">"</span>mongodb<span class="pl-pds">"</span></span>)
}</pre>
  </div> 
  <p>and pass an instance of it to your MongoDB DAO implementation.</p> 
  <h3><a id="user-content-example-for-postgres-using-c3p0-connection-pooling" class="anchor" href="https://github.com/dlouwers/reactive-consul#example-for-postgres-using-c3p0-connection-pooling" aria-hidden="true" target="_blank">
    <svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewbox="0 0 16 16" width="16">
     <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
    </svg></a>Example for Postgres using c3p0 connection pooling</h3> 
  <p>The following example will create a connection strategy for connecting to Postgres. This example assumes a setup with one master and two replication servers. Consul can help you keep track of these.</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.discovery.</span><span class="pl-v">ConnectionProvider</span>
<span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.discovery.</span><span class="pl-v">ConnectionStrategy</span>
<span class="pl-k">import</span> <span class="pl-v">stormlantern.consul.client.</span><span class="pl-v">ServiceBroker</span>

<span class="pl-k">import</span> <span class="pl-v">scala.concurrent.</span><span class="pl-v">Future</span>
<span class="pl-k">import</span> <span class="pl-v">java.sql.</span><span class="pl-v">Connection</span>
<span class="pl-k">import</span> <span class="pl-v">com.mchange.v2.c3p0.</span><span class="pl-v">_</span>


<span class="pl-k">val</span> <span class="pl-en">c3p0ConnectionProvider</span> <span class="pl-k">=</span> (<span class="pl-v">host</span>: <span class="pl-k">String</span>, <span class="pl-v">port</span>: <span class="pl-k">Int</span>) <span class="pl-k">=&gt;</span> <span class="pl-k">new</span> <span class="pl-en">ConnectionProvider</span> {
  <span class="pl-k">val</span> <span class="pl-en">pool</span> <span class="pl-k">=</span> {
    <span class="pl-k">val</span> <span class="pl-en">cpds</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">ComboPooledDataSource</span>()
    cpds.setDriverClass(<span class="pl-s"><span class="pl-pds">"</span>org.postgresql.Driver<span class="pl-pds">"</span></span>)            
    cpds.setJdbcUrl(s<span class="pl-s"><span class="pl-pds">"</span>jdbc:postgresql://$host:$port/mydb<span class="pl-pds">"</span></span>)
    cpds.setUser(<span class="pl-s"><span class="pl-pds">"</span>dbuser<span class="pl-pds">"</span></span>)                                  
    cpds.setPassword(<span class="pl-s"><span class="pl-pds">"</span>dbpassword<span class="pl-pds">"</span></span>)
    cpds
  }
  <span class="pl-k">override</span> <span class="pl-k">def</span> <span class="pl-en">getConnection</span><span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-en">Any</span>] <span class="pl-k">=</span> <span class="pl-en">Future</span>.successful(pool.getConnection())
  <span class="pl-k">override</span> <span class="pl-k">def</span> <span class="pl-en">returnConnection</span>(<span class="pl-v">connectionHolder</span>: <span class="pl-en">ConnectionHolder</span>)<span class="pl-k">:</span> <span class="pl-k">Unit</span> <span class="pl-k">=</span> 
    connectionHolder.connection.foreach(_.<span class="pl-c1">asInstanceOf</span>[<span class="pl-en">Connection</span>].close())
  <span class="pl-k">override</span> <span class="pl-k">def</span> <span class="pl-en">destroy</span>()<span class="pl-k">:</span> <span class="pl-k">Unit</span> <span class="pl-k">=</span> pool.close()
}

<span class="pl-k">val</span> <span class="pl-en">postgresReadConnectionStrategy</span> <span class="pl-k">=</span> <span class="pl-en">ConnectionStrategy</span>(
  <span class="pl-en">ServiceDefinition</span>(<span class="pl-s"><span class="pl-pds">"</span>postgres-read<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>postgres<span class="pl-pds">"</span></span>)), 
  c3p0ConnectionProvider,
  <span class="pl-k">new</span> <span class="pl-en">RoundRobinLoadBalancer</span>
)
<span class="pl-k">val</span> <span class="pl-en">postgresWriteConnectionStrategy</span> <span class="pl-k">=</span> <span class="pl-en">ConnectionStrategy</span>(
  <span class="pl-en">ServiceDefinition</span>(<span class="pl-s"><span class="pl-pds">"</span>postgres-write<span class="pl-pds">"</span></span>, <span class="pl-s"><span class="pl-pds">"</span>postgres<span class="pl-pds">"</span></span>, <span class="pl-en">Set</span>(<span class="pl-s"><span class="pl-pds">"</span>master<span class="pl-pds">"</span></span>), 
  c3p0ConnectionProvider
  <span class="pl-k">new</span> <span class="pl-en">RoundRobinLoadBalancer</span>  
)
<span class="pl-k">val</span> <span class="pl-en">serviceBroker</span> <span class="pl-k">=</span> <span class="pl-en">ServiceBroker</span>(<span class="pl-s"><span class="pl-pds">"</span>consul-http<span class="pl-pds">"</span></span>, <span class="pl-en">Set</span>(postgresReadConnectionStrategy, postgresWriteConnectionStrategy))</pre>
  </div> 
  <p>This example assumes that you have Consul available through DNS and that you have registered Consul's HTTP interface under the service name "consul-http", your Postgres instances as "postgres" and your Postgres master is tagged as "master". Consul's tag support is used to identify the postgres master, all writes are sent to it. Reads can go to any postgres instance.</p> 
  <p>Now you can connect to your database using:</p> 
  <div class="highlight highlight-source-scala">
   <pre><span class="pl-k">class</span> <span class="pl-en">PostgresServiceProvider</span>(<span class="pl-v">serviceBroker</span>: <span class="pl-en">ServiceBroker</span>) {
    <span class="pl-k">def</span> <span class="pl-en">withReadingConnection</span>[<span class="pl-en">T</span>] <span class="pl-k">=</span> serviceBroker.withService[<span class="pl-en">Connection</span>, <span class="pl-en">T</span>](<span class="pl-s"><span class="pl-pds">"</span>postgres<span class="pl-pds">"</span></span>)
    <span class="pl-k">def</span> <span class="pl-en">withWritingConnection</span>[<span class="pl-en">T</span>] <span class="pl-k">=</span> serviceBroker.withService[<span class="pl-en">Connection</span>, <span class="pl-en">T</span>](<span class="pl-s"><span class="pl-pds">"</span>postgres-master<span class="pl-pds">"</span></span>)
}

<span class="pl-k">class</span> <span class="pl-en">MyDao</span>(<span class="pl-v">connectionProvider</span>: <span class="pl-en">PostgresServiceProvider</span>) {
  <span class="pl-k">def</span> <span class="pl-en">findStuff</span>(<span class="pl-v">name</span>: <span class="pl-k">String</span>)<span class="pl-k">:</span> <span class="pl-en">Future</span>[<span class="pl-en">Option</span>[<span class="pl-en">Stuff</span>]]] <span class="pl-k">=</span> {
    connectionProvider.withReadingConnection { c  <span class="pl-k">=&gt;</span>
      <span class="pl-en">Future</span>.successful {
        c.doSqlStuff()
      }
    }
  }
}

<span class="pl-k">val</span> <span class="pl-en">myDao</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">MyDao</span>(<span class="pl-k">new</span> <span class="pl-en">PostgresService</span>(serviceBroker))</pre>
  </div> 
 </article>
</div>